<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=yes"
    />
    <meta name="robots" content="noindex,nofollow,noarchive" />
    <meta name="referrer" content="no-referrer" />

    <script>
      MathJax = {
        chtml: {
          displayAlign: "left",
          displayIndent: "1em",
        },
      };
    </script>

    

    <link rel="icon" href="favicon.ico" sizes="any" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css"
      integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZjVsC0lE40xsADsfeQoEypE+enwcOiGjk/bSuGGKHEyjSoQ1zVisanQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=M+PLUS+Rounded+1c"
    />
    <link rel="stylesheet" href="style.css" />

    <title>第07回 3I-プログラミング3</title>
  </head>

  <body>
    <div class="openbtn"><span></span><span></span><span></span></div>
    <nav id="g-nav">
      <div id="g-nav-list">
        <!-- ---------------------------------------- -->
         <ul>
<li><a href="#連絡" id="toc-連絡"><span
class="toc-section-number">1</span> 連絡</a>
<ul>
<li><a href="#小テスト実施" id="toc-小テスト実施"><span
class="toc-section-number">1.1</span> 小テスト実施</a></li>
<li><a href="#課題1について" id="toc-課題1について"><span
class="toc-section-number">1.2</span> 課題1について</a></li>
<li><a href="#今後の授業の流れ" id="toc-今後の授業の流れ"><span
class="toc-section-number">1.3</span> 今後の授業の流れ</a></li>
<li><a href="#年度の2i学生のポートフォリオ"
id="toc-年度の2i学生のポートフォリオ"><span
class="toc-section-number">1.4</span>
2024年度の2I学生のポートフォリオ</a></li>
</ul></li>
<li><a href="#投稿記事の詳細を表示するコンテンツの作成"
id="toc-投稿記事の詳細を表示するコンテンツの作成"><span
class="toc-section-number">2</span>
投稿記事の「詳細」を表示するコンテンツの作成</a>
<ul>
<li><a href="#ハイパーリンクの追加" id="toc-ハイパーリンクの追加"><span
class="toc-section-number">2.1</span> ハイパーリンクの追加</a></li>
<li><a href="#記事詳細ページの作成" id="toc-記事詳細ページの作成"><span
class="toc-section-number">2.2</span> 記事詳細ページの作成</a></li>
</ul></li>
<li><a href="#ウェブから記事データを取得"
id="toc-ウェブから記事データを取得"><span
class="toc-section-number">3</span> ウェブから記事データを取得</a>
<ul>
<li><a href="#ウェブapiとは" id="toc-ウェブapiとは"><span
class="toc-section-number">3.1</span> ウェブAPIとは</a></li>
<li><a href="#郵便番号検索apiの組込み"
id="toc-郵便番号検索apiの組込み"><span
class="toc-section-number">3.2</span> 郵便番号検索APIの組込み</a></li>
</ul></li>
<li><a href="#同期処理と非同期処理" id="toc-同期処理と非同期処理"><span
class="toc-section-number">4</span> 同期処理と非同期処理</a>
<ul>
<li><a href="#同期処理の動作確認" id="toc-同期処理の動作確認"><span
class="toc-section-number">4.1</span> 同期処理の動作確認</a></li>
<li><a href="#処理時間を要するタスクを同期処理で扱うときの問題"
id="toc-処理時間を要するタスクを同期処理で扱うときの問題"><span
class="toc-section-number">4.2</span>
処理時間を要するタスクを同期処理で扱うときの問題</a></li>
<li><a href="#同期処理で問題が起こる原因"
id="toc-同期処理で問題が起こる原因"><span
class="toc-section-number">4.3</span>
同期処理で問題が起こる原因</a></li>
<li><a href="#非同期処理" id="toc-非同期処理"><span
class="toc-section-number">4.4</span> 非同期処理</a></li>
<li><a href="#awaitを用いた非同期処理の完了待機"
id="toc-awaitを用いた非同期処理の完了待機"><span
class="toc-section-number">4.5</span>
awaitを用いた非同期処理の完了待機</a></li>
<li><a href="#改めて郵便番号検索apiの利用処理を確認"
id="toc-改めて郵便番号検索apiの利用処理を確認"><span
class="toc-section-number">4.6</span>
改めて郵便番号検索APIの利用処理を確認</a></li>
</ul></li>
<li><a href="#ブログ記事のデータをウェブから取得"
id="toc-ブログ記事のデータをウェブから取得"><span
class="toc-section-number">5</span>
ブログ記事のデータをウェブから取得</a></li>
<li><a href="#microcmsを利用したバックエンドの構築"
id="toc-microcmsを利用したバックエンドの構築"><span
class="toc-section-number">6</span>
microCMSを利用したバックエンドの構築</a>
<ul>
<li><a href="#microcmsの利用準備" id="toc-microcmsの利用準備"><span
class="toc-section-number">6.1</span> microCMSの利用準備</a></li>
<li><a href="#microcmsにコンテンツを追加"
id="toc-microcmsにコンテンツを追加"><span
class="toc-section-number">6.2</span>
microCMSにコンテンツを追加</a></li>
<li><a href="#apiの利用テスト" id="toc-apiの利用テスト"><span
class="toc-section-number">6.3</span> APIの利用テスト</a></li>
<li><a href="#カテゴリの追加" id="toc-カテゴリの追加"><span
class="toc-section-number">6.4</span> カテゴリの追加</a></li>
</ul></li>
<li><a href="#ブログアプリとmicrocmsの連携"
id="toc-ブログアプリとmicrocmsの連携"><span
class="toc-section-number">7</span> ブログアプリとmicroCMSの連携</a>
<ul>
<li><a href="#準備-環境変数の設定" id="toc-準備-環境変数の設定"><span
class="toc-section-number">7.1</span> 準備: 環境変数の設定</a></li>
<li><a href="#ブログ記事一覧の表示" id="toc-ブログ記事一覧の表示"><span
class="toc-section-number">7.2</span> ブログ記事一覧の表示</a></li>
</ul></li>
<li><a href="#宿題" id="toc-宿題"><span
class="toc-section-number">8</span> 宿題</a></li>
</ul> 
        <!-- ---------------------------------------- -->
      </div>
    </nav>

    <header class="markdown-body">
      <p>2024-3I プログラミング3 第07回 講義資料</p>
      <p>2024年11月21日（木）1・2時限</p>
    </header>

    <main class="markdown-body">
      <!-- ---------------------------------------- -->
      <h1 data-number="1" id="連絡"><span
      class="header-section-number">1</span> 連絡</h1>
      <h2 data-number="1.1" id="小テスト実施"><span
      class="header-section-number">1.1</span> 小テスト実施</h2>
      <p>「<strong>小テスト➍</strong>」を実施します。</p>
      <h2 data-number="1.2" id="課題1について"><span
      class="header-section-number">1.2</span> 課題1について</h2>
      <p><a href="lecture05.html#課題1">課題1</a><font size=-1>～
      ぼくのかんがえたさいきょうのTodoアプリ ～</font>
      の提出期限は「<strong>11月27日 (水)
      23時</strong>」です。GoogleClassroom の
      <strong>「提出ボタン」の押下忘れ</strong>
      などが無いように注意してください
      (提出遅れや各種不備は減点となります)。なお、<span
      class="masked">README.mdの内容も評価対象</span>
      に含まれるので注意ください。</p>
      <ul>
      <li>課題1は、ポートフォリオ (自己紹介と作品集)
      として作成したページからも
      <strong>リンクを貼っておくように</strong> してください。</li>
      <li>その他、ポートフォリには
      <strong>今年度の文化祭展示の概要</strong>
      (スクリーンショットや当日の風景写真があると説得力が高くなります)
      や、他科目で作成したソフトや修得したスキルなども
      (記憶が鮮明なうちに) こまめに記録するようにしてください。<br />
      </li>
      <li>特に、文化祭展示などは <span
      class="masked">チームによるプロジェクト開発の経験があること</span>
      のアピールになるので記載を推奨します。</li>
      </ul>
      <p>Todoアプリの実装の工夫としては「作成済みTodoの編集機能」「設定項目の追加」「カテゴリやタグなどの機能」「期日のカウントダウン機能」「カレンダUIの導入」「UI/UXの最適化」「レスポンシブ対応」など様々なものが考えられます。<strong>個性</strong>と<strong>ユーモア</strong>が輝くプロダクトを期待しています。</p>
      <ul>
      <li>参考: <a
      href="https://takeshiwada1980.github.io/react-todo-app-demo/">Todoアプリのサンプル</a>
      …ギリギリ合格水準のレベルの6点😨</li>
      <li>参考: <a
      href="https://takeshiwada1980.github.io/react-todo-app-demo/2">Todoアプリのサンプル</a>
      …ここまでつくれたら素晴らしい！9点🎉</li>
      </ul>
      <h2 data-number="1.3" id="今後の授業の流れ"><span
      class="header-section-number">1.3</span> 今後の授業の流れ</h2>
      <p>今後の授業の大まかな流れは、次のようになっています。</p>
      <ol type="1">
      <li>Next.js 開発環境の構築 <strong><em>済</em></strong></li>
      <li>ブログアプリの「<strong>フロントエンド開発</strong>」のチュートリアル
      <strong>← 今回の授業</strong>
      <ul>
      <li>ヘッドレスCMS (<a href="https://microcms.io/">microCMS</a>)
      との連携</li>
      </ul></li>
      <li>ブログアプリの「<strong>バックエンド開発</strong>」のチュートリアル
      <strong>← 次回 (中間試験明け) の授業</strong>
      <ul>
      <li><a href="https://supabase.com/">supabase</a> と <a
      href="https://vercel.com/">vercel</a> の利用</li>
      </ul></li>
      <li>ブログアプリのカスタマイズとつくり込み →
      <strong><em>課題2</em></strong></li>
      <li>オリジナルのウェブアプリ → <strong><em>課題3</em></strong>
      (最終課題)</li>
      </ol>
      <p>※ <strong>CMS</strong>: <span class="masked">Content Management
      System</span>、コンテンツ管理システム。</p>
      <h2 data-number="1.4" id="年度の2i学生のポートフォリオ"><span
      class="header-section-number">1.4</span>
      2024年度の2I学生のポートフォリオ</h2>
      <p>後輩のポートフォリオです。参考にしてください
      (各自ブラッシュアップしてください)。</p>
      <ul>
      <li><a
      href="https://omunet-my.sharepoint.com/:t:/g/personal/z21707r_omu_ac_jp/EbSqTeAR70dFnX6bWY9f81IB-Qpmz-Ll3hTv7ayIl3Cs0Q">2024年度2Iの学生のポートフォリオ</a><font size="-1">学内のみアクセス可</font></li>
      </ul>
      <h1 data-number="2"
      id="投稿記事の詳細を表示するコンテンツの作成"><span
      class="header-section-number">2</span>
      投稿記事の「詳細」を表示するコンテンツの作成</h1>
      <p>トップページに表示される「記事一覧」のなかの各記事をクリックすると、<strong>記事詳細ページに遷移する機能</strong>
      や <strong>外部サイトに配置した画像を表示する機能</strong>
      を実装していきます。</p>
      <figure>
      <img src="figs/07/app_03.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>ここでは <code>/posts/[id]</code>
      というパスにアクセスすると「記事の詳細 (全文)」と「カバーイメージ
      (画像)」が表示されるように実装していきます。</p>
      <p>ところで Next.js では、URLパスのなかの <code>[id]</code>
      のような表記は <span
      class="masked">パラメータプレースホルダ</span> とよばれ、そこには
      <strong>動的に値が入ること</strong>
      を意味します。具体的には、次のように<a
      href="https://github.com/TakeshiWada1980/Programming3-2024/blob/main/docs/codes/06/dummyPosts.ts">投稿記事のID</a>を表す文字列が
      <code>[id]</code> の部分に埋め込まれるようなURLパターンを
      <code>/posts/[id]</code> のように表記します。</p>
      <ul>
      <li>投稿1
      <code>/posts/36b7c693-4cce-4d73-afa3-acb54a404290</code></li>
      <li>投稿2
      <code>/posts/24f932b8-231b-429b-b9dc-569f07ba16a7</code></li>
      <li>投稿3
      <code>/posts/1d4cbd35-6ec2-4f34-b3e7-4a9b35a60d1a</code></li>
      </ul>
      <h2 data-number="2.1" id="ハイパーリンクの追加"><span
      class="header-section-number">2.1</span> ハイパーリンクの追加</h2>
      <p>詳細記事へのリンクを実装するために、まずは
      <code>PostSummary.tsx</code> (前回講義で作成済み) の JSX のなかに
      <code>&lt;Link href={`/posts/${post.id}`}&gt;...&lt;Link&gt;</code>
      という <strong>ハイパーリンク設定</strong>
      を追加してください。Linkコンポーネントは「文字列」だけではなく、次のように
      <span class="masked">div要素</span>
      を<strong>子要素</strong>にすることもできます
      (そのdiv要素内の領域であれば、どこをクリックしてもリンクするように設定できます)。</p>
      <div class="sourceCode" id="cb1"
      data-caption="src/app/_components/PostSummary.tsx (抜粋・実装例)"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb1-1"><a href="#cb1-1"></a>{<span class="co">/* ファイルの先頭で「Linkコンポーネント」のインポートが必要です */</span>}</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="op">&lt;</span>Link href<span class="op">=</span>{<span class="vs">`/posts/</span><span class="sc">${</span>post<span class="op">.</span><span class="at">id</span><span class="sc">}</span><span class="vs">`</span>}<span class="op">&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>  <span class="op">&lt;</span>div className<span class="op">=</span><span class="st">&quot;mb-1 text-lg font-bold&quot;</span><span class="op">&gt;</span>{post<span class="op">.</span><span class="at">title</span>}<span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb1-4"><a href="#cb1-4"></a>  <span class="op">&lt;</span>div</span>
<span id="cb1-5"><a href="#cb1-5"></a>    className<span class="op">=</span><span class="st">&quot;line-clamp-3&quot;</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>    dangerouslySetInnerHTML<span class="op">=</span>{{ __html<span class="op">:</span> safeHTML }}</span>
<span id="cb1-7"><a href="#cb1-7"></a>  <span class="op">/&gt;</span></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="op">&lt;/</span>Link<span class="op">&gt;</span></span></code></pre></div>
      <p>上記 <strong>第02行目</strong> の
      <code>href={`/posts/${post.id}`}</code> により
      <code>post.id</code>
      <strong>に応じて動的にハイパーリンク先を設定</strong>
      していることを確認してください。なお、<strong>Linkコンポーネントのインポート</strong>
      については、既に実装済みの <code>Header.tsx</code>
      を参照してください。</p>
      <p>上記の変更ができたら、現時点でハイパーリンクが機能すること
      (=<strong>記事概要をクリックするとブラウザのアドレバーの「URLパス」が変化すること</strong>)
      を確認してください。また、リンク先のコンテンツが存在しないときに、どのようになるのかも実際に確認してください。</p>
      <p>開発では、<span class="masked">(いまさらですが)
      こまめに部分的な動作確認を繰り返すこと</span>
      が重要です。また、デベロッパーツールのコンソールタブから、<strong>エラーや警告が発生していないことを定期的に確認すること</strong>
      も大切です。</p>
      <h2 data-number="2.2" id="記事詳細ページの作成"><span
      class="header-section-number">2.2</span> 記事詳細ページの作成</h2>
      <p>リンク先のコンテンツ (=
      <strong>記事詳細ページのコンテンツ</strong>)
      を作成していきます。</p>
      <p>まずは、次のような構成になるようにプロジェクトにフォルダを追加してください。つまり、<code>/src/app</code>
      のなかに <code>posts</code> フォルダを作成して、さらに、そのなかに
      <code>[id]</code>
      フォルダを作成してください。前回講義でも解説したように Next.js
      では <span
      class="masked">フォルダ構成が、そのまま「URLパス」に対応する仕組み</span>
      となるため、フォルダの「<strong>名前設定</strong>」や「<strong>階層構造</strong>」には十分に注意を払ってください。</p>
      <figure>
      <img src="figs/07/vscode_01.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>次に <code>[id]</code> フォルダのなかに <code>page.tsx</code>
      というファイルを作成して、URLパスの <code>[id]</code>
      に対応した記事詳細を表示 (例えば、<code>[id]</code> が
      <code>36b7c693-4cce-4d73-afa3-acb54a404290</code>
      であれば「<strong>投稿1</strong>」を表示)
      するためのコードを記述してください。</p>
      <div class="sourceCode" id="cb2"
      data-caption="src/app/posts/[id]/page.tsx"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb2-1"><a href="#cb2-1"></a><span class="st">&quot;use client&quot;</span><span class="op">;</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="im">import</span> { useState<span class="op">,</span> useEffect } <span class="im">from</span> <span class="st">&quot;react&quot;</span><span class="op">;</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="im">import</span> { useParams } <span class="im">from</span> <span class="st">&quot;next/navigation&quot;</span><span class="op">;</span> <span class="co">// ◀ 注目</span></span>
<span id="cb2-4"><a href="#cb2-4"></a></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="im">import</span> <span class="im">type</span> { Post } <span class="im">from</span> <span class="st">&quot;@/app/_types/Post&quot;</span><span class="op">;</span></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="im">import</span> dummyPosts <span class="im">from</span> <span class="st">&quot;@/app/_mocks/dummyPosts&quot;</span><span class="op">;</span></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="im">import</span> { FontAwesomeIcon } <span class="im">from</span> <span class="st">&quot;@fortawesome/react-fontawesome&quot;</span><span class="op">;</span></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="im">import</span> { faSpinner } <span class="im">from</span> <span class="st">&quot;@fortawesome/free-solid-svg-icons&quot;</span><span class="op">;</span></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="im">import</span> Image <span class="im">from</span> <span class="st">&quot;next/image&quot;</span><span class="op">;</span></span>
<span id="cb2-10"><a href="#cb2-10"></a></span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="im">import</span> DOMPurify <span class="im">from</span> <span class="st">&quot;isomorphic-dompurify&quot;</span><span class="op">;</span></span>
<span id="cb2-12"><a href="#cb2-12"></a></span>
<span id="cb2-13"><a href="#cb2-13"></a><span class="co">// 投稿記事の詳細表示 /posts/[id]</span></span>
<span id="cb2-14"><a href="#cb2-14"></a><span class="kw">const</span> Page<span class="op">:</span> React<span class="op">.</span><span class="at">FC</span> <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb2-15"><a href="#cb2-15"></a>  <span class="kw">const</span> [post<span class="op">,</span> setPost] <span class="op">=</span> <span class="fu">useState</span><span class="op">&lt;</span>Post <span class="op">|</span> <span class="dt">null</span><span class="op">&gt;</span>(<span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb2-16"><a href="#cb2-16"></a>  <span class="kw">const</span> [isLoading<span class="op">,</span> setIsLoading] <span class="op">=</span> <span class="fu">useState</span>(<span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb2-17"><a href="#cb2-17"></a></span>
<span id="cb2-18"><a href="#cb2-18"></a>  <span class="co">// 動的ルートパラメータから 記事id を取得 （URL:/posts/[id]）</span></span>
<span id="cb2-19"><a href="#cb2-19"></a>  <span class="kw">const</span> { id } <span class="op">=</span> <span class="fu">useParams</span>() <span class="im">as</span> { id<span class="op">:</span> <span class="dt">string</span> }<span class="op">;</span></span>
<span id="cb2-20"><a href="#cb2-20"></a></span>
<span id="cb2-21"><a href="#cb2-21"></a>  <span class="co">// コンポーネントが読み込まれたときに「1回だけ」実行する処理</span></span>
<span id="cb2-22"><a href="#cb2-22"></a>  <span class="fu">useEffect</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb2-23"><a href="#cb2-23"></a>    <span class="co">// 本来はウェブAPIを叩いてデータを取得するが、まずはモックデータを使用</span></span>
<span id="cb2-24"><a href="#cb2-24"></a>    <span class="co">// (ネットからのデータ取得をシミュレートして１秒後にデータをセットする)</span></span>
<span id="cb2-25"><a href="#cb2-25"></a>    <span class="fu">setIsLoading</span>(<span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb2-26"><a href="#cb2-26"></a>    <span class="kw">const</span> timer <span class="op">=</span> <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb2-27"><a href="#cb2-27"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;ウェブAPIからデータを取得しました (虚言)&quot;</span>)<span class="op">;</span></span>
<span id="cb2-28"><a href="#cb2-28"></a>      <span class="co">// dummyPosts から id に一致する投稿を取得してセット</span></span>
<span id="cb2-29"><a href="#cb2-29"></a>      <span class="fu">setPost</span>(dummyPosts<span class="op">.</span><span class="fu">find</span>((post) <span class="kw">=&gt;</span> post<span class="op">.</span><span class="at">id</span> <span class="op">===</span> id) <span class="op">||</span> <span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb2-30"><a href="#cb2-30"></a>      <span class="fu">setIsLoading</span>(<span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb2-31"><a href="#cb2-31"></a>    }<span class="op">,</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb2-32"><a href="#cb2-32"></a></span>
<span id="cb2-33"><a href="#cb2-33"></a>    <span class="co">// データ取得の途中でページ遷移したときにタイマーを解除する処理</span></span>
<span id="cb2-34"><a href="#cb2-34"></a>    <span class="cf">return</span> () <span class="kw">=&gt;</span> <span class="pp">clearTimeout</span>(timer)<span class="op">;</span></span>
<span id="cb2-35"><a href="#cb2-35"></a>  }<span class="op">,</span> [id])<span class="op">;</span></span>
<span id="cb2-36"><a href="#cb2-36"></a></span>
<span id="cb2-37"><a href="#cb2-37"></a>  <span class="co">// 投稿データの取得中は「Loading...」を表示</span></span>
<span id="cb2-38"><a href="#cb2-38"></a>  <span class="cf">if</span> (isLoading) {</span>
<span id="cb2-39"><a href="#cb2-39"></a>    <span class="cf">return</span> (</span>
<span id="cb2-40"><a href="#cb2-40"></a>      <span class="op">&lt;</span>div className<span class="op">=</span><span class="st">&quot;text-gray-500&quot;</span><span class="op">&gt;</span></span>
<span id="cb2-41"><a href="#cb2-41"></a>        <span class="op">&lt;</span>FontAwesomeIcon icon<span class="op">=</span>{faSpinner} className<span class="op">=</span><span class="st">&quot;mr-1 animate-spin&quot;</span> <span class="op">/&gt;</span></span>
<span id="cb2-42"><a href="#cb2-42"></a>        Loading<span class="op">...</span></span>
<span id="cb2-43"><a href="#cb2-43"></a>      <span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb2-44"><a href="#cb2-44"></a>    )<span class="op">;</span></span>
<span id="cb2-45"><a href="#cb2-45"></a>  }</span>
<span id="cb2-46"><a href="#cb2-46"></a></span>
<span id="cb2-47"><a href="#cb2-47"></a>  <span class="co">// 投稿データが取得できなかったらエラーメッセージを表示</span></span>
<span id="cb2-48"><a href="#cb2-48"></a>  <span class="cf">if</span> (<span class="op">!</span>post) {</span>
<span id="cb2-49"><a href="#cb2-49"></a>    <span class="cf">return</span> <span class="op">&lt;</span>div<span class="op">&gt;</span>指定idの投稿の取得に失敗しました。<span class="op">&lt;/</span>div<span class="op">&gt;;</span></span>
<span id="cb2-50"><a href="#cb2-50"></a>  }</span>
<span id="cb2-51"><a href="#cb2-51"></a></span>
<span id="cb2-52"><a href="#cb2-52"></a>  <span class="co">// HTMLコンテンツのサニタイズ</span></span>
<span id="cb2-53"><a href="#cb2-53"></a>  <span class="kw">const</span> safeHTML <span class="op">=</span> DOMPurify<span class="op">.</span><span class="fu">sanitize</span>(post<span class="op">.</span><span class="at">content</span><span class="op">,</span> {</span>
<span id="cb2-54"><a href="#cb2-54"></a>    ALLOWED_TAGS<span class="op">:</span> [<span class="st">&quot;b&quot;</span><span class="op">,</span> <span class="st">&quot;strong&quot;</span><span class="op">,</span> <span class="st">&quot;i&quot;</span><span class="op">,</span> <span class="st">&quot;em&quot;</span><span class="op">,</span> <span class="st">&quot;u&quot;</span><span class="op">,</span> <span class="st">&quot;br&quot;</span>]<span class="op">,</span></span>
<span id="cb2-55"><a href="#cb2-55"></a>  })<span class="op">;</span></span>
<span id="cb2-56"><a href="#cb2-56"></a></span>
<span id="cb2-57"><a href="#cb2-57"></a>  <span class="cf">return</span> (</span>
<span id="cb2-58"><a href="#cb2-58"></a>    <span class="op">&lt;</span>main<span class="op">&gt;</span></span>
<span id="cb2-59"><a href="#cb2-59"></a>      <span class="op">&lt;</span>div className<span class="op">=</span><span class="st">&quot;space-y-2&quot;</span><span class="op">&gt;</span></span>
<span id="cb2-60"><a href="#cb2-60"></a>        <span class="op">&lt;</span>div className<span class="op">=</span><span class="st">&quot;mb-2 text-2xl font-bold&quot;</span><span class="op">&gt;</span>{post<span class="op">.</span><span class="at">title</span>}<span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb2-61"><a href="#cb2-61"></a>        <span class="op">&lt;</span>div<span class="op">&gt;</span></span>
<span id="cb2-62"><a href="#cb2-62"></a>          <span class="op">&lt;</span>Image</span>
<span id="cb2-63"><a href="#cb2-63"></a>            src<span class="op">=</span>{post<span class="op">.</span><span class="at">coverImage</span><span class="op">.</span><span class="at">url</span>}</span>
<span id="cb2-64"><a href="#cb2-64"></a>            alt<span class="op">=</span><span class="st">&quot;Example Image&quot;</span></span>
<span id="cb2-65"><a href="#cb2-65"></a>            width<span class="op">=</span>{post<span class="op">.</span><span class="at">coverImage</span><span class="op">.</span><span class="at">width</span>}</span>
<span id="cb2-66"><a href="#cb2-66"></a>            height<span class="op">=</span>{post<span class="op">.</span><span class="at">coverImage</span><span class="op">.</span><span class="at">height</span>}</span>
<span id="cb2-67"><a href="#cb2-67"></a>            priority</span>
<span id="cb2-68"><a href="#cb2-68"></a>            className<span class="op">=</span><span class="st">&quot;rounded-xl&quot;</span></span>
<span id="cb2-69"><a href="#cb2-69"></a>          <span class="op">/&gt;</span></span>
<span id="cb2-70"><a href="#cb2-70"></a>        <span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb2-71"><a href="#cb2-71"></a>        <span class="op">&lt;</span>div dangerouslySetInnerHTML<span class="op">=</span>{{ __html<span class="op">:</span> safeHTML }} <span class="op">/&gt;</span></span>
<span id="cb2-72"><a href="#cb2-72"></a>      <span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb2-73"><a href="#cb2-73"></a>    <span class="op">&lt;/</span>main<span class="op">&gt;</span></span>
<span id="cb2-74"><a href="#cb2-74"></a>  )<span class="op">;</span></span>
<span id="cb2-75"><a href="#cb2-75"></a>}<span class="op">;</span></span>
<span id="cb2-76"><a href="#cb2-76"></a></span>
<span id="cb2-77"><a href="#cb2-77"></a><span class="im">export</span> <span class="im">default</span> Page<span class="op">;</span></span></code></pre></div>
      <p>ここで注目すべき処理は、</p>
      <ul>
      <li><strong>第19行目</strong> の <strong>URLパス</strong>
      (動的ルートパラメータの <code>[id]</code> の部分) から、具体的な値
      (文字列) を取得する処理</li>
      <li>上記の <code>id</code>
      に一致するブログ記事を、<code>dummyPosts</code> から探して
      <strong>第15行目</strong> で宣言している状態 (state)
      にセットする処理</li>
      </ul>
      <p>…になります。</p>
      <h3 data-number="2.2.1" id="パラメータプレースホルダの処理"><span
      class="header-section-number">2.2.1</span>
      パラメータプレースホルダの処理</h3>
      <p>URLパスから <code>id</code>
      を取得する処理は、<strong>第03行目</strong> でインポートしている
      <code>useParams</code> という Hook を利用して
      <strong>第19行目</strong> で行なっています。</p>
      <p>なお、<code>useParams</code> は <span
      class="masked">2個以上のパラメータプレースホルダを持つケース</span>
      にも対応しています。例えば
      <code>/posts/[categoryId]/[postId]</code>
      となっているときは、次のように <strong>categoryId</strong> と
      <strong>postId</strong> の値を取得することができます。</p>
      <div class="sourceCode" id="cb3"
      data-caption="複数のパラメータプレースホルダから値の取得する例"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb3-1"><a href="#cb3-1"></a><span class="co">// src/app/posts/[categoryId]/[postId]/page.tsx</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="kw">const</span> { categoryId<span class="op">,</span> postId } <span class="op">=</span> <span class="fu">useParams</span>() <span class="im">as</span> { categoryId<span class="op">:</span> <span class="dt">string</span><span class="op">;</span> postId<span class="op">:</span> <span class="dt">string</span> }<span class="op">;</span></span></code></pre></div>
      <p>パラメータプレースホルダに与えられる値が「数値」であっても、まずは「<strong>文字列</strong>」として取得してから
      <span
      class="masked"><code>parseInt()</code>などを使って「数値」に変換する必要</span>
      があります。</p>
      <h3 data-number="2.2.2" id="findメソッドによる検索"><span
      class="header-section-number">2.2.2</span>
      findメソッドによる検索</h3>
      <p><code>id</code> と一致する記事の取得は、配列操作メソッドの
      <code>find</code> を使って <strong>第29行目</strong>
      で行なっています。<code>filter</code>
      は条件を満たす要素の「<strong>配列</strong>」を戻り値としていましたが、<code>find</code>
      は条件を満たす <span class="masked">単一の要素
      (配列の先頭からチェックして一番初めに条件を満たした単一の要素)</span>
      を戻り値とします。なお、条件に一致する要素が存在しなかったときは
      <code>undefined</code> を返します。</p>
      <p>ここでは、idに該当する記事が存在しないことを
      <code>undefined</code> ではなく <code>null</code>
      を使って扱いたいので、次のようにしています。これにより
      <code>dummyPosts.find((post) =&gt; post.id === id)</code> の結果が
      <code>undefined</code> のとき、<code>setPost(null)</code>
      となります。</p>
      <div class="sourceCode" id="cb4"
      data-caption="src/app/posts/[id]/page.tsx (抜粋)"
      data-startFrom="29"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 28;"><span id="cb4-29"><a href="#cb4-29"></a><span class="fu">setPost</span>(dummyPosts<span class="op">.</span><span class="fu">find</span>((post) <span class="kw">=&gt;</span> post<span class="op">.</span><span class="at">id</span> <span class="op">===</span> id) <span class="op">||</span> <span class="kw">null</span>)<span class="op">;</span></span></code></pre></div>
      <p>上記処理を、段階に分けて書けば以下のようなコードとなります。</p>
      <div class="sourceCode" id="cb5" data-caption="等価な処理"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">const</span> foundPost <span class="op">=</span> dummyPosts<span class="op">.</span><span class="fu">find</span>((post) <span class="kw">=&gt;</span> post<span class="op">.</span><span class="at">id</span> <span class="op">===</span> id)<span class="op">;</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="cf">if</span> (foundPost <span class="op">!==</span> <span class="kw">undefined</span>) {</span>
<span id="cb5-3"><a href="#cb5-3"></a>  <span class="fu">setPost</span>(foundPost)<span class="op">;</span></span>
<span id="cb5-4"><a href="#cb5-4"></a>} <span class="cf">else</span> {</span>
<span id="cb5-5"><a href="#cb5-5"></a>  <span class="fu">setPost</span>(<span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb5-6"><a href="#cb5-6"></a>}</span></code></pre></div>
      <div class="note type-tips">
      <p><strong>「null」と「undefined」の使い分けについて</strong></p>
      <p><code>null</code> と <code>undefined</code>
      は、条件式の内部で単体で評価すると同じ結果（falsyな値）になるなど同じような挙動を示すことがありますが、実際には
      <strong>両者には様々な差異</strong>
      があります。そして、慣れないうちは、実際問題として
      <code>null</code> <strong>と</strong> <code>undefined</code>
      <strong>の使い分けが難しい</strong> という場面が多々あります。</p>
      <p>例えば <strong>第15行目</strong> では
      <code>useState&lt;Post | null&gt;(null)</code>
      としていますが、これを
      <code>useState&lt;Post | undefined&gt;(undefined)</code>
      としていない理由を説明しようとすると
      (理解して納得するためには)、Typescript や Next.js、React
      に関しての一定の知識と経験が必要となってきます。また、ここで
      <code>undefined</code>
      を使ったとしても、実質的に動作上の問題もありません。</p>
      <p>ただ、大まかなには、次のように使い分けると良いと思います。</p>
      <ul>
      <li><code>undefined</code> は
      <strong>言語システムが自動的に設定する値</strong>
      として考える</li>
      <li><code>null</code> は
      <strong>開発者が意図的に「値が存在しない」ことを表現したい場合</strong>
      に使用する</li>
      </ul>
      <p>両者の違いや、使い分けについては、時間があるときに生成AIを利用して
      (学習の段階に応じて) 徐々に理解を深めていってください。</p>
      </div>
      <h3 data-number="2.2.3" id="不正なidを受け取ったときの処理"><span
      class="header-section-number">2.2.3</span>
      不正なidを受け取ったときの処理</h3>
      <p>ウェブブラウザのアドレバーにURLが直接入力された場合などは、<strong>不正なid</strong>
      を受け取ることがあります。<strong>第48行目</strong> から
      <strong>第50行目</strong>
      は、そのような場合に対処する実装となります。</p>
      <figure>
      <img src="figs/07/app_05.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <h3 data-number="2.2.4"
      id="動作確認と画像取得に関する設定変更"><span
      class="header-section-number">2.2.4</span>
      動作確認と画像取得に関する設定変更</h3>
      <p><code>src/app/posts/[id]/page.tsx</code>
      を作成、保存したら開発モードで動作を確認してください。トップページの記事概要から詳細ページに移動すると、次のようなエラーが発生します。</p>
      <figure>
      <img src="figs/07/app_02.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>これは、エラーメッセージから読み取れるように
      (<code>public</code>フォルダなどのプロジェクト内部に配置した画像ではなく)
      <span
      class="masked">外部サイトから画像を取得して表示しようとしていること</span>
      に起因します。Next.js
      のデフォルト設定では、「セキュティ」と「パフォーマンス最適化」の観点から
      <strong>外部からの画像の読込みが制限</strong>
      されるようになっています。</p>
      <p><strong>(プロンプト例)</strong></p>
      <blockquote>
      <p>Next.js
      のデフォルト設定では、外部からの画像の読込みが制限されています。この理由について教えてください。</p>
      </blockquote>
      <p>外部からの画像の読込みを許可するためには、プロジェクトフォルダの直下に配置されている
      <code>next.config.mjs</code> を次のように変更します。</p>
      <div class="sourceCode" id="cb6"
      data-caption="next.config.mjs (特定の外部オリジンからの画像の読込みの許可)"><pre
      class="sourceCode numberSource js numberLines"><code class="sourceCode javascript"><span id="cb6-1"><a href="#cb6-1"></a><span class="co">/** </span><span class="an">@type</span><span class="co"> {import(&#39;next&#39;).NextConfig} */</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="kw">const</span> nextConfig <span class="op">=</span> {</span>
<span id="cb6-3"><a href="#cb6-3"></a>  <span class="dt">images</span><span class="op">:</span> {</span>
<span id="cb6-4"><a href="#cb6-4"></a>    <span class="dt">remotePatterns</span><span class="op">:</span> [</span>
<span id="cb6-5"><a href="#cb6-5"></a>      {</span>
<span id="cb6-6"><a href="#cb6-6"></a>        <span class="dt">protocol</span><span class="op">:</span> <span class="st">&quot;https&quot;</span><span class="op">,</span></span>
<span id="cb6-7"><a href="#cb6-7"></a>        <span class="dt">hostname</span><span class="op">:</span> <span class="st">&quot;w1980.blob.core.windows.net&quot;</span><span class="op">,</span></span>
<span id="cb6-8"><a href="#cb6-8"></a>      }<span class="op">,</span></span>
<span id="cb6-9"><a href="#cb6-9"></a>    ]<span class="op">,</span></span>
<span id="cb6-10"><a href="#cb6-10"></a>  }<span class="op">,</span></span>
<span id="cb6-11"><a href="#cb6-11"></a>}<span class="op">;</span></span>
<span id="cb6-12"><a href="#cb6-12"></a></span>
<span id="cb6-13"><a href="#cb6-13"></a><span class="im">export</span> <span class="im">default</span> nextConfig<span class="op">;</span></span></code></pre></div>
      <p>複数のサイトを設定したいときは、次のように設定します。</p>
      <p><a href="https://placehold.jp">placehold.jp</a>は、<span
      class="masked">指定したサイズでダミー画像
      (モックアップ用の画像)</span>
      を生成してくれるウェブサービスとなっています。ウェブアプリ開発の初期段階で非常に役立つサービスなので覚えておいてください。</p>
      <div class="sourceCode" id="cb7"
      data-caption="next.config.mjs"><pre
      class="sourceCode numberSource js numberLines"><code class="sourceCode javascript"><span id="cb7-1"><a href="#cb7-1"></a><span class="co">/** </span><span class="an">@type</span><span class="co"> {import(&#39;next&#39;).NextConfig} */</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="kw">const</span> nextConfig <span class="op">=</span> {</span>
<span id="cb7-3"><a href="#cb7-3"></a>  <span class="dt">images</span><span class="op">:</span> {</span>
<span id="cb7-4"><a href="#cb7-4"></a>    <span class="dt">remotePatterns</span><span class="op">:</span> [</span>
<span id="cb7-5"><a href="#cb7-5"></a>      {</span>
<span id="cb7-6"><a href="#cb7-6"></a>        <span class="dt">protocol</span><span class="op">:</span> <span class="st">&quot;https&quot;</span><span class="op">,</span></span>
<span id="cb7-7"><a href="#cb7-7"></a>        <span class="dt">hostname</span><span class="op">:</span> <span class="st">&quot;w1980.blob.core.windows.net&quot;</span><span class="op">,</span></span>
<span id="cb7-8"><a href="#cb7-8"></a>      }<span class="op">,</span></span>
<span id="cb7-9"><a href="#cb7-9"></a>      { <span class="dt">protocol</span><span class="op">:</span> <span class="st">&quot;https&quot;</span><span class="op">,</span> <span class="dt">hostname</span><span class="op">:</span> <span class="st">&quot;placehold.jp&quot;</span> }<span class="op">,</span></span>
<span id="cb7-10"><a href="#cb7-10"></a>    ]<span class="op">,</span></span>
<span id="cb7-11"><a href="#cb7-11"></a>  }<span class="op">,</span></span>
<span id="cb7-12"><a href="#cb7-12"></a>}<span class="op">;</span></span>
<span id="cb7-13"><a href="#cb7-13"></a></span>
<span id="cb7-14"><a href="#cb7-14"></a><span class="im">export</span> <span class="im">default</span> nextConfig<span class="op">;</span></span></code></pre></div>
      <p><code>next.config.mjs</code>
      の変更後は、<strong>ホットリロードが効かないこと</strong>があるので、開発サーバを停止してから、再度、起動して動作を確認してください。今度は、記事詳細ページのなかで次のように画像が表示されるはずです。</p>
      <figure>
      <img src="figs/07/app_01.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <h3 data-number="2.2.5" id="演習-宿題-30分"><span
      class="header-section-number">2.2.5</span> 演習 (宿題:
      <i class="fa-solid fa-stopwatch"></i> 30分)</h3>
      <p>記事詳細のページのなかに「<strong>投稿日</strong>」と「<strong>カテゴリ</strong>」の情報が表示されるように実装してください。またデザインなどをカスタマイズして、つくり込みをしてください。</p>
      <h1 data-number="3" id="ウェブから記事データを取得"><span
      class="header-section-number">3</span>
      ウェブから記事データを取得</h1>
      <p>ここまではモック (<code>src/app/_mocks/dummyPosts.ts</code>)
      からブログ記事のデータを取得して利用してきましたが、これを <span
      class="masked">ウェブAPIを使ってバックエンドから取得できる</span>
      ようにアップデートしていきます。</p>
      <h2 data-number="3.1" id="ウェブapiとは"><span
      class="header-section-number">3.1</span> ウェブAPIとは</h2>
      <p>まずは <a
      href="https://zipcloud.ibsnet.co.jp">zipcloud</a>が提供している<a
      href="https://zipcloud.ibsnet.co.jp/doc/api">郵便番号検索API</a>(=<strong>郵便番号から住所の取得が可能なウェブAPI</strong>)
      というウェブサービスを利用して、<strong>外部からデータを取得する処理</strong>
      について学んでいきます。</p>
      <p>現在、ウェブAPI (Web Application Programming Interface)
      の多くは <strong>HTTP/HTTPS</strong> を使って <span
      class="masked">JSONフォーマット</span>
      でデータを取得できるように設計・実装がされています。ここで利用する<a
      href="https://zipcloud.ibsnet.co.jp/doc/api">郵便番号検索API</a>についても、<strong>HTTPSでリクエスト</strong>を送って<strong>JSONフォーマット</strong>で住所データが取得できるサービスになっています。また、このあと利用する<a
      href="https://microcms.io/">microCMS</a>も、Next.js
      で実装するバックエンドについても、そのような設計・実装になっています。</p>
      <p><a
      href="https://zipcloud.ibsnet.co.jp/doc/api">郵便番号検索API</a>は、利用に際して
      <strong>HTTPヘッダに認証情報等を付加する必要がないので</strong>、ブラウザから直接利用することができます。Chromeのアドレスバーに次のURLを入力すると、以下のようにJSONフォーマットのレスポンスを得ることができます。</p>
      <ul>
      <li><code>https://zipcloud.ibsnet.co.jp/api/search?zipcode=572-0832</code></li>
      </ul>
      <figure>
      <img src="figs/07/api_01.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>また、次のような <strong>不正なリクエスト</strong>
      を送信すると、どのようなレスポンスが返ってくるかを把握してください。</p>
      <ul>
      <li><code>https://zipcloud.ibsnet.co.jp/api/search?zipcode=999-9999</code></li>
      <li><code>https://zipcloud.ibsnet.co.jp/api/search?zipcode=ABC</code></li>
      </ul>
      <p>URL (URI) のなかで <code>?</code> 以降の部分を <span
      class="masked">クエリパラメータ (Query Parameter)</span>
      や「<strong>クエリ文字列 (Query
      String)</strong>」と呼びます。クエリパラメータは、ウェブサーバーに対して追加のパラメータを送信するために使用され
      <span class="masked"><code>パラメータ名=値</code></span>
      の形式で指定します。</p>
      <p><strong>2個以上のパラメータ</strong>を指定する場合は
      <code>&amp;</code> で区切ります。例えば、<code>limit=5</code>
      というパラメータを追加したい場合は <span
      class="masked"><code>?zipcode=999-9999&amp;limit=5</code></span>
      のようにクエリパラメータを与えます。</p>
      <div class="note type-tips">
      <p><strong>URLエンコード</strong></p>
      <p>クエリパラメータに、日本語やスペース、記号などの特殊文字を使用したい場合があります。しかし、このような文字をそのままURLに使用すると問題が発生する可能性があるため、<span
      class="masked">URLエンコード (パーセントエンコード)</span>
      という処理で安全な文字列に変換する必要があります。</p>
      <p>例えば、半角スペースは <code>%20</code>、「大阪」という文字は
      <code>%E5%A4%A7%E9%98%AA</code>
      のようにURLエンコーディングすることができます。JavaScript
      では組込み関数の encodeURI() や encodeURIComponent()
      を使用してURLエンコーディングができます
      (2つの関数の差異については生成AIを使って調べてください)。</p>
      <p>以下のURLは <code>tbm=isch</code> と <code>q=大阪</code>
      というクエリパラメータを与えている例となります
      (「tbm=isch」は画像検索のためのパラメータになります)。</p>
      <ul>
      <li><code>https://www.google.com/search?tbm=isch&amp;q=%E5%A4%A7%E9%98%AA</code></li>
      </ul>
      </div>
      <h2 data-number="3.2" id="郵便番号検索apiの組込み"><span
      class="header-section-number">3.2</span>
      郵便番号検索APIの組込み</h2>
      <p>Next.js のコンポーネントのなかで、<a
      href="https://zipcloud.ibsnet.co.jp/doc/api">郵便番号検索API</a>にリクエストを送って、そのレスポンスとして得られるJSONデータに基づいてコンテンツを構築する仕組みを実装をしていきます。</p>
      <p>具体的には
      <code>http://localhost:3000/playground/zip-code/572-0832</code>
      というパスにアクセスしたとき、次のような画面が表示されるように設計・実装していきます。</p>
      <figure>
      <img src="figs/07/app_04.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>まずは <code>src/app</code> に <code>playground</code>
      というフォルダを作成して、そこに <code>zip-code</code>
      というサブフォルダを作成してください。さらに <code>zip-code</code>
      のなかに <code>[code]</code> というフォルダを作成して、そこに
      <code>page.tsx</code> を作成してください。</p>
      <pre><code>📂 src/app/
└─ 📂 playground/
    └─ 📂 zip-code/
        └─ 📂 [code]/
            └─ page.tsx</code></pre>
      <p><code>page.tsx</code>
      には、以下のコードを記述してください。</p>
      <div class="sourceCode" id="cb9"
      data-caption="src/app/playground/zip-code/[code]/page.tsx"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb9-1"><a href="#cb9-1"></a><span class="st">&quot;use client&quot;</span><span class="op">;</span></span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="im">import</span> { useState<span class="op">,</span> useEffect } <span class="im">from</span> <span class="st">&quot;react&quot;</span><span class="op">;</span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="im">import</span> { useParams } <span class="im">from</span> <span class="st">&quot;next/navigation&quot;</span><span class="op">;</span></span>
<span id="cb9-4"><a href="#cb9-4"></a></span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="kw">const</span> Page<span class="op">:</span> React<span class="op">.</span><span class="at">FC</span> <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb9-6"><a href="#cb9-6"></a>  <span class="kw">const</span> endpoint <span class="op">=</span> <span class="st">&quot;https://zipcloud.ibsnet.co.jp/api/search&quot;</span><span class="op">;</span></span>
<span id="cb9-7"><a href="#cb9-7"></a>  <span class="kw">const</span> { code } <span class="op">=</span> <span class="fu">useParams</span>() <span class="im">as</span> { code<span class="op">:</span> <span class="dt">string</span> }<span class="op">;</span></span>
<span id="cb9-8"><a href="#cb9-8"></a>  <span class="kw">const</span> [response<span class="op">,</span> setResponse] <span class="op">=</span> <span class="fu">useState</span><span class="op">&lt;</span><span class="dt">string</span><span class="op">&gt;</span>(<span class="st">&quot;APIからデータを取得中...&quot;</span>)<span class="op">;</span></span>
<span id="cb9-9"><a href="#cb9-9"></a></span>
<span id="cb9-10"><a href="#cb9-10"></a>  <span class="fu">useEffect</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb9-11"><a href="#cb9-11"></a>    <span class="kw">const</span> fetchAddressFromZipCode  <span class="op">=</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb9-12"><a href="#cb9-12"></a>      <span class="co">// ウェブAPIにGETリクエストを送信してレスポンスを取得</span></span>
<span id="cb9-13"><a href="#cb9-13"></a>      <span class="kw">const</span> requestUrl <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>endpoint<span class="sc">}</span><span class="vs">?zipcode=</span><span class="sc">${</span>code<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb9-14"><a href="#cb9-14"></a>      <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(requestUrl<span class="op">,</span> { <span class="co">// ◀◀ 注目</span></span>
<span id="cb9-15"><a href="#cb9-15"></a>        method<span class="op">:</span> <span class="st">&quot;GET&quot;</span><span class="op">,</span></span>
<span id="cb9-16"><a href="#cb9-16"></a>        cache<span class="op">:</span> <span class="st">&quot;no-store&quot;</span><span class="op">,</span> <span class="co">// キャッシュを利用しない</span></span>
<span id="cb9-17"><a href="#cb9-17"></a>      })<span class="op">;</span></span>
<span id="cb9-18"><a href="#cb9-18"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;ウェブAPIからデータを取得しました&quot;</span>)<span class="op">;</span></span>
<span id="cb9-19"><a href="#cb9-19"></a></span>
<span id="cb9-20"><a href="#cb9-20"></a>      <span class="co">// レスポンスからJSON形式でデータ取得して整形して表示</span></span>
<span id="cb9-21"><a href="#cb9-21"></a>      <span class="kw">const</span> parsedData <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span> <span class="co">// ◀◀ 注目</span></span>
<span id="cb9-22"><a href="#cb9-22"></a>      <span class="fu">setResponse</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(parsedData<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></span>
<span id="cb9-23"><a href="#cb9-23"></a>    }<span class="op">;</span></span>
<span id="cb9-24"><a href="#cb9-24"></a></span>
<span id="cb9-25"><a href="#cb9-25"></a>    <span class="fu">fetchAddressFromZipCode</span> ()<span class="op">;</span> <span class="co">// 関数を実行</span></span>
<span id="cb9-26"><a href="#cb9-26"></a>  }<span class="op">,</span> [code])<span class="op">;</span></span>
<span id="cb9-27"><a href="#cb9-27"></a></span>
<span id="cb9-28"><a href="#cb9-28"></a>  <span class="cf">return</span> (</span>
<span id="cb9-29"><a href="#cb9-29"></a>    <span class="op">&lt;</span>main<span class="op">&gt;</span></span>
<span id="cb9-30"><a href="#cb9-30"></a>      <span class="op">&lt;</span>div className<span class="op">=</span><span class="st">&quot;mb-5 text-2xl font-bold&quot;</span><span class="op">&gt;</span>{<span class="vs">`郵便番号 </span><span class="sc">${</span>code<span class="sc">}</span><span class="vs"> の検索`</span>}<span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb9-31"><a href="#cb9-31"></a>      <span class="op">&lt;</span>div className<span class="op">=</span><span class="st">&quot;space-y-3&quot;</span><span class="op">&gt;</span></span>
<span id="cb9-32"><a href="#cb9-32"></a>        <span class="op">&lt;</span>div<span class="op">&gt;</span>実行結果<span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb9-33"><a href="#cb9-33"></a>        <span class="op">&lt;</span>pre className<span class="op">=</span><span class="st">&quot;rounded-md bg-green-100 p-3 text-sm&quot;</span><span class="op">&gt;</span>{response}<span class="op">&lt;/</span>pre<span class="op">&gt;</span></span>
<span id="cb9-34"><a href="#cb9-34"></a>      <span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb9-35"><a href="#cb9-35"></a>    <span class="op">&lt;/</span>main<span class="op">&gt;</span></span>
<span id="cb9-36"><a href="#cb9-36"></a>  )<span class="op">;</span></span>
<span id="cb9-37"><a href="#cb9-37"></a>}<span class="op">;</span></span>
<span id="cb9-38"><a href="#cb9-38"></a></span>
<span id="cb9-39"><a href="#cb9-39"></a><span class="im">export</span> <span class="im">default</span> Page<span class="op">;</span></span></code></pre></div>
      <p>はじめに開発モードで起動して、意図するように機能することを確認してください。</p>
      <figure>
      <img src="figs/07/app_04.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>このコードのなかで注目すべき箇所は <strong>第10行目</strong>
      から <strong>第26行目</strong> にかけての <code>useEffect</code>
      の処理になります。</p>
      <p>メインとなるデータ取得の処理は
      <code>useEffect(() =&gt; {...},[code])</code>
      のなかに記述されており、<strong>Pageコンポーネントが読み込まれたとき
      (マウントされたとき)</strong> と、<code>code</code>
      が変更されたとき
      <strong>だけ</strong>、APIからのデータ取得が実行されるようになっています。</p>
      <p><code>useEffect</code> の内部では、<strong>第11行目</strong>
      から <strong>第23行目</strong> にかけて
      <code>fetchAddressFromZipCode</code>
      がアロー関数形式で定義され、それが <strong>第25行目</strong>
      で呼び出されています。<code>fetchAddressFromZipCode</code>
      の内部では <code>async</code> と <code>await</code> という<span
      class="masked">「非同期処理」を取り扱うためのキーワード</span>
      が使用されています
      (非同期処理の詳細は次のセクションで解説します)。そして、ウェブAPIからデータを取得するメイン処理は
      <strong>第14行目</strong> の <code>fetch</code>
      という組み込み関数で行なわれています。</p>
      <p>「fetch」とは、ウェブアプリの文脈では <span
      class="masked">データを外部から取得する</span> や <span
      class="masked">リモートのリソースを読み込んでくる</span>
      という意味になります。関数 <code>fetch</code> の
      <strong>第1引数</strong> にはウェブAPI の URL
      (エンドポイントとも呼ばれます) を与え、<strong>第2引数</strong>
      にはリクエストのオプション設定を与えます。</p>
      <hr />
      <p>なお、<strong>第33行目</strong> の
      <code>&lt;pre&gt;...&lt;/pre&gt;</code> は、<strong>Preformatted
      Text</strong> (整形済みテキスト)
      のためのタグで、タグに囲まれた子要素の内容を <span
      class="masked">「スペース」や「改行」などをそのままに、等幅フォントで</span>
      出力する機能を持ちます。</p>
      <h3 data-number="3.2.1" id="演習-5分"><span
      class="header-section-number">3.2.1</span> 演習
      (<i class="fa-solid fa-stopwatch"></i> 5分)</h3>
      <p><strong>第33行目</strong> の <code>&lt;pre&gt;</code>
      タグを以下のように <code>&lt;div&gt;</code>
      タグに書き換えて、画面表示がどのように変化するか確認してください。</p>
      <div class="sourceCode" id="cb10"
      data-caption="src/app/playground/zip-code/[code]/page.tsx (抜粋・変更前)"
      data-startFrom="32"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 31;"><span id="cb10-32"><a href="#cb10-32"></a><span class="op">&lt;</span>pre className<span class="op">=</span><span class="st">&quot;rounded-md bg-green-100 p-3 text-sm&quot;</span><span class="op">&gt;</span>{response}<span class="op">&lt;/</span>pre<span class="op">&gt;</span></span></code></pre></div>
      <div class="sourceCode" id="cb11"
      data-caption="src/app/playground/zip-code/[code]/page.tsx (抜粋・変更後)"
      data-startFrom="32"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 31;"><span id="cb11-32"><a href="#cb11-32"></a><span class="op">&lt;</span>div className<span class="op">=</span><span class="st">&quot;rounded-md bg-green-100 p-3 text-sm&quot;</span><span class="op">&gt;</span>{response}<span class="op">&lt;/</span>ｄiv<span class="op">&gt;</span></span></code></pre></div>
      <h1 data-number="4" id="同期処理と非同期処理"><span
      class="header-section-number">4</span> 同期処理と非同期処理</h1>
      <p>ここでは「<strong>同期処理</strong>」や「<strong>非同期処理</strong>」の概要について学んでいきます。</p>
      <div class="note type-caution">
      <p><strong>注意</strong>: ここでは
      <strong>正確性・厳密性をある程度犠牲にして、分かりやすさを優先した解説</strong>になることを了承ください。詳しいことについては、ウェブや生成AIを利用して理解を深めてください。</p>
      </div>
      <p>アプリ開発の文脈において「<strong>同期処理</strong>」や「<strong>非同期処理</strong>」とは
      <span class="masked">プログラム (タスク)
      の実行順序についての制御方式</span>
      を指す用語になります。ざっくりと言えば、同期処理は「<strong>順次実行</strong>」、非同期処理は
      <span class="masked">「並列実行」</span>
      を基本とした制御方式になります。</p>
      <p>例えば、次のような順序でプログラムが書かれているとき：</p>
      <pre><code>関数1();
関数2();
関数3();</code></pre>
      <p><strong>同期処理</strong> (Synchronous Processing)
      とは、<code>関数1()</code> から <code>関数3()</code> までを
      <strong>ひとつずつ順番に実行する方式</strong> になります。つまり
      <code>関数1()</code> の<strong>完了を待ってから</strong>
      <code>関数2()</code> が実行されます。また、<code>関数2()</code>
      の<strong>完了を待ってから</strong> <code>関数3()</code>
      が実行されます。JavaScript や Python
      など、ほとんどのプログラミング言語では
      <strong>非同期処理のための特別なキーワード</strong>
      (<code>async</code> など)
      を使用しない限り、このような同期処理で実行されます。</p>
      <p>一方で <strong>非同期処理</strong> (Asynchronous Processing)
      とは、<code>関数1()</code> の<strong>完了を待たずに</strong> <span
      class="masked"><code>関数2()</code> が実行され</span>、また
      <code>関数2()</code> の<strong>完了を待たずに</strong>
      <code>関数3()</code> が実行されるような制御方式となります。</p>
      <h2 data-number="4.1" id="同期処理の動作確認"><span
      class="header-section-number">4.1</span> 同期処理の動作確認</h2>
      <p>はじめに <strong>同期処理</strong>
      について、<strong>動作や挙動を確認するための実験</strong>をしていきます。ブログアプリのプロジェクトフォルダに、次のような実験のためのファイルを作成してください。</p>
      <div class="sourceCode" id="cb13"
      data-caption="src/app/playground/sync/page.tsx"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb13-1"><a href="#cb13-1"></a><span class="st">&quot;use client&quot;</span><span class="op">;</span></span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="im">import</span> { twMerge } <span class="im">from</span> <span class="st">&quot;tailwind-merge&quot;</span><span class="op">;</span></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="im">import</span> { FontAwesomeIcon } <span class="im">from</span> <span class="st">&quot;@fortawesome/react-fontawesome&quot;</span><span class="op">;</span></span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="im">import</span> { faGear } <span class="im">from</span> <span class="st">&quot;@fortawesome/free-solid-svg-icons&quot;</span><span class="op">;</span></span>
<span id="cb13-5"><a href="#cb13-5"></a></span>
<span id="cb13-6"><a href="#cb13-6"></a><span class="kw">const</span> syncTask <span class="op">=</span> (name<span class="op">:</span> <span class="dt">string</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb13-7"><a href="#cb13-7"></a>  <span class="co">// なんらかの処理が実行されると仮定</span></span>
<span id="cb13-8"><a href="#cb13-8"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`同期処理 </span><span class="sc">${</span>name<span class="sc">}</span><span class="vs"> が完了しました`</span>)<span class="op">;</span></span>
<span id="cb13-9"><a href="#cb13-9"></a>}<span class="op">;</span></span>
<span id="cb13-10"><a href="#cb13-10"></a></span>
<span id="cb13-11"><a href="#cb13-11"></a><span class="kw">const</span> Page<span class="op">:</span> React<span class="op">.</span><span class="at">FC</span> <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb13-12"><a href="#cb13-12"></a>  <span class="kw">const</span> syncProcess <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb13-13"><a href="#cb13-13"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;関数 syncProcess を開始&quot;</span>)<span class="op">;</span></span>
<span id="cb13-14"><a href="#cb13-14"></a>    <span class="fu">syncTask</span>(<span class="st">&quot;処理1&quot;</span>)<span class="op">;</span></span>
<span id="cb13-15"><a href="#cb13-15"></a>    <span class="fu">syncTask</span>(<span class="st">&quot;処理2&quot;</span>)<span class="op">;</span></span>
<span id="cb13-16"><a href="#cb13-16"></a>    <span class="fu">syncTask</span>(<span class="st">&quot;処理3&quot;</span>)<span class="op">;</span></span>
<span id="cb13-17"><a href="#cb13-17"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;関数 syncProcess の最後に到達&quot;</span>)<span class="op">;</span></span>
<span id="cb13-18"><a href="#cb13-18"></a>  }<span class="op">;</span></span>
<span id="cb13-19"><a href="#cb13-19"></a></span>
<span id="cb13-20"><a href="#cb13-20"></a>  <span class="cf">return</span> (</span>
<span id="cb13-21"><a href="#cb13-21"></a>    <span class="op">&lt;</span>main<span class="op">&gt;</span></span>
<span id="cb13-22"><a href="#cb13-22"></a>      <span class="op">&lt;</span>div className<span class="op">=</span><span class="st">&quot;mb-5 text-2xl font-bold&quot;</span><span class="op">&gt;</span></span>
<span id="cb13-23"><a href="#cb13-23"></a>        同期処理を理解するための実験1</span>
<span id="cb13-24"><a href="#cb13-24"></a>      <span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb13-25"><a href="#cb13-25"></a>      <span class="op">&lt;</span>div className<span class="op">=</span><span class="st">&quot;space-y-3&quot;</span><span class="op">&gt;</span></span>
<span id="cb13-26"><a href="#cb13-26"></a>        <span class="op">&lt;</span>button</span>
<span id="cb13-27"><a href="#cb13-27"></a>          <span class="kw">type</span><span class="op">=</span><span class="st">&quot;button&quot;</span></span>
<span id="cb13-28"><a href="#cb13-28"></a>          onClick<span class="op">=</span>{syncProcess}</span>
<span id="cb13-29"><a href="#cb13-29"></a>          className<span class="op">=</span>{<span class="fu">twMerge</span>(</span>
<span id="cb13-30"><a href="#cb13-30"></a>            <span class="st">&quot;rounded-md px-3 py-1&quot;</span><span class="op">,</span></span>
<span id="cb13-31"><a href="#cb13-31"></a>            <span class="st">&quot;bg-indigo-500 font-bold text-white hover:bg-indigo-600&quot;</span></span>
<span id="cb13-32"><a href="#cb13-32"></a>          )}</span>
<span id="cb13-33"><a href="#cb13-33"></a>        <span class="op">&gt;</span></span>
<span id="cb13-34"><a href="#cb13-34"></a>          同期処理の実行</span>
<span id="cb13-35"><a href="#cb13-35"></a>        <span class="op">&lt;/</span>button<span class="op">&gt;</span></span>
<span id="cb13-36"><a href="#cb13-36"></a>        <span class="op">&lt;</span>div className<span class="op">=</span><span class="st">&quot;flex justify-items-start space-x-2&quot;</span><span class="op">&gt;</span></span>
<span id="cb13-37"><a href="#cb13-37"></a>          <span class="op">&lt;</span>div<span class="op">&gt;</span></span>
<span id="cb13-38"><a href="#cb13-38"></a>            <span class="op">&lt;</span>FontAwesomeIcon</span>
<span id="cb13-39"><a href="#cb13-39"></a>              icon<span class="op">=</span>{faGear}</span>
<span id="cb13-40"><a href="#cb13-40"></a>              className<span class="op">=</span><span class="st">&quot;animate-spin text-2xl [animation-duration:2s]&quot;</span></span>
<span id="cb13-41"><a href="#cb13-41"></a>            <span class="op">/&gt;</span></span>
<span id="cb13-42"><a href="#cb13-42"></a>          <span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb13-43"><a href="#cb13-43"></a>          {[<span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>]<span class="op">.</span><span class="fu">map</span>((i) <span class="kw">=&gt;</span> (</span>
<span id="cb13-44"><a href="#cb13-44"></a>            <span class="op">&lt;</span>div key<span class="op">=</span>{i}<span class="op">&gt;</span></span>
<span id="cb13-45"><a href="#cb13-45"></a>              <span class="op">&lt;</span>input</span>
<span id="cb13-46"><a href="#cb13-46"></a>                id<span class="op">=</span>{<span class="vs">`cb-</span><span class="sc">${</span>i<span class="sc">}</span><span class="vs">`</span>}</span>
<span id="cb13-47"><a href="#cb13-47"></a>                <span class="kw">type</span><span class="op">=</span><span class="st">&quot;checkbox&quot;</span></span>
<span id="cb13-48"><a href="#cb13-48"></a>                className<span class="op">=</span><span class="st">&quot;mr-1&quot;</span></span>
<span id="cb13-49"><a href="#cb13-49"></a>                defaultChecked<span class="op">=</span>{i <span class="op">===</span> <span class="dv">1</span>}</span>
<span id="cb13-50"><a href="#cb13-50"></a>              <span class="op">/&gt;</span></span>
<span id="cb13-51"><a href="#cb13-51"></a>              <span class="op">&lt;</span>label htmlFor<span class="op">=</span>{<span class="vs">`cb-</span><span class="sc">${</span>i<span class="sc">}</span><span class="vs">`</span>} className<span class="op">=</span><span class="st">&quot;font-bold&quot;</span><span class="op">&gt;</span></span>
<span id="cb13-52"><a href="#cb13-52"></a>                項目{i}</span>
<span id="cb13-53"><a href="#cb13-53"></a>              <span class="op">&lt;/</span>label<span class="op">&gt;</span></span>
<span id="cb13-54"><a href="#cb13-54"></a>            <span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb13-55"><a href="#cb13-55"></a>          ))}</span>
<span id="cb13-56"><a href="#cb13-56"></a>        <span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb13-57"><a href="#cb13-57"></a>      <span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb13-58"><a href="#cb13-58"></a>    <span class="op">&lt;/</span>main<span class="op">&gt;</span></span>
<span id="cb13-59"><a href="#cb13-59"></a>  )<span class="op">;</span></span>
<span id="cb13-60"><a href="#cb13-60"></a>}<span class="op">;</span></span>
<span id="cb13-61"><a href="#cb13-61"></a></span>
<span id="cb13-62"><a href="#cb13-62"></a><span class="im">export</span> <span class="im">default</span> Page<span class="op">;</span></span></code></pre></div>
      <p>上記のプログラムは <code>async</code> や <code>await</code>
      などのキーワードを含まない、つまり
      <strong>非同期処理を含まない純粋な「同期処理」のプログラム</strong>
      となっています。まずは、開発モードでサーバを起動して
      <code>/playground/sync</code>
      にアクセスして、次のようなコンテンツが表示されることを確認してください。</p>
      <p>そして、画面内の「<strong>同期処理の実行</strong>」を押下したとき
      (つまり <strong>第28行目</strong> の設定によって、関数
      <code>syncProcess</code>
      がコールされたとき)、デベロッパーツールのコンソールに <span
      class="masked">どのような順序で、どのようなログが出力されるか</span>
      について少し考えてみてください。これは同期処理なので、難しく考えず普通に素直に考えてもらってOKです。</p>
      <figure>
      <img src="figs/07/sync_01.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>コンソール出力がどのようになるか、予測できたでしょうか。実際に「同期処理の実行」のボタンを押下して結果を確認してみてください。次のような結果となるはずです。</p>
      <pre><code>関数 syncProcess を開始
同期処理 処理1 が完了しました
同期処理 処理2 が完了しました
同期処理 処理3 が完了しました
関数 syncProcess の最後に到達</code></pre>
      <p>予測したように各処理は、プログラムの <strong>第13行目</strong>
      から <strong>第17行目</strong>
      にかけて記述した順番通りに実行され、ログが出力されています。つまり、<code>syncTask("処理1")</code>
      の完了を待ってから <code>syncTask("処理2")</code>
      が実行されていることが確認できました。同様に
      <code>syncTask("処理2")</code> の完了を待ってから
      <code>syncTask("処理3");</code>
      されていることが確認できました。</p>
      <p>ところで、これは視点を変えれば <code>syncTask("処理1")</code>
      の実行中は、後続の処理である <code>syncTask("処理2")</code> の
      <strong>実行が一時的に中断されている状態</strong>
      とみることもできます。このような実行の中断状態のことを <span
      class="masked">ブロッキング (blocking)</span>
      と呼びます。このとき、<code>syncTask("処理1")</code>
      は実行中のタスクとして、後続の <code>syncTask("処理2")</code>
      の実行を「<strong>ブロック</strong>」していると表現します。</p>
      <h2 data-number="4.2"
      id="処理時間を要するタスクを同期処理で扱うときの問題"><span
      class="header-section-number">4.2</span>
      処理時間を要するタスクを同期処理で扱うときの問題</h2>
      <p>次に <code>src/app/playground/sync/page.tsx</code>
      を次のように書き換えてください。<strong>第11行目</strong> の
      <code>heavySyncTask</code>
      は、<strong>処理時間を要するタスク</strong>
      (実行完了までに時間のかかるタスク)
      を疑似的にシミュレートしている関数になります。</p>
      <p>この「<strong>処理時間を要するタスク</strong>」とは、フロントエンド開発で言えば具体的には
      <span class="masked">ウェブAPIからのデータの取得</span>
      や、大量のデータを処理する計算、複雑なDOM操作などが相当します。</p>
      <p><code>page.tsx</code>
      を書き換えたら、先ほどと同様に「<strong>同期処理の実行</strong>」のボタンを押下したとき、どのようなコンソール出力が得られるかを考え、その後、実際に実行してみてください。</p>
      <div class="sourceCode" id="cb15"
      data-caption="src/app/playground/sync/page.tsx"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb15-1"><a href="#cb15-1"></a><span class="st">&quot;use client&quot;</span><span class="op">;</span></span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="im">import</span> { twMerge } <span class="im">from</span> <span class="st">&quot;tailwind-merge&quot;</span><span class="op">;</span></span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="im">import</span> { FontAwesomeIcon } <span class="im">from</span> <span class="st">&quot;@fortawesome/react-fontawesome&quot;</span><span class="op">;</span></span>
<span id="cb15-4"><a href="#cb15-4"></a><span class="im">import</span> { faGear } <span class="im">from</span> <span class="st">&quot;@fortawesome/free-solid-svg-icons&quot;</span><span class="op">;</span></span>
<span id="cb15-5"><a href="#cb15-5"></a></span>
<span id="cb15-6"><a href="#cb15-6"></a><span class="kw">const</span> syncTask <span class="op">=</span> (name<span class="op">:</span> <span class="dt">string</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb15-7"><a href="#cb15-7"></a>  <span class="co">// なんらかの処理が実行されると仮定</span></span>
<span id="cb15-8"><a href="#cb15-8"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`同期処理 </span><span class="sc">${</span>name<span class="sc">}</span><span class="vs"> が完了しました`</span>)<span class="op">;</span></span>
<span id="cb15-9"><a href="#cb15-9"></a>}<span class="op">;</span></span>
<span id="cb15-10"><a href="#cb15-10"></a></span>
<span id="cb15-11"><a href="#cb15-11"></a><span class="kw">const</span> heavySyncTask <span class="op">=</span> (workload<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb15-12"><a href="#cb15-12"></a>  <span class="co">// なんらかの重たい処理が実行されると仮定</span></span>
<span id="cb15-13"><a href="#cb15-13"></a>  <span class="kw">const</span> startTime <span class="op">=</span> <span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb15-14"><a href="#cb15-14"></a>  <span class="cf">while</span> (<span class="bu">Date</span><span class="op">.</span><span class="fu">now</span>() <span class="op">-</span> startTime <span class="op">&lt;</span> <span class="dv">1000</span>) { }</span>
<span id="cb15-15"><a href="#cb15-15"></a>  <span class="kw">const</span> ret <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">floor</span>(<span class="bu">Math</span><span class="op">.</span><span class="fu">random</span>() <span class="op">*</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb15-16"><a href="#cb15-16"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;同期処理 heavySyncTask が完了しました&quot;</span>)<span class="op">;</span></span>
<span id="cb15-17"><a href="#cb15-17"></a>  <span class="cf">return</span> ret<span class="op">;</span></span>
<span id="cb15-18"><a href="#cb15-18"></a>}<span class="op">;</span></span>
<span id="cb15-19"><a href="#cb15-19"></a></span>
<span id="cb15-20"><a href="#cb15-20"></a><span class="kw">const</span> Page<span class="op">:</span> React<span class="op">.</span><span class="at">FC</span> <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb15-21"><a href="#cb15-21"></a>  <span class="kw">const</span> syncProcess <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb15-22"><a href="#cb15-22"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;関数 syncProcess を開始&quot;</span>)<span class="op">;</span></span>
<span id="cb15-23"><a href="#cb15-23"></a>    <span class="fu">syncTask</span>(<span class="st">&quot;処理1&quot;</span>)<span class="op">;</span></span>
<span id="cb15-24"><a href="#cb15-24"></a>    <span class="fu">heavySyncTask</span>(<span class="dv">2000</span>)<span class="op">;</span> <span class="co">// 実行完了に2000msかかる処理</span></span>
<span id="cb15-25"><a href="#cb15-25"></a>    <span class="fu">syncTask</span>(<span class="st">&quot;処理2&quot;</span>)<span class="op">;</span></span>
<span id="cb15-26"><a href="#cb15-26"></a>    <span class="fu">syncTask</span>(<span class="st">&quot;処理3&quot;</span>)<span class="op">;</span></span>
<span id="cb15-27"><a href="#cb15-27"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;関数 syncProcess の最後に到達&quot;</span>)<span class="op">;</span></span>
<span id="cb15-28"><a href="#cb15-28"></a>  }<span class="op">;</span></span>
<span id="cb15-29"><a href="#cb15-29"></a></span>
<span id="cb15-30"><a href="#cb15-30"></a><span class="co">// 以下、変更なし </span></span></code></pre></div>
      <p>コンソール出力は (予測のとおりに)
      次のようになったはずです。ただ、<strong>それとは別に画面内に変化があったこと</strong>に気づいたでしょうか。もし、気付かなかったときは、再度「同期処理の実行」のボタンを押下してください。</p>
      <pre><code>関数 syncProcess を開始
同期処理 処理1 が完了しました
同期処理 heavySyncTask が完了しました
同期処理 処理2 が完了しました
同期処理 処理3 が完了しました
関数 syncProcess の最後に到達</code></pre>
      <p>処理時間を要するタスクを含む場合、ボタン押下後に <span
      class="masked">歯車マークのCSSアニメーションが止まってしまうこと</span>
      に気づけたでしょうか。そして、ややあって「<strong>関数 syncProcess
      の最後に到達</strong>」というログが出力され、アニメーションの実行アニメーションが再開されることに気付いたでしょうか。つまり、<code>syncProcess</code>
      <strong>の実行が完了するまではアニメーションが停止してしまうという問題</strong>が生じます。</p>
      <p>そして、もうひとつ、<code>syncProcess</code> の
      <strong>実行が完了するまで</strong> は <span
      class="masked">チェックボックスをクリックしても応答しなくなってしまうこと</span>
      も確認してください。このようにフリーズしたような状態というのは、ユーザ体験
      (UX) を著しく悪化させることになります。</p>
      <figure>
      <img src="figs/07/sync_02.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <h2 data-number="4.3" id="同期処理で問題が起こる原因"><span
      class="header-section-number">4.3</span>
      同期処理で問題が起こる原因</h2>
      <p>なぜ「<strong>このようなことが起きるのか</strong>」について紐解いていきます。</p>
      <p>ウェブブラウザで実行される JavaScript
      では、開発者が記述したプログラムの処理 (例えば
      <code>syncProcess</code> など)
      に加えて、実は、次のような処理も担当しています。</p>
      <ul>
      <li><strong>DOMイベント</strong>
      (クリックやスクロールなどのユーザー操作) への応答</li>
      <li><strong>レンダリング処理</strong>
      (CSSアニメーションの実行を含む)</li>
      </ul>
      <p>これらの処理は、特に非同期処理として明示されていない限り
      <strong>メインスレッド</strong> (あるいはUIスレッド) とよばれる
      <strong>単一のスレッド</strong>
      において常に1つずつ順番に処理されることになります。そのため、<code>heavySyncTask</code>
      のような実行時間の長いタスクを同期的に処理すると、先ほど確認したようにアニメーションやユーザ操作
      (チェックボックスのクリックなど)
      に対する応答がブロックされることになります。</p>
      <p>このブロッキングは実際には常に発生していますが、ユーザ処理が軽い場合
      (数ミリ秒程度で完了する場合)
      は、その時間が短すぎて知覚することはありません。しかし、<strong>ウェブAPIからのデータの取得</strong>
      のように時間のかかる処理を同期的に実行すると、UIの明らかな停止としてUXを損ねることになります。</p>
      <p>このようなことから、JavaScript では
      <strong>HTTPリクエストを実行する標準機能</strong> として
      <code>fetch</code>
      という非同期処理が提供されています。開発者が誤って同期的な実装をしないように、<code>fetch</code>
      について同期バージョンは提供されていません。</p>
      <h2 data-number="4.4" id="非同期処理"><span
      class="header-section-number">4.4</span> 非同期処理</h2>
      <p>以上に示したような同期処理の問題 (ブロッキング)
      を回避するために、JavaScript には
      <strong>非同期処理の仕組み</strong>
      が用意されています。まずは、実際に実装して、その動作を確認してみます。新規に
      <code>src/app/playground/async/page.tsx</code>
      を作成して、以下のコードを記述してください。</p>
      <p>全体構造は、先ほどの同期処理と同じですが、<strong>第11行目</strong>
      の <code>heavyAsyncTask</code>
      関数が大きく書き換わっています。<code>heavyAsyncTask</code> は
      <code>async</code> キーワードが付けられた <span
      class="masked">非同期処理を含んだ関数</span> となっています
      (非同期処理の本体部分は <strong>第12行目</strong> です)。</p>
      <div class="sourceCode" id="cb17"
      data-caption="src/app/playground/async/page.tsx"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb17-1"><a href="#cb17-1"></a><span class="st">&quot;use client&quot;</span><span class="op">;</span></span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="im">import</span> { twMerge } <span class="im">from</span> <span class="st">&quot;tailwind-merge&quot;</span><span class="op">;</span></span>
<span id="cb17-3"><a href="#cb17-3"></a><span class="im">import</span> { FontAwesomeIcon } <span class="im">from</span> <span class="st">&quot;@fortawesome/react-fontawesome&quot;</span><span class="op">;</span></span>
<span id="cb17-4"><a href="#cb17-4"></a><span class="im">import</span> { faGear } <span class="im">from</span> <span class="st">&quot;@fortawesome/free-solid-svg-icons&quot;</span><span class="op">;</span></span>
<span id="cb17-5"><a href="#cb17-5"></a></span>
<span id="cb17-6"><a href="#cb17-6"></a><span class="kw">const</span> syncTask <span class="op">=</span> (name<span class="op">:</span> <span class="dt">string</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb17-7"><a href="#cb17-7"></a>  <span class="co">// なんらかの処理が実行されると仮定</span></span>
<span id="cb17-8"><a href="#cb17-8"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`同期処理 </span><span class="sc">${</span>name<span class="sc">}</span><span class="vs"> が完了しました`</span>)<span class="op">;</span></span>
<span id="cb17-9"><a href="#cb17-9"></a>}<span class="op">;</span></span>
<span id="cb17-10"><a href="#cb17-10"></a></span>
<span id="cb17-11"><a href="#cb17-11"></a><span class="kw">const</span> heavyAsyncTask <span class="op">=</span> <span class="kw">async</span> (workload<span class="op">:</span> <span class="dt">number</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb17-12"><a href="#cb17-12"></a>  <span class="cf">await</span> <span class="kw">new</span> <span class="bu">Promise</span>((resolve) <span class="kw">=&gt;</span> <span class="pp">setTimeout</span>(resolve<span class="op">,</span> workload))<span class="op">;</span></span>
<span id="cb17-13"><a href="#cb17-13"></a>  <span class="kw">const</span> ret <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">floor</span>(<span class="bu">Math</span><span class="op">.</span><span class="fu">random</span>() <span class="op">*</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb17-14"><a href="#cb17-14"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;非同期処理 heavyAsyncTask が完了しました&quot;</span>)<span class="op">;</span></span>
<span id="cb17-15"><a href="#cb17-15"></a>  <span class="cf">return</span> ret<span class="op">;</span></span>
<span id="cb17-16"><a href="#cb17-16"></a>}<span class="op">;</span></span>
<span id="cb17-17"><a href="#cb17-17"></a></span>
<span id="cb17-18"><a href="#cb17-18"></a><span class="kw">const</span> Page<span class="op">:</span> React<span class="op">.</span><span class="at">FC</span> <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb17-19"><a href="#cb17-19"></a>  <span class="kw">const</span> asyncProcess <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb17-20"><a href="#cb17-20"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;関数 asyncProcess を開始&quot;</span>)<span class="op">;</span></span>
<span id="cb17-21"><a href="#cb17-21"></a>    <span class="fu">syncTask</span>(<span class="st">&quot;処理1&quot;</span>)<span class="op">;</span></span>
<span id="cb17-22"><a href="#cb17-22"></a>    <span class="fu">heavyAsyncTask</span>(<span class="dv">2000</span>)<span class="op">;</span> <span class="co">// 実行完了に2000msかかる非同期処理</span></span>
<span id="cb17-23"><a href="#cb17-23"></a>    <span class="fu">syncTask</span>(<span class="st">&quot;処理2&quot;</span>)<span class="op">;</span></span>
<span id="cb17-24"><a href="#cb17-24"></a>    <span class="fu">syncTask</span>(<span class="st">&quot;処理3&quot;</span>)<span class="op">;</span></span>
<span id="cb17-25"><a href="#cb17-25"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;関数 asyncProcess の最後に到達&quot;</span>)<span class="op">;</span></span>
<span id="cb17-26"><a href="#cb17-26"></a>  }<span class="op">;</span></span>
<span id="cb17-27"><a href="#cb17-27"></a></span>
<span id="cb17-28"><a href="#cb17-28"></a>  <span class="cf">return</span> (</span>
<span id="cb17-29"><a href="#cb17-29"></a>    <span class="op">&lt;</span>main<span class="op">&gt;</span></span>
<span id="cb17-30"><a href="#cb17-30"></a>      <span class="op">&lt;</span>div className<span class="op">=</span><span class="st">&quot;mb-5 text-2xl font-bold&quot;</span><span class="op">&gt;</span></span>
<span id="cb17-31"><a href="#cb17-31"></a>        非同期処理を理解するための実験1</span>
<span id="cb17-32"><a href="#cb17-32"></a>      <span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb17-33"><a href="#cb17-33"></a>      <span class="op">&lt;</span>div className<span class="op">=</span><span class="st">&quot;space-y-3&quot;</span><span class="op">&gt;</span></span>
<span id="cb17-34"><a href="#cb17-34"></a>        <span class="op">&lt;</span>button</span>
<span id="cb17-35"><a href="#cb17-35"></a>          <span class="kw">type</span><span class="op">=</span><span class="st">&quot;button&quot;</span></span>
<span id="cb17-36"><a href="#cb17-36"></a>          onClick<span class="op">=</span>{asyncProcess}</span>
<span id="cb17-37"><a href="#cb17-37"></a>          className<span class="op">=</span>{<span class="fu">twMerge</span>(</span>
<span id="cb17-38"><a href="#cb17-38"></a>            <span class="st">&quot;rounded-md px-3 py-1&quot;</span><span class="op">,</span></span>
<span id="cb17-39"><a href="#cb17-39"></a>            <span class="st">&quot;bg-indigo-500 font-bold text-white hover:bg-indigo-600&quot;</span></span>
<span id="cb17-40"><a href="#cb17-40"></a>          )}</span>
<span id="cb17-41"><a href="#cb17-41"></a>        <span class="op">&gt;</span></span>
<span id="cb17-42"><a href="#cb17-42"></a>          非同期処理の実行</span>
<span id="cb17-43"><a href="#cb17-43"></a>        <span class="op">&lt;/</span>button<span class="op">&gt;</span></span>
<span id="cb17-44"><a href="#cb17-44"></a>        <span class="op">&lt;</span>div className<span class="op">=</span><span class="st">&quot;flex justify-items-start space-x-2&quot;</span><span class="op">&gt;</span></span>
<span id="cb17-45"><a href="#cb17-45"></a>          <span class="op">&lt;</span>div<span class="op">&gt;</span></span>
<span id="cb17-46"><a href="#cb17-46"></a>            <span class="op">&lt;</span>FontAwesomeIcon</span>
<span id="cb17-47"><a href="#cb17-47"></a>              icon<span class="op">=</span>{faGear}</span>
<span id="cb17-48"><a href="#cb17-48"></a>              className<span class="op">=</span><span class="st">&quot;animate-spin text-2xl [animation-duration:2s]&quot;</span></span>
<span id="cb17-49"><a href="#cb17-49"></a>            <span class="op">/&gt;</span></span>
<span id="cb17-50"><a href="#cb17-50"></a>          <span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb17-51"><a href="#cb17-51"></a>          {[<span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>]<span class="op">.</span><span class="fu">map</span>((i) <span class="kw">=&gt;</span> (</span>
<span id="cb17-52"><a href="#cb17-52"></a>            <span class="op">&lt;</span>div key<span class="op">=</span>{i}<span class="op">&gt;</span></span>
<span id="cb17-53"><a href="#cb17-53"></a>              <span class="op">&lt;</span>input</span>
<span id="cb17-54"><a href="#cb17-54"></a>                id<span class="op">=</span>{<span class="vs">`cb-</span><span class="sc">${</span>i<span class="sc">}</span><span class="vs">`</span>}</span>
<span id="cb17-55"><a href="#cb17-55"></a>                <span class="kw">type</span><span class="op">=</span><span class="st">&quot;checkbox&quot;</span></span>
<span id="cb17-56"><a href="#cb17-56"></a>                className<span class="op">=</span><span class="st">&quot;mr-1&quot;</span></span>
<span id="cb17-57"><a href="#cb17-57"></a>                defaultChecked<span class="op">=</span>{i <span class="op">===</span> <span class="dv">1</span>}</span>
<span id="cb17-58"><a href="#cb17-58"></a>              <span class="op">/&gt;</span></span>
<span id="cb17-59"><a href="#cb17-59"></a>              <span class="op">&lt;</span>label htmlFor<span class="op">=</span>{<span class="vs">`cb-</span><span class="sc">${</span>i<span class="sc">}</span><span class="vs">`</span>} className<span class="op">=</span><span class="st">&quot;font-bold&quot;</span><span class="op">&gt;</span></span>
<span id="cb17-60"><a href="#cb17-60"></a>                項目{i}</span>
<span id="cb17-61"><a href="#cb17-61"></a>              <span class="op">&lt;/</span>label<span class="op">&gt;</span></span>
<span id="cb17-62"><a href="#cb17-62"></a>            <span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb17-63"><a href="#cb17-63"></a>          ))}</span>
<span id="cb17-64"><a href="#cb17-64"></a>        <span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb17-65"><a href="#cb17-65"></a>      <span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb17-66"><a href="#cb17-66"></a>    <span class="op">&lt;/</span>main<span class="op">&gt;</span></span>
<span id="cb17-67"><a href="#cb17-67"></a>  )<span class="op">;</span></span>
<span id="cb17-68"><a href="#cb17-68"></a>}<span class="op">;</span></span>
<span id="cb17-69"><a href="#cb17-69"></a></span>
<span id="cb17-70"><a href="#cb17-70"></a><span class="im">export</span> <span class="im">default</span> Page<span class="op">;</span></span></code></pre></div>
      <p><code>/playground/sync</code>
      にアクセスして「<strong>非同期処理の実行</strong>」のボタンを押下してみてください。デベロッパーツールのコンソール出力は次のような結果となったはずです。</p>
      <figure>
      <img src="figs/07/async_01.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>ここで注目してほしいことは、非同期関数
      <code>heavySyncTask(2000);</code>
      の<strong>完了を待たず</strong>に
      <code>syncTask("処理2")</code>、<code>syncTask("処理3")</code>
      が実行されているということです。そして「非同期処理 heavyAsyncTask
      が完了しました」は、<code>heavySyncTask(2000)</code>
      をコールしている <code>asyncProcess</code>
      の実行完了後に出力されています。また、同期処理のときとは違い、「アニメーション」や「チェックボックス操作」がブロックされないことも確認してください。</p>
      <p>ところで、この場合 <code>heavySyncTask()</code>
      の結果に基づいた後続処理をしたい (例えば、戻り値を
      <code>syncTask("処理3")</code> に与えたい)
      ときにどうすればよいか、という問題に気づいたでしょうか。現状のままでは、<code>heavySyncTask()</code>
      の完了を待たず、<code>syncTask("処理3")</code>
      は実行されてしまうため、そのような処理ができません。</p>
      <h2 data-number="4.5" id="awaitを用いた非同期処理の完了待機"><span
      class="header-section-number">4.5</span>
      awaitを用いた非同期処理の完了待機</h2>
      <p>非同期関数 <code>heavyAsyncTask</code>
      の完了を待って、そのあとに <code>syncTask("処理3")</code>
      を実行したいときは、次のように <code>async</code> と
      <code>await</code> キーワードを使用して <code>asyncProcess</code>
      を書き換えます。</p>
      <div class="sourceCode" id="cb18"
      data-caption="src/app/playground/async/page.tsx (抜粋)"
      data-startFrom="19"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 18;"><span id="cb18-19"><a href="#cb18-19"></a><span class="kw">const</span> Page<span class="op">:</span> React<span class="op">.</span><span class="at">FC</span> <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb18-20"><a href="#cb18-20"></a>  <span class="kw">const</span> asyncProcess <span class="op">=</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> { <span class="co">// ◀ async キーワードの追加</span></span>
<span id="cb18-21"><a href="#cb18-21"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;関数 asyncProcess を開始&quot;</span>)<span class="op">;</span></span>
<span id="cb18-22"><a href="#cb18-22"></a>    <span class="fu">syncTask</span>(<span class="st">&quot;処理1&quot;</span>)<span class="op">;</span></span>
<span id="cb18-23"><a href="#cb18-23"></a>    <span class="kw">const</span> asyncTask <span class="op">=</span> <span class="fu">heavyAsyncTask</span>(<span class="dv">2000</span>)<span class="op">;</span> <span class="co">// ◀ 変更</span></span>
<span id="cb18-24"><a href="#cb18-24"></a>    <span class="fu">syncTask</span>(<span class="st">&quot;処理2&quot;</span>)<span class="op">;</span></span>
<span id="cb18-25"><a href="#cb18-25"></a>    <span class="kw">const</span> num <span class="op">=</span> <span class="cf">await</span> asyncTask<span class="op">;</span>  <span class="co">// ◀ 変更</span></span>
<span id="cb18-26"><a href="#cb18-26"></a>    <span class="fu">syncTask</span>(<span class="vs">`処理3 num=</span><span class="sc">${</span>num<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span>  <span class="co">// ◀ 変更</span></span>
<span id="cb18-27"><a href="#cb18-27"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;関数 asyncProcess の最後に到達&quot;</span>)<span class="op">;</span></span>
<span id="cb18-28"><a href="#cb18-28"></a>  }<span class="op">;</span></span>
<span id="cb18-29"><a href="#cb18-29"></a><span class="co">// 以下、変更なし </span></span></code></pre></div>
      <p>まずは、実行結果を確認してください。コンソールのログからは、次のように「heavyAsyncTask
      の完了を待って、処理3
      が実行されていること」が確認できるはずです。また、<span
      class="masked">アニメーションやUI応答がブロックされないこと</span>
      もあわせて確認してください。</p>
      <pre><code>関数 asyncProcess を開始
同期処理 処理1 が完了しました
同期処理 処理2 が完了しました
非同期処理 heavyAsyncTask が完了しました
同期処理 処理3 num=1 が完了しました
関数 asyncProcess の最後に到達</code></pre>
      <p>上記の結果から推測できるように、キーワード <code>await</code>
      を使用すると <span class="masked">非同期処理の完了を待機</span>
      できるようになります。この際、<strong>メインスレッドをブロッキングすることなく</strong>、非同期処理が完了するまで現在の関数
      (ここで言えば <code>asyncProcess</code>)
      の実行を一時停止することができます。</p>
      <p>なお、<code>syncTask("処理2")</code>
      も、<code>heavyAsyncTask</code>
      の完了を待ってから実行したい場合、次のように記述することができます。</p>
      <div class="sourceCode" id="cb20"
      data-caption="src/app/playground/async/page.tsx (抜粋)"
      data-startFrom="19"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 18;"><span id="cb20-19"><a href="#cb20-19"></a><span class="kw">const</span> Page<span class="op">:</span> React<span class="op">.</span><span class="at">FC</span> <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb20-20"><a href="#cb20-20"></a>  <span class="kw">const</span> asyncProcess <span class="op">=</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> { <span class="co">// ◀ async キーワードの追加</span></span>
<span id="cb20-21"><a href="#cb20-21"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;関数 asyncProcess を開始&quot;</span>)<span class="op">;</span></span>
<span id="cb20-22"><a href="#cb20-22"></a>    <span class="fu">syncTask</span>(<span class="st">&quot;処理1&quot;</span>)<span class="op">;</span></span>
<span id="cb20-23"><a href="#cb20-23"></a>    <span class="kw">const</span> num <span class="op">=</span> <span class="cf">await</span> <span class="fu">heavyAsyncTask</span>(<span class="dv">2000</span>)<span class="op">;</span> <span class="co">// ◀ 変更</span></span>
<span id="cb20-24"><a href="#cb20-24"></a>    <span class="fu">syncTask</span>(<span class="vs">`処理2 num=</span><span class="sc">${</span>num<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span>  <span class="co">// ◀ 変更</span></span>
<span id="cb20-25"><a href="#cb20-25"></a>    <span class="fu">syncTask</span>(<span class="vs">`処理3 num=</span><span class="sc">${</span>num<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span>  <span class="co">// ◀ 変更</span></span>
<span id="cb20-26"><a href="#cb20-26"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;関数 asyncProcess の最後に到達&quot;</span>)<span class="op">;</span></span>
<span id="cb20-27"><a href="#cb20-27"></a>  }<span class="op">;</span></span>
<span id="cb20-28"><a href="#cb20-28"></a><span class="co">// 以下、変更なし </span></span></code></pre></div>
      <h3 data-number="4.5.1" id="演習-10分"><span
      class="header-section-number">4.5.1</span> 演習
      (<i class="fa-solid fa-stopwatch"></i> 10分)</h3>
      <p><code>await</code> は、<code>async</code>
      キーワードをつけた関数のなかでのみ使用できます。<strong>20行目</strong>
      の <code>async</code>
      キーワードを削除すると、どのようなエラーが発生するか確認してください。</p>
      <h2 data-number="4.6"
      id="改めて郵便番号検索apiの利用処理を確認"><span
      class="header-section-number">4.6</span>
      改めて郵便番号検索APIの利用処理を確認</h2>
      <p>非同期処理について概要が理解できたところで、<strong>郵便番号検索APIからデータを取得する処理</strong>
      について改めてプログラムを確認していきます。</p>
      <div class="sourceCode" id="cb21"
      data-caption="src/app/playground/zip-code/[code]/page.tsx (再掲・抜粋)"
      data-startFrom="10"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 9;"><span id="cb21-10"><a href="#cb21-10"></a><span class="fu">useEffect</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb21-11"><a href="#cb21-11"></a>  <span class="kw">const</span> fetchAddressFromZipCode  <span class="op">=</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb21-12"><a href="#cb21-12"></a>    <span class="co">// ウェブAPIにGETリクエストを送信してレスポンスを取得</span></span>
<span id="cb21-13"><a href="#cb21-13"></a>    <span class="kw">const</span> requestUrl <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>endpoint<span class="sc">}</span><span class="vs">?zipcode=</span><span class="sc">${</span>code<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb21-14"><a href="#cb21-14"></a>    <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(requestUrl<span class="op">,</span> { <span class="co">// ◀◀ 注目</span></span>
<span id="cb21-15"><a href="#cb21-15"></a>      method<span class="op">:</span> <span class="st">&quot;GET&quot;</span><span class="op">,</span></span>
<span id="cb21-16"><a href="#cb21-16"></a>      cache<span class="op">:</span> <span class="st">&quot;no-store&quot;</span><span class="op">,</span> <span class="co">// キャッシュを利用しない</span></span>
<span id="cb21-17"><a href="#cb21-17"></a>    })<span class="op">;</span></span>
<span id="cb21-18"><a href="#cb21-18"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&quot;ウェブAPIからデータを取得しました&quot;</span>)<span class="op">;</span></span>
<span id="cb21-19"><a href="#cb21-19"></a></span>
<span id="cb21-20"><a href="#cb21-20"></a>    <span class="co">// レスポンスからJSON形式でデータ取得して整形して表示</span></span>
<span id="cb21-21"><a href="#cb21-21"></a>    <span class="kw">const</span> parsedData <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span> <span class="co">// ◀◀ 注目</span></span>
<span id="cb21-22"><a href="#cb21-22"></a>    <span class="fu">setResponse</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(parsedData<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></span>
<span id="cb21-23"><a href="#cb21-23"></a>  }<span class="op">;</span></span>
<span id="cb21-24"><a href="#cb21-24"></a></span>
<span id="cb21-25"><a href="#cb21-25"></a>  <span class="fu">fetchAddressFromZipCode</span> ()<span class="op">;</span> <span class="co">// 関数を実行</span></span>
<span id="cb21-26"><a href="#cb21-26"></a>}<span class="op">,</span> [code])<span class="op">;</span></span></code></pre></div>
      <ul>
      <li><p><strong>第11行目</strong> で <code>async</code>
      キーワードを付けているのは、その内部で <code>await</code>
      を使用するためです。</p></li>
      <li><p><strong>第14行目</strong> で <code>await fetch (...)</code>
      としているのは <code>fetch</code>
      が「<strong>非同期処理</strong>」であり、なおかつ、その完了を待ってから
      <strong>第18行目</strong> を実行したいためです。</p></li>
      <li><p><strong>第18行目</strong> で
      <code>await response.json()</code>
      としているのは、<code>json()</code>
      メソッドが「<strong>非同期処理</strong>」で実装されており、<span
      class="masked">その完了を待って (=その「戻り値」を使って)
      後続の<code>setResponse</code>を実行したいため</span>
      です。</p></li>
      </ul>
      <p>なお、<code>json()</code> メソッドは
      HTTP/HTTPSレスポンスのボディ部が<strong>JSONフォーマットであることを前提に</strong>オブジェクトへの変換を行います。関数やメソッドが「<strong>非同期処理かどうか</strong>」は、VSCodeのエディタ上でカーソルをあわせて表示されるツールチップで、その関数/メソッドの「戻り値」が
      <code>Promise&lt;...&gt;</code> であるかで判断できます。</p>
      <figure>
      <img src="figs/07/async_02.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>最後に、<strong>第11行目</strong> で
      <code>fetchAddressFromZipCode</code>
      をアロー関数形式で定義して、それを <strong>第25行目</strong>
      でコールするという (面倒な) 手続きをしているのは、<span
      class="masked">useEffect
      のなかには、非同期処理を直接書くことができない</span>
      という仕様のためです。</p>
      <h3 data-number="4.6.1" id="演習-5分-1"><span
      class="header-section-number">4.6.1</span> 演習
      (<i class="fa-solid fa-stopwatch"></i> 5分)</h3>
      <p>次のように <code>useEffect</code>
      の第1引数として、<code>async</code>
      キーワードを使った非同期関数を与えると、どのような警告やエラーが発生するか確認してください。</p>
      <div class="sourceCode" id="cb22"
      data-caption="useEffectに非同期処理を直接記述できない"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb22-1"><a href="#cb22-1"></a><span class="fu">useEffect</span>(<span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb22-2"><a href="#cb22-2"></a>  <span class="co">// ウェブAPIにGETリクエストを送信してレスポンスを取得</span></span>
<span id="cb22-3"><a href="#cb22-3"></a>  <span class="kw">const</span> requestUrl <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>endpoint<span class="sc">}</span><span class="vs">?zipcode=</span><span class="sc">${</span>code<span class="sc">}</span><span class="vs">`</span><span class="op">;</span></span>
<span id="cb22-4"><a href="#cb22-4"></a>  <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(requestUrl<span class="op">,</span> {</span>
<span id="cb22-5"><a href="#cb22-5"></a>    method<span class="op">:</span> <span class="st">&quot;GET&quot;</span><span class="op">,</span></span>
<span id="cb22-6"><a href="#cb22-6"></a>    cache<span class="op">:</span> <span class="st">&quot;no-store&quot;</span><span class="op">,</span> <span class="co">// キャッシュを利用しない</span></span>
<span id="cb22-7"><a href="#cb22-7"></a>  })<span class="op">;</span></span>
<span id="cb22-8"><a href="#cb22-8"></a></span>
<span id="cb22-9"><a href="#cb22-9"></a>  <span class="co">// レスポンスからJSON形式でデータ取得して整形して表示</span></span>
<span id="cb22-10"><a href="#cb22-10"></a>  <span class="kw">const</span> parsedData <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb22-11"><a href="#cb22-11"></a>  <span class="fu">setResponse</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(parsedData<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></span>
<span id="cb22-12"><a href="#cb22-12"></a>}<span class="op">,</span> [code])<span class="op">;</span></span></code></pre></div>
      <h1 data-number="5" id="ブログ記事のデータをウェブから取得"><span
      class="header-section-number">5</span>
      ブログ記事のデータをウェブから取得</h1>
      <p>ウェブAPIからJSONフォーマットのデータを取得し、それをオブジェクトに変換する処理について学んだので、これをブログアプリに適用してみたいと思います。ブログ記事の一覧がJSONフォーマットで取得可能なエンドポイントとして、以下を用意したので、これを利用してきます。</p>
      <ul>
      <li><a
      href="https://w1980.blob.core.windows.net/pg3/posts.json">https://w1980.blob.core.windows.net/pg3/posts.json</a></li>
      </ul>
      <p>まずは、ブラウザからアクセスしてJSON形式で記事データが取得可能なことを確認してください。こちらには「投稿4」が追加されています。</p>
      <figure>
      <img src="figs/07/app_06.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>トップページ (<code>src/app/page.tsx</code>)
      の実装を次のように変更して、ウェブから記事が取得することができることを確認してください。基本的には、ここまでに学んできたことの組み合わせになります。</p>
      <div class="sourceCode" id="cb23"
      data-caption="src/app/page.tsx (ウェブから記事を取得)"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb23-1"><a href="#cb23-1"></a><span class="st">&quot;use client&quot;</span><span class="op">;</span></span>
<span id="cb23-2"><a href="#cb23-2"></a><span class="im">import</span> { useState<span class="op">,</span> useEffect } <span class="im">from</span> <span class="st">&quot;react&quot;</span><span class="op">;</span></span>
<span id="cb23-3"><a href="#cb23-3"></a><span class="im">import</span> <span class="im">type</span> { Post } <span class="im">from</span> <span class="st">&quot;@/app/_types/Post&quot;</span><span class="op">;</span></span>
<span id="cb23-4"><a href="#cb23-4"></a><span class="im">import</span> PostSummary <span class="im">from</span> <span class="st">&quot;@/app/_components/PostSummary&quot;</span><span class="op">;</span></span>
<span id="cb23-5"><a href="#cb23-5"></a><span class="im">import</span> { FontAwesomeIcon } <span class="im">from</span> <span class="st">&quot;@fortawesome/react-fontawesome&quot;</span><span class="op">;</span></span>
<span id="cb23-6"><a href="#cb23-6"></a><span class="im">import</span> { faSpinner } <span class="im">from</span> <span class="st">&quot;@fortawesome/free-solid-svg-icons&quot;</span><span class="op">;</span></span>
<span id="cb23-7"><a href="#cb23-7"></a></span>
<span id="cb23-8"><a href="#cb23-8"></a><span class="kw">const</span> Page<span class="op">:</span> React<span class="op">.</span><span class="at">FC</span> <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb23-9"><a href="#cb23-9"></a>  <span class="kw">const</span> [posts<span class="op">,</span> setPosts] <span class="op">=</span> <span class="fu">useState</span><span class="op">&lt;</span>Post[] <span class="op">|</span> <span class="dt">null</span><span class="op">&gt;</span>(<span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb23-10"><a href="#cb23-10"></a>  <span class="kw">const</span> [fetchError<span class="op">,</span> setFetchError] <span class="op">=</span> <span class="fu">useState</span><span class="op">&lt;</span><span class="dt">string</span> <span class="op">|</span> <span class="dt">null</span><span class="op">&gt;</span>(<span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb23-11"><a href="#cb23-11"></a></span>
<span id="cb23-12"><a href="#cb23-12"></a>  <span class="fu">useEffect</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb23-13"><a href="#cb23-13"></a>    <span class="kw">const</span> fetchPosts <span class="op">=</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb23-14"><a href="#cb23-14"></a>      <span class="cf">try</span> {</span>
<span id="cb23-15"><a href="#cb23-15"></a>        <span class="kw">const</span> requestUrl <span class="op">=</span> <span class="st">&quot;https://w1980.blob.core.windows.net/pg3/posts.json&quot;</span><span class="op">;</span></span>
<span id="cb23-16"><a href="#cb23-16"></a>        <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(requestUrl<span class="op">,</span> {</span>
<span id="cb23-17"><a href="#cb23-17"></a>          method<span class="op">:</span> <span class="st">&quot;GET&quot;</span><span class="op">,</span></span>
<span id="cb23-18"><a href="#cb23-18"></a>          cache<span class="op">:</span> <span class="st">&quot;no-store&quot;</span><span class="op">,</span> <span class="co">// キャッシュを利用しない</span></span>
<span id="cb23-19"><a href="#cb23-19"></a>        })<span class="op">;</span></span>
<span id="cb23-20"><a href="#cb23-20"></a>        <span class="cf">if</span> (<span class="op">!</span>response<span class="op">.</span><span class="at">ok</span>) {</span>
<span id="cb23-21"><a href="#cb23-21"></a>          <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&quot;データの取得に失敗しました&quot;</span>)<span class="op">;</span></span>
<span id="cb23-22"><a href="#cb23-22"></a>        }</span>
<span id="cb23-23"><a href="#cb23-23"></a>        <span class="kw">const</span> data <span class="op">=</span> (<span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()) <span class="im">as</span> Post[]<span class="op">;</span></span>
<span id="cb23-24"><a href="#cb23-24"></a>        <span class="fu">setPosts</span>(data)<span class="op">;</span></span>
<span id="cb23-25"><a href="#cb23-25"></a>      } <span class="cf">catch</span> (e) {</span>
<span id="cb23-26"><a href="#cb23-26"></a>        <span class="fu">setFetchError</span>(</span>
<span id="cb23-27"><a href="#cb23-27"></a>          e <span class="kw">instanceof</span> <span class="bu">Error</span> <span class="op">?</span> e<span class="op">.</span><span class="at">message</span> <span class="op">:</span> <span class="st">&quot;予期せぬエラーが発生しました&quot;</span></span>
<span id="cb23-28"><a href="#cb23-28"></a>        )<span class="op">;</span></span>
<span id="cb23-29"><a href="#cb23-29"></a>      }</span>
<span id="cb23-30"><a href="#cb23-30"></a>    }<span class="op">;</span></span>
<span id="cb23-31"><a href="#cb23-31"></a>    <span class="fu">fetchPosts</span>()<span class="op">;</span></span>
<span id="cb23-32"><a href="#cb23-32"></a>  }<span class="op">,</span> [])<span class="op">;</span></span>
<span id="cb23-33"><a href="#cb23-33"></a></span>
<span id="cb23-34"><a href="#cb23-34"></a>  <span class="cf">if</span> (fetchError) {</span>
<span id="cb23-35"><a href="#cb23-35"></a>    <span class="cf">return</span> <span class="op">&lt;</span>div<span class="op">&gt;</span>{fetchError}<span class="op">&lt;/</span>div<span class="op">&gt;;</span></span>
<span id="cb23-36"><a href="#cb23-36"></a>  }</span>
<span id="cb23-37"><a href="#cb23-37"></a></span>
<span id="cb23-38"><a href="#cb23-38"></a>  <span class="cf">if</span> (<span class="op">!</span>posts) {</span>
<span id="cb23-39"><a href="#cb23-39"></a>    <span class="cf">return</span> (</span>
<span id="cb23-40"><a href="#cb23-40"></a>      <span class="op">&lt;</span>div className<span class="op">=</span><span class="st">&quot;text-gray-500&quot;</span><span class="op">&gt;</span></span>
<span id="cb23-41"><a href="#cb23-41"></a>        <span class="op">&lt;</span>FontAwesomeIcon icon<span class="op">=</span>{faSpinner} className<span class="op">=</span><span class="st">&quot;mr-1 animate-spin&quot;</span> <span class="op">/&gt;</span></span>
<span id="cb23-42"><a href="#cb23-42"></a>        Loading<span class="op">...</span></span>
<span id="cb23-43"><a href="#cb23-43"></a>      <span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb23-44"><a href="#cb23-44"></a>    )<span class="op">;</span></span>
<span id="cb23-45"><a href="#cb23-45"></a>  }</span>
<span id="cb23-46"><a href="#cb23-46"></a></span>
<span id="cb23-47"><a href="#cb23-47"></a>  <span class="cf">return</span> (</span>
<span id="cb23-48"><a href="#cb23-48"></a>    <span class="op">&lt;</span>main<span class="op">&gt;</span></span>
<span id="cb23-49"><a href="#cb23-49"></a>      <span class="op">&lt;</span>div className<span class="op">=</span><span class="st">&quot;mb-2 text-2xl font-bold&quot;</span><span class="op">&gt;</span>Main<span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb23-50"><a href="#cb23-50"></a>      <span class="op">&lt;</span>div className<span class="op">=</span><span class="st">&quot;space-y-3&quot;</span><span class="op">&gt;</span></span>
<span id="cb23-51"><a href="#cb23-51"></a>        {posts<span class="op">.</span><span class="fu">map</span>((post) <span class="kw">=&gt;</span> (</span>
<span id="cb23-52"><a href="#cb23-52"></a>          <span class="op">&lt;</span>PostSummary key<span class="op">=</span>{post<span class="op">.</span><span class="at">id</span>} post<span class="op">=</span>{post} <span class="op">/&gt;</span></span>
<span id="cb23-53"><a href="#cb23-53"></a>        ))}</span>
<span id="cb23-54"><a href="#cb23-54"></a>      <span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb23-55"><a href="#cb23-55"></a>    <span class="op">&lt;/</span>main<span class="op">&gt;</span></span>
<span id="cb23-56"><a href="#cb23-56"></a>  )<span class="op">;</span></span>
<span id="cb23-57"><a href="#cb23-57"></a>}<span class="op">;</span></span>
<span id="cb23-58"><a href="#cb23-58"></a></span>
<span id="cb23-59"><a href="#cb23-59"></a><span class="im">export</span> <span class="im">default</span> Page<span class="op">;</span></span></code></pre></div>
      <p>実行すると次のような結果が得られると思います。</p>
      <figure>
      <img src="figs/07/app_07.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>ここまでの実装で、このブログアプリに<strong>「閲覧者」としてアクセスしたとき</strong>のフロントエンド処理の本質な実装の<strong>概ね完了</strong>したことなります
      (ただし<strong>「投稿者」としてアクセスしたとき</strong>のフロントエンドは、まだ実装できていません)。</p>
      <h1 data-number="6"
      id="microcmsを利用したバックエンドの構築"><span
      class="header-section-number">6</span>
      microCMSを利用したバックエンドの構築</h1>
      <p>フロントエンド開発が一段落したので、次回の後期中間試験明けの講義からは
      <span class="masked">Next.js を利用したバックエンド開発</span>
      を進めていきます。しかし、それに先立ってバックエンドの「役割」や「機能」について理解するために、ヘッドレスCMS
      である <a href="https://microcms.io/">microCMS</a>
      を使って、このブログアプリのバックエンド部分を構築してみたいと思います。</p>
      <p>CMS とは <span class="masked">Content Management System</span>
      の頭文字をとったもので、ウェブを使ってコンテンツの作成・管理・公開ができるようなシステムを指します。用途によって、ウェブサイト構築用のCMS
      (<a
      href="https://www.google.com/search?q=wordpressとは">WordPress</a>が超有名!!)、教育用のCMS
      (Moodle や GoogleClassroom) 、コンテンツ共有プラットフォーム (<a
      href="https://note.com/">note</a>、<a
      href="https://qiita.com/">Qiita</a>、各種Wiki、各種ブログ)
      などに分類できます。いずれも通常の利用範囲では<strong>プログラミングの知識は不要</strong>で、また<strong>専用ソフトも不要</strong>という特徴があります。</p>
      <p>このなかで <strong>ヘッドレスCMS</strong> (Headless CMS)
      とは、コンテンツの「<strong>公開</strong>」や「<strong>閲覧</strong>」に関する部分について<strong>ビューやUIなどのフロントエンド機能</strong>を提供しないタイプのCMS、つまり
      <span
      class="masked">コンテンツの閲覧・公開機能がAPIだけで提供</span>
      されるCMSと言えます。</p>
      <p><a
      href="https://microcms.io/">microCMS</a>は、このようなヘッドレスCMSに分類されるサービスになります。microCMS
      を利用すると、次のように
      <strong>「ブログ投稿者」としての投稿記事の作成や編集</strong> は
      microCMSのサイトで行なって、<strong>「閲覧者」としての投稿記事の取得</strong>
      はウェブAPIで行ない ビュー や UI は React
      を使って自分で自由にデザイン・実装するという使い方になります。</p>
      <figure>
      <img src="figs/07/cms_00.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>皆さんには、後期中間試験後にバックエンドについても Next.js
      で実装してもらいますが、<a
      href="https://microcms.io/">microCMS</a>などのヘッドレスCMSと連携すれば、現段階の実装でもブログアプリとして実用的な機能を持ってリリースすることができます。</p>
      <h2 data-number="6.1" id="microcmsの利用準備"><span
      class="header-section-number">6.1</span> microCMSの利用準備</h2>
      <p><a
      href="https://microcms.io/">microCMS</a>を利用するための準備を行なっていきます。まずは<a
      href="https://microcms.io/">microCMS</a>にアクセスしてユーザ登録をしてください。クレジットカードの登録などは不要で、無料で登録することができます。</p>
      <p>登録完了後、ログインして<strong>サービス管理画面</strong> (<a
      href="https://app.microcms.io/">https://app.microcms.io/</a>)
      に移動してください。</p>
      <p>ブログ記事のコンテンツの作成・管理・公開のサービスを作成していきます。画面内の「<strong>＋追加</strong>」を押下してください。</p>
      <figure>
      <img src="figs/07/cms_01.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>「<strong>1から作成する</strong>」を選択してください。</p>
      <figure>
      <img src="figs/07/cms_02.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>サービス情報として「サービス名」と「サービスID」を設定します。サービスIDについては、他のユーザが既に使用しているIDは使用できません。サービスIDは、基本的には表側にはでてこない値になるので、デフォルト値をそのまま使用することを推奨します。</p>
      <figure>
      <img src="figs/07/cms_03.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>「<strong>サービスにアクセスする</strong>」のボタンを押下してください。</p>
      <figure>
      <img src="figs/07/cms_04.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>サービスのトップページ
      (<code>https://(サービスID).microcms.io/</code>)
      に移動したら、左パネルの「<strong>コンテンツ
      (API)</strong>」の右隣の「<strong>＋</strong>」を押下してください。さらに「<strong>自分で決める</strong>」を選択してください。</p>
      <figure>
      <img src="figs/07/cms_05.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>API管理用の名前 (<strong>API名</strong>)
      と、そのAPIを利用するための<strong>エンドポイント</strong> (URL)
      を設定します。ここでは「<strong>ブログ記事の一覧を取得するためのAPI</strong>」を作成するので、エンドポイントは
      <code>posts</code> に設定します。</p>
      <figure>
      <img src="figs/07/cms_06.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>記事の「<strong>一覧</strong>」を取得するためのAPIを作成するので「<strong>リスト形式</strong>」を選択します。</p>
      <figure>
      <img src="figs/07/cms_07.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>次のようにAPIのスキーマ (構造) を定義します。これは
      <code>src/app/_types/Post.ts</code>
      で定義した<strong>「Post型」に対応させるように設定</strong>していきます。なお、画面上で説明されているように
      <code>id</code> や <code>createdAt</code>
      は自動的に作成されるので、ここで項目をつくる必要はありません。</p>
      <p>また、カテゴリ (<code>categories</code>)
      については、あとから追加します。</p>
      <figure>
      <img src="figs/07/cms_08.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>以上のAPIのスキーマ (構造) の設定で、利用準備が整いました。</p>
      <h2 data-number="6.2" id="microcmsにコンテンツを追加"><span
      class="header-section-number">6.2</span>
      microCMSにコンテンツを追加</h2>
      <p>ここからは、microCMSに
      <strong>コンテンツ</strong>、つまり、<strong>ブログの投稿記事</strong>
      を追加していきます。次のように「<strong>ブログ記事</strong>」を選択して「<strong>＋追加</strong>」を押下してください。</p>
      <figure>
      <img src="figs/07/cms_09.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>APIのスキーマ (構造) で設定した項目
      (=タイトル、本文、カバーイメージ)
      の入力フォームが表示されるので、自由にコンテンツを作成してください
      (見本のとおりに入力する必要はありません)。</p>
      <p>画像も自由に設定してください
      (画像のアスペクト比も特に気にする必要はありません)。適当な画像がなければ<a
      href="https://w1980.blob.core.windows.net/pg3/cover-img-purple.jpg">こちら</a>を利用してください。</p>
      <p>入力が完了したら右上の「<strong>公開</strong>」のボタンを押下してください。</p>
      <figure>
      <img src="figs/07/cms_10.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>ダイアログの「<strong>APIプレビューを開く</strong>」のボタンを押下してください。</p>
      <figure>
      <img src="figs/07/cms_11.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>APIプレビューの画面は、次の操作でも開くことができます。</p>
      <figure>
      <img src="figs/07/cms_12.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>APIプレビューでは、このブログ記事の一覧を取得するためのAPIのエンドポイント
      (URL) と、認証のためにHTTPリクエストの <strong>Header</strong>
      に付加しなければならない <code>X-MICROCMS-API-KEY</code>
      の値が表示されます。基本的には <code>X-MICROCMS-API-KEY</code>
      はオープンにすべき値ではないので注意してください
      (とはいえ、フロントエンドからHTTPリクエストを送るので、ちょっと工夫すれば覗けてしまう値ですが…)。</p>
      <figure>
      <img src="figs/07/cms_13.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <h2 data-number="6.3" id="apiの利用テスト"><span
      class="header-section-number">6.3</span> APIの利用テスト</h2>
      <p>記事取得のためのAPIのテストをしてきます。</p>
      <p>microCMS の API を利用するために、HTTPリクエストの
      <strong>Header に</strong> <code>X-MICROCMS-API-KEY</code>
      <strong>でAPIキーを設定する必要があるため</strong>、ブラウザのアドレバーにエンドポイントを入力してAPIの応答をテストすることはできません。</p>
      <p>実際にエンドポイントを入力してみると、以下のような応答となってしまいます。</p>
      <figure>
      <img src="figs/07/vscode_03.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>ウェブAPIのテストをするためのツールは<a
      href="https://www.google.com/search?q=curl+api">curl</a>や<a
      href="https://www.postman.com/">Postman</a>など様々なものがありますが、ここでは
      VSCode の Thunder Client (識別子
      <code>rangav.vscode-thunder-client</code> )
      という拡張機能を利用していきます。</p>
      <figure>
      <img src="figs/07/vscode_04.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>上記の拡張機能をインストールしてください。インストールが完了するとVSCodeの左パネルに「⚡」のアイコンが表れるのでそれをクリックするか、<code>Ctrl+Shift+R</code>
      を押下すると Thunder Client
      のパネルが表示されるので、「<strong>New
      Request</strong>」のボタンを押下してください。</p>
      <figure>
      <img src="figs/07/vscode_05.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>そして、次のようにエンドポイント
      (<code>https://[ServiceID].microcms.io/api/v1/posts/</code>) と
      Header に <code>X-MICROCMS-API-KEY</code>
      を設定して「<strong>Send</strong>」を押下するとウェブAPIのテストができます。レスポンスの「ステータス」が
      <strong>200番台</strong> となれば成功です。</p>
      <figure>
      <img src="figs/07/vscode_06.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>レスポンスは、次のようなJSONフォーマットのデータになっていることを確認してください。特に
      <span class="masked"><code>contents</code> が <code>Posts[]</code>
      に対応する値</span> になっていることに注意してください
      (あとで利用することになります)。</p>
      <div class="sourceCode" id="cb24"
      data-caption="/api/v1/posts/ のレスポンス"><pre
      class="sourceCode numberSource json numberLines"><code class="sourceCode json"><span id="cb24-1"><a href="#cb24-1"></a><span class="fu">{</span></span>
<span id="cb24-2"><a href="#cb24-2"></a>  <span class="dt">&quot;contents&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb24-3"><a href="#cb24-3"></a>    <span class="fu">{</span></span>
<span id="cb24-4"><a href="#cb24-4"></a>      <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;3x24sup0aq26&quot;</span><span class="fu">,</span></span>
<span id="cb24-5"><a href="#cb24-5"></a>      <span class="dt">&quot;createdAt&quot;</span><span class="fu">:</span> <span class="st">&quot;2024-11-14T09:34:17.968Z&quot;</span><span class="fu">,</span></span>
<span id="cb24-6"><a href="#cb24-6"></a>      <span class="dt">&quot;updatedAt&quot;</span><span class="fu">:</span> <span class="st">&quot;2024-11-14T09:43:00.987Z&quot;</span><span class="fu">,</span></span>
<span id="cb24-7"><a href="#cb24-7"></a>      <span class="dt">&quot;publishedAt&quot;</span><span class="fu">:</span> <span class="st">&quot;2024-11-14T09:34:17.968Z&quot;</span><span class="fu">,</span></span>
<span id="cb24-8"><a href="#cb24-8"></a>      <span class="dt">&quot;revisedAt&quot;</span><span class="fu">:</span> <span class="st">&quot;2024-11-14T09:43:00.987Z&quot;</span><span class="fu">,</span></span>
<span id="cb24-9"><a href="#cb24-9"></a>      <span class="dt">&quot;title&quot;</span><span class="fu">:</span> <span class="st">&quot;投稿1&quot;</span><span class="fu">,</span></span>
<span id="cb24-10"><a href="#cb24-10"></a>      <span class="dt">&quot;content&quot;</span><span class="fu">:</span> <span class="st">&quot;&lt;p&gt;春はあけぼの。&lt;/p&gt;&lt;p&gt;やうやう白くなりゆく山ぎは、すこしあかりて、紫だちたる雲のほそくたなびきたる。&lt;/p&gt;&quot;</span><span class="fu">,</span></span>
<span id="cb24-11"><a href="#cb24-11"></a>      <span class="dt">&quot;coverImage&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb24-12"><a href="#cb24-12"></a>        <span class="dt">&quot;url&quot;</span><span class="fu">:</span> <span class="st">&quot;https://images.microcms-assets.io/assets/6bec8736dd5f4a2580016eeb10ad0d4a/fc53da3b80344c64b724ca00a70007c9/cover-img-purple.jpg&quot;</span><span class="fu">,</span></span>
<span id="cb24-13"><a href="#cb24-13"></a>        <span class="dt">&quot;height&quot;</span><span class="fu">:</span> <span class="dv">768</span><span class="fu">,</span></span>
<span id="cb24-14"><a href="#cb24-14"></a>        <span class="dt">&quot;width&quot;</span><span class="fu">:</span> <span class="dv">1365</span></span>
<span id="cb24-15"><a href="#cb24-15"></a>      <span class="fu">}</span></span>
<span id="cb24-16"><a href="#cb24-16"></a>    <span class="fu">}</span></span>
<span id="cb24-17"><a href="#cb24-17"></a>  <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb24-18"><a href="#cb24-18"></a>  <span class="dt">&quot;totalCount&quot;</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb24-19"><a href="#cb24-19"></a>  <span class="dt">&quot;offset&quot;</span><span class="fu">:</span> <span class="dv">0</span><span class="fu">,</span></span>
<span id="cb24-20"><a href="#cb24-20"></a>  <span class="dt">&quot;limit&quot;</span><span class="fu">:</span> <span class="dv">10</span></span>
<span id="cb24-21"><a href="#cb24-21"></a><span class="fu">}</span></span></code></pre></div>
      <p>なお、このレスポンスから、microCMSにアップロードした画像は
      <code>https://images.microcms-assets.io/assets/...</code>
      に配置されることが分かります。この画像は、カバーイメージとして記事詳細のページのなかで読み込む予定なので
      <code>next.config.mjs</code>
      のなかに「<strong>画像読込みを許可するサイト</strong>」として
      <code>images.microcms-assets.io</code>
      を追加しておいてください。</p>
      <div class="sourceCode" id="cb25"
      data-caption="next.config.mjs (画像読込み許可サイトの追加)"><pre
      class="sourceCode numberSource js numberLines"><code class="sourceCode javascript"><span id="cb25-1"><a href="#cb25-1"></a><span class="co">/** </span><span class="an">@type</span><span class="co"> {import(&#39;next&#39;).NextConfig} */</span></span>
<span id="cb25-2"><a href="#cb25-2"></a><span class="kw">const</span> nextConfig <span class="op">=</span> {</span>
<span id="cb25-3"><a href="#cb25-3"></a>  <span class="dt">images</span><span class="op">:</span> {</span>
<span id="cb25-4"><a href="#cb25-4"></a>    <span class="dt">remotePatterns</span><span class="op">:</span> [</span>
<span id="cb25-5"><a href="#cb25-5"></a>      {</span>
<span id="cb25-6"><a href="#cb25-6"></a>        <span class="dt">protocol</span><span class="op">:</span> <span class="st">&quot;https&quot;</span><span class="op">,</span></span>
<span id="cb25-7"><a href="#cb25-7"></a>        <span class="dt">hostname</span><span class="op">:</span> <span class="st">&quot;w1980.blob.core.windows.net&quot;</span><span class="op">,</span></span>
<span id="cb25-8"><a href="#cb25-8"></a>      }<span class="op">,</span></span>
<span id="cb25-9"><a href="#cb25-9"></a>      { <span class="dt">protocol</span><span class="op">:</span> <span class="st">&quot;https&quot;</span><span class="op">,</span> <span class="dt">hostname</span><span class="op">:</span> <span class="st">&quot;placehold.jp&quot;</span> }<span class="op">,</span></span>
<span id="cb25-10"><a href="#cb25-10"></a>      { <span class="dt">protocol</span><span class="op">:</span> <span class="st">&quot;https&quot;</span><span class="op">,</span> <span class="dt">hostname</span><span class="op">:</span> <span class="st">&quot;images.microcms-assets.io&quot;</span> }<span class="op">,</span></span>
<span id="cb25-11"><a href="#cb25-11"></a>    ]<span class="op">,</span></span>
<span id="cb25-12"><a href="#cb25-12"></a>  }<span class="op">,</span></span>
<span id="cb25-13"><a href="#cb25-13"></a>}<span class="op">;</span></span>
<span id="cb25-14"><a href="#cb25-14"></a></span>
<span id="cb25-15"><a href="#cb25-15"></a><span class="im">export</span> <span class="im">default</span> nextConfig<span class="op">;</span></span></code></pre></div>
      <p><strong>Thunder Client</strong>
      では、以下の操作でリクエストに名前を付けることができます。「投稿記事一覧の取得
      (microCMS)」のように変更しておくと、あとから探しやすくなります
      (再度、APIをテストするときに便利です)。</p>
      <figure>
      <img src="figs/07/vscode_07.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <h3 data-number="6.3.1" id="演習-5分-2"><span
      class="header-section-number">6.3.1</span> 演習
      (<i class="fa-solid fa-stopwatch"></i> 5分)</h3>
      <p><strong>Thunder Client</strong> で、エンドポイントを
      <code>https://[ServiceID].microcms.io/api/v1/posts/[投稿記事のid]</code>
      として「<strong>投稿記事 (単体)
      のデータ</strong>」を取得することを確認してください。<code>[投稿記事のid]</code>
      は、投稿記事一覧から取得してください。</p>
      <h2 data-number="6.4" id="カテゴリの追加"><span
      class="header-section-number">6.4</span> カテゴリの追加</h2>
      <p>つづいて「カテゴリ」を作成して、さきほどの「<strong>ブログ記事</strong>」の属性として設定できるようにしていきます。「<strong>コンテンツAPI</strong>」の右隣りの「<strong>＋</strong>」を押下してください。</p>
      <figure>
      <img src="figs/07/cms_14.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>次のように設定してください。投稿記事のときもそうでしたが、データの配列を取得するエンドポイントは
      <code>categories</code> のように <strong>複数形</strong>
      にすることが一般的になります。</p>
      <figure>
      <img src="figs/07/cms_15.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>「<strong>リスト形式</strong>」を選択肢してください。</p>
      <figure>
      <img src="figs/07/cms_16.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>次のようにカテゴリAPIのスキーマ (構造) を定義します。これは
      <code>src/app/_types/Category.ts</code>
      で定義した<strong>「Category型」に対応させるように設定</strong>していきます。</p>
      <figure>
      <img src="figs/07/cms_17.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>実際にカテゴリのコンテンツ (<code>TypeScript</code> や
      <code>React</code> など) を追加していきます。</p>
      <figure>
      <img src="figs/07/cms_18.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>とりあえず、2個程度、カテゴリとして設定する値
      (<code>TypeScript</code> や <code>React</code> など)
      を自由に追加してください (作成・公開をしてください)。</p>
      <figure>
      <img src="figs/07/cms_19.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>「<strong>ブログ記事</strong>」の属性として、「<strong>カテゴリ</strong>」を設定できるようにAPIスキーマ
      (構造)
      を変更していきます。画面から「<strong>ブログ記事</strong>」を選択して、「<strong>API設定</strong>」を選択してください。</p>
      <figure>
      <img src="figs/07/cms_20.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>「<strong>APIスキーマ</strong>」を選択して、「<strong>＋フィールドを追加</strong>」を選択してください。</p>
      <figure>
      <img src="figs/07/cms_21.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>次のように設定してください。ひとつの「ブログ記事」に複数個のカテゴリが設定できるように、「<strong>種類</strong>」の設定値は「<strong>複数コンテンツ参照</strong>」としてください。</p>
      <figure>
      <img src="figs/07/cms_22.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>次のような<strong>確認ダイアログ</strong>が表示されるので、画面の指示に従って「<strong>変更する</strong>」を実行してください。</p>
      <figure>
      <img src="figs/07/cms_23.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>以上で設定が完了です。</p>
      <p>作成済みの「ブログ記事」に「カテゴリ」の属性を設定していきます。左パネルの「<strong>ブログ記事</strong>」から、さきほど作成したブログ記事
      (ステータスが「公開中」になっているもの)
      を選択して編集モードに切り替え、次の図のように<strong>カテゴリ</strong>の「<strong>追加</strong>」ボタンを押下してください。</p>
      <figure>
      <img src="figs/07/cms_24.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>任意のカテゴリを選択して、「<strong>公開</strong>」のボタンを押下してください。</p>
      <figure>
      <img src="figs/07/cms_25.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>以上で、ブログ記事にカテゴリが設定できました。</p>
      <p>Thunder Client を使って
      <code>https://[ServiceID].microcms.io/api/v1/posts/</code>
      からデータを取得して、そのデータにカテゴリが含まれていることを確認してください
      (HTTPリクエストの Header に <code>X-MICROCMS-API-KEY</code>
      を設定することを忘れないようにしてください)。</p>
      <h3 data-number="6.4.1" id="演習-5分-3"><span
      class="header-section-number">6.4.1</span> 演習
      (<i class="fa-solid fa-stopwatch"></i> 5分)</h3>
      <p>エンドポイント
      <code>https://[ServiceID].microcms.io/api/v1/categories/</code>
      から「<strong>カテゴリ一覧</strong>」が取得できることを確認してください。</p>
      <h1 data-number="7" id="ブログアプリとmicrocmsの連携"><span
      class="header-section-number">7</span>
      ブログアプリとmicroCMSの連携</h1>
      <p>microCMS (ウェブAPI)
      からブログ記事データを取得し、それを表示するように Next.js
      で開発しているブログアプリを変更していきます。</p>
      <h2 data-number="7.1" id="準備-環境変数の設定"><span
      class="header-section-number">7.1</span> 準備: 環境変数の設定</h2>
      <p>Thunder Client を使って実験したように、microCMS の API
      を利用するためには <span class="masked">「APIキー」</span>
      が必要となります。</p>
      <p>一般に、このような <strong>APIキー</strong> や
      <strong>データベースの接続文字列</strong>、<strong>パスワード</strong>
      などの認証情報をハードコーディングすること (=<span
      class="masked">プログラムのソースコードに直書きすること</span>) は
      <strong>NG行為</strong> となっています。これは Git/GitHub
      のコミット履歴やリポジトリを通じて、<strong>認証情報が意図せず公開されてしまう可能性があるため</strong>
      です。</p>
      <p>先のセクションで取得した APIキー は (設定を変更しない限りは)
      以下のようにブログ記事の <strong>GET (READ) 権限のみ</strong>
      を持つ設定となっているため、大して問題にはなりませんが、<strong>編集や削除といった権限を持ったAPIキー</strong>が流出・漏洩すると不正利用され実害が生じます。</p>
      <figure>
      <img src="figs/07/cms_2_01.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>そこで、一般に認証情報などは <span
      class="masked">環境変数</span>
      に格納して管理することが推奨されています。<strong>環境変数</strong>とは
      OSやシェル環境で設定される変数のことで、プログラムから参照することができます。環境変数を利用する方法には、以下のようなメリットがあります。</p>
      <ol type="1">
      <li><strong>セキュリティの向上</strong>：認証情報をソースコードから分離できる</li>
      <li><strong>柔軟な管理</strong>：開発環境と本番環境で異なる値を設定できる</li>
      <li><strong>安全な共有</strong>：チーム開発時もソースコードのみを共有できる</li>
      </ol>
      <div class="note type-caution">
      <p><strong>注意</strong></p>
      <p>ここでは、<strong>フロントエンドのプログラムで「APIキー」を参照</strong>します。フロントエンドプログラムは<strong>ブラウザで実行されるため</strong>、たとえ環境変数に設定したAPIキーであっても、デベロッパーツールを使うと簡単に値
      (APIキーの文字列) を取得できてしまいます。</p>
      <p>そのため、フロントエンド使用するAPIキーには、<strong>参照 (GET)
      権限のみを付与</strong>し、編集・削除などの権限は与えないように注意してください。逆に言えば、編集・削除などの権限を持ったAPIキーは
      <span class="masked">バックエンドのみで使用</span>
      するようにしてください。</p>
      </div>
      <p>Next.js の開発では環境変数の設定に <code>.env</code>
      ファイルを利用します。このファイルは <code>.gitignore</code>
      に追加し、<strong>Gitによるバージョン管理から除外</strong>します。既に<a
      href="lecture06.html#gitignore">前回講義</a>で
      <code>.gitignore</code> に <code>.env</code>
      を設定済みですが、再度、確認してください。</p>
      <p>確認ができたら、プロジェクトフォルダの直下に <code>.env</code>
      というファイルを作成して、以下の設定を記述して保存してください。<code>XXXXX</code>
      にはサービスID、<code>YYYYY</code> には APIキー を記述してください
      (ダブルクォーテーションで囲む必要はありません)。通常、環境変数は
      <strong>アッパースネークケース</strong> で名前をつけます。</p>
      <p><code>#</code> から始まる行はコメント扱いとなります。<span
      class="masked"><code>=</code>の前後にスペースを入れると予期しない動作</span>
      を引き起こす可能性があります。</p>
      <div class="sourceCode" id="cb26" data-caption=".env"><pre
      class="sourceCode numberSource py numberLines"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1"></a><span class="co"># microCMS</span></span>
<span id="cb26-2"><a href="#cb26-2"></a>NEXT_PUBLIC_MICROCMS_BASE_EP<span class="op">=</span>https:<span class="op">//</span>XXXXX.microcms.io<span class="op">/</span>api<span class="op">/</span>v1</span>
<span id="cb26-3"><a href="#cb26-3"></a>NEXT_PUBLIC_MICROCMS_API_KEY<span class="op">=</span>YYYYY</span></code></pre></div>
      <p>ここでは、<strong>必ず</strong> <code>NEXT_PUBLIC_</code>
      <strong>というプレフィックス</strong>を付けください。<code>NEXT_PUBLIC_</code>
      を付けていない環境変数は、フロントエンドのプログラムでは参照できません。逆に言えば、<span
      class="masked">利用者に知られて困る環境変数</span> には
      <code>NEXT_PUBLIC_</code> を付けないようにしてください。</p>
      <p>なお、環境変数は、プログラムからは次のように参照できます。</p>
      <div class="sourceCode" id="cb27"
      data-caption="環境変数の参照"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb27-1"><a href="#cb27-1"></a><span class="kw">const</span> apiKey <span class="op">=</span> <span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">NEXT_PUBLIC_MICROCMS_API_KEY</span><span class="op">;</span></span></code></pre></div>
      <p>なお、この際、<code>apiKey</code> は
      <code>string | undefined</code> 型になります
      (当該の環境変数が存在しない場合は <code>apiKey</code> は
      <code>undefined</code> となります)。</p>
      <h2 data-number="7.2" id="ブログ記事一覧の表示"><span
      class="header-section-number">7.2</span> ブログ記事一覧の表示</h2>
      <p>microCMS からデータを取得するために
      <code>src/app/page.tsx</code> を次のように変更してください。</p>
      <div class="sourceCode" id="cb28"
      data-caption="src/app/page.tsx (microCMSから)"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb28-1"><a href="#cb28-1"></a><span class="st">&quot;use client&quot;</span><span class="op">;</span></span>
<span id="cb28-2"><a href="#cb28-2"></a><span class="im">import</span> { useState<span class="op">,</span> useEffect } <span class="im">from</span> <span class="st">&quot;react&quot;</span><span class="op">;</span></span>
<span id="cb28-3"><a href="#cb28-3"></a><span class="im">import</span> <span class="im">type</span> { Post } <span class="im">from</span> <span class="st">&quot;@/app/_types/Post&quot;</span><span class="op">;</span></span>
<span id="cb28-4"><a href="#cb28-4"></a><span class="im">import</span> PostSummary <span class="im">from</span> <span class="st">&quot;@/app/_components/PostSummary&quot;</span><span class="op">;</span></span>
<span id="cb28-5"><a href="#cb28-5"></a><span class="im">import</span> { FontAwesomeIcon } <span class="im">from</span> <span class="st">&quot;@fortawesome/react-fontawesome&quot;</span><span class="op">;</span></span>
<span id="cb28-6"><a href="#cb28-6"></a><span class="im">import</span> { faSpinner } <span class="im">from</span> <span class="st">&quot;@fortawesome/free-solid-svg-icons&quot;</span><span class="op">;</span></span>
<span id="cb28-7"><a href="#cb28-7"></a></span>
<span id="cb28-8"><a href="#cb28-8"></a><span class="kw">const</span> Page<span class="op">:</span> React<span class="op">.</span><span class="at">FC</span> <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb28-9"><a href="#cb28-9"></a>  <span class="kw">const</span> [posts<span class="op">,</span> setPosts] <span class="op">=</span> <span class="fu">useState</span><span class="op">&lt;</span>Post[] <span class="op">|</span> <span class="dt">null</span><span class="op">&gt;</span>(<span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb28-10"><a href="#cb28-10"></a>  <span class="kw">const</span> [fetchError<span class="op">,</span> setFetchError] <span class="op">=</span> <span class="fu">useState</span><span class="op">&lt;</span><span class="dt">string</span> <span class="op">|</span> <span class="dt">null</span><span class="op">&gt;</span>(<span class="kw">null</span>)<span class="op">;</span></span>
<span id="cb28-11"><a href="#cb28-11"></a></span>
<span id="cb28-12"><a href="#cb28-12"></a>  <span class="co">// 環境変数から「APIキー」と「エンドポイント」を取得</span></span>
<span id="cb28-13"><a href="#cb28-13"></a>  <span class="kw">const</span> apiBaseEp <span class="op">=</span> <span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">NEXT_PUBLIC_MICROCMS_BASE_EP</span><span class="op">!;</span></span>
<span id="cb28-14"><a href="#cb28-14"></a>  <span class="kw">const</span> apiKey <span class="op">=</span> <span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">NEXT_PUBLIC_MICROCMS_API_KEY</span><span class="op">!;</span></span>
<span id="cb28-15"><a href="#cb28-15"></a></span>
<span id="cb28-16"><a href="#cb28-16"></a>  <span class="fu">useEffect</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb28-17"><a href="#cb28-17"></a>    <span class="kw">const</span> fetchPosts <span class="op">=</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb28-18"><a href="#cb28-18"></a>      <span class="cf">try</span> {</span>
<span id="cb28-19"><a href="#cb28-19"></a>        <span class="co">// microCMS から記事データを取得</span></span>
<span id="cb28-20"><a href="#cb28-20"></a>        <span class="kw">const</span> requestUrl <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span>apiBaseEp<span class="sc">}</span><span class="vs">/posts`</span><span class="op">;</span></span>
<span id="cb28-21"><a href="#cb28-21"></a>        <span class="kw">const</span> response <span class="op">=</span> <span class="cf">await</span> <span class="fu">fetch</span>(requestUrl<span class="op">,</span> {</span>
<span id="cb28-22"><a href="#cb28-22"></a>          method<span class="op">:</span> <span class="st">&quot;GET&quot;</span><span class="op">,</span></span>
<span id="cb28-23"><a href="#cb28-23"></a>          cache<span class="op">:</span> <span class="st">&quot;no-store&quot;</span><span class="op">,</span></span>
<span id="cb28-24"><a href="#cb28-24"></a>          headers<span class="op">:</span> {</span>
<span id="cb28-25"><a href="#cb28-25"></a>            <span class="st">&quot;X-MICROCMS-API-KEY&quot;</span><span class="op">:</span> apiKey<span class="op">,</span></span>
<span id="cb28-26"><a href="#cb28-26"></a>          }<span class="op">,</span></span>
<span id="cb28-27"><a href="#cb28-27"></a>        })<span class="op">;</span></span>
<span id="cb28-28"><a href="#cb28-28"></a>        <span class="cf">if</span> (<span class="op">!</span>response<span class="op">.</span><span class="at">ok</span>) {</span>
<span id="cb28-29"><a href="#cb28-29"></a>          <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&quot;データの取得に失敗しました&quot;</span>)<span class="op">;</span></span>
<span id="cb28-30"><a href="#cb28-30"></a>        }</span>
<span id="cb28-31"><a href="#cb28-31"></a>        <span class="kw">const</span> data <span class="op">=</span> <span class="cf">await</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb28-32"><a href="#cb28-32"></a>        <span class="fu">setPosts</span>(data<span class="op">.</span><span class="at">contents</span> <span class="im">as</span> Post[])<span class="op">;</span></span>
<span id="cb28-33"><a href="#cb28-33"></a>      } <span class="cf">catch</span> (e) {</span>
<span id="cb28-34"><a href="#cb28-34"></a>        <span class="fu">setFetchError</span>(</span>
<span id="cb28-35"><a href="#cb28-35"></a>          e <span class="kw">instanceof</span> <span class="bu">Error</span> <span class="op">?</span> e<span class="op">.</span><span class="at">message</span> <span class="op">:</span> <span class="st">&quot;予期せぬエラーが発生しました&quot;</span></span>
<span id="cb28-36"><a href="#cb28-36"></a>        )<span class="op">;</span></span>
<span id="cb28-37"><a href="#cb28-37"></a>      }</span>
<span id="cb28-38"><a href="#cb28-38"></a>    }<span class="op">;</span></span>
<span id="cb28-39"><a href="#cb28-39"></a>    <span class="fu">fetchPosts</span>()<span class="op">;</span></span>
<span id="cb28-40"><a href="#cb28-40"></a>  }<span class="op">,</span> [apiBaseEp<span class="op">,</span> apiKey])<span class="op">;</span></span>
<span id="cb28-41"><a href="#cb28-41"></a></span>
<span id="cb28-42"><a href="#cb28-42"></a>  <span class="cf">if</span> (fetchError) {</span>
<span id="cb28-43"><a href="#cb28-43"></a>    <span class="cf">return</span> <span class="op">&lt;</span>div<span class="op">&gt;</span>{fetchError}<span class="op">&lt;/</span>div<span class="op">&gt;;</span></span>
<span id="cb28-44"><a href="#cb28-44"></a>  }</span>
<span id="cb28-45"><a href="#cb28-45"></a></span>
<span id="cb28-46"><a href="#cb28-46"></a>  <span class="cf">if</span> (<span class="op">!</span>posts) {</span>
<span id="cb28-47"><a href="#cb28-47"></a>    <span class="cf">return</span> (</span>
<span id="cb28-48"><a href="#cb28-48"></a>      <span class="op">&lt;</span>div className<span class="op">=</span><span class="st">&quot;text-gray-500&quot;</span><span class="op">&gt;</span></span>
<span id="cb28-49"><a href="#cb28-49"></a>        <span class="op">&lt;</span>FontAwesomeIcon icon<span class="op">=</span>{faSpinner} className<span class="op">=</span><span class="st">&quot;mr-1 animate-spin&quot;</span> <span class="op">/&gt;</span></span>
<span id="cb28-50"><a href="#cb28-50"></a>        Loading<span class="op">...</span></span>
<span id="cb28-51"><a href="#cb28-51"></a>      <span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb28-52"><a href="#cb28-52"></a>    )<span class="op">;</span></span>
<span id="cb28-53"><a href="#cb28-53"></a>  }</span>
<span id="cb28-54"><a href="#cb28-54"></a></span>
<span id="cb28-55"><a href="#cb28-55"></a>  <span class="cf">return</span> (</span>
<span id="cb28-56"><a href="#cb28-56"></a>    <span class="op">&lt;</span>main<span class="op">&gt;</span></span>
<span id="cb28-57"><a href="#cb28-57"></a>      <span class="op">&lt;</span>div className<span class="op">=</span><span class="st">&quot;mb-2 text-2xl font-bold&quot;</span><span class="op">&gt;</span>Main<span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb28-58"><a href="#cb28-58"></a>      <span class="op">&lt;</span>div className<span class="op">=</span><span class="st">&quot;space-y-3&quot;</span><span class="op">&gt;</span></span>
<span id="cb28-59"><a href="#cb28-59"></a>        {posts<span class="op">.</span><span class="fu">map</span>((post) <span class="kw">=&gt;</span> (</span>
<span id="cb28-60"><a href="#cb28-60"></a>          <span class="op">&lt;</span>PostSummary key<span class="op">=</span>{post<span class="op">.</span><span class="at">id</span>} post<span class="op">=</span>{post} <span class="op">/&gt;</span></span>
<span id="cb28-61"><a href="#cb28-61"></a>        ))}</span>
<span id="cb28-62"><a href="#cb28-62"></a>      <span class="op">&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb28-63"><a href="#cb28-63"></a>    <span class="op">&lt;/</span>main<span class="op">&gt;</span></span>
<span id="cb28-64"><a href="#cb28-64"></a>  )<span class="op">;</span></span>
<span id="cb28-65"><a href="#cb28-65"></a>}<span class="op">;</span></span>
<span id="cb28-66"><a href="#cb28-66"></a></span>
<span id="cb28-67"><a href="#cb28-67"></a><span class="im">export</span> <span class="im">default</span> Page<span class="op">;</span></span></code></pre></div>
      <p><strong>第13行目</strong> と <strong>第14行目</strong>
      では、環境変数からの値の読込みを行なっています。末尾の
      <code>!</code> は、<strong>Non-null assertion operator</strong>
      といって <span class="masked">この値は必ず存在する
      (<code>undefined</code>や<code>null</code>ではない)</span>
      ということをコンパイラに明示的に伝えるための演算子になります。この
      <code>!</code> を付けることで <code>apiKey</code> と
      <code>apiBaseEp</code>
      は「string型」となりますが、付けないと「string |
      undefined型」となってしまいます。これらの値が「string |
      undefined型」だと、後続のコードで型互換性のエラーが発生するため、ここでは
      <code>!</code> を付けています。</p>
      <p>実際に <code>apiKey</code> の <code>!</code>
      を外して、どこで型互換性の問題が発生するかを確認してください。</p>
      <p><strong>第21行目</strong> から <strong>第27行目</strong>
      では、microCMS (ウェブAPI) からの <strong>データフェッチ</strong>
      を実行しています。<code>fetch</code>
      に与える第2引数のオブジェクトに <code>headers</code>
      属性を設定することで <span
      class="masked">HTTPリクエストに任意のヘッダを追加すること</span>
      ができます。</p>
      <p><strong>第31行目</strong> の
      <code>const data = await response.json()</code>
      では、HTTPレスポンスをオブジェクトに変換して <code>data</code>
      に格納しています。なお、HTTPリクエストのボディ部が
      <strong>JSONフォーマットではない場合に</strong> (例えば
      CSV形式や、その他形式の場合に)<code>.json()</code>
      メソッドを使用すると例外が発生するので注意してください。また、<code>json()</code>
      は <span class="masked">非同期メソッドなので <code>await</code>
      を付けること</span> を忘れないようにしてください。</p>
      <p>Thunder Client を使って<a
      href="lecture07.html#apiの利用テスト">事前確認</a>したように、<code>https://[ServiceID].microcms.io/api/v1/posts/</code>
      のレスポンスそのものは <code>Post[]</code>
      <strong>ではありません</strong>。レスポンスのなかの
      <code>contents</code> に <code>Post[]</code>
      に相当する情報が格納されています。そのため、<strong>第32行目</strong>
      では <code>setPosts(data.contents as Post[])</code>
      のようにしています。なお、<code>as Post[]</code>
      は省略可能です。</p>
      <p>以上、動作確認をしてください。なお、開発モードでアプリを立ち上げた直後は、(動的にコンパイルの実行処理の関係で)
      高確率でフェッチ処理に失敗するので
      (=「Loading…」から進まないことがあるので)、その場合は <span
      class="masked">ブラウザをリロード</span>
      してください。なお、本番環境では、この問題は生じません。</p>
      <h3 data-number="7.2.1" id="演習-宿題-40分"><span
      class="header-section-number">7.2.1</span> 演習 (宿題:
      <i class="fa-solid fa-stopwatch"></i> 40分)</h3>
      <p>記事詳細のページについても、トップページと同様に microCMS
      からデータを取得して表示できるように実装しておいてください。</p>
      <ul>
      <li><code>https://[ServiceID].microcms.io/api/v1/posts/[投稿記事のid]</code>
      のエンドポイントを利用してください。</li>
      <li>画像の取得に失敗するときは <code>next.config.mjs</code>
      の設定を確認してください。</li>
      <li>どうしても実装できないときは<a
      href="https://github.com/TakeshiWada1980/Programming3-2024/blob/main/docs/codes/07/code01.tsx">こちら<i class="fa-solid fa-person-chalkboard"></i></a>を参照してください。</li>
      </ul>
      <h1 data-number="8" id="宿題"><span
      class="header-section-number">8</span> 宿題</h1>
      <p>次回の授業 (後期中間試験明け) では、バックエンド開発として
      <strong>リレーショナルデータベース (RDB)</strong> を扱います。<a
      href="https://prog-8.com/">Progate</a>の「SQL 1」のセクション (<a
      href="https://prog-8.com/lessons/sql/study/1">https://prog-8.com/lessons/sql/study/1</a>のうち無料利用可能なコンテンツ)
      を使って予習しておくことをお勧めします。20分程度で取り組むことができます。</p>
      <figure>
      <img src="figs/07/progate_01.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>なお、RDBについては、2年次の「情報2」の第13回と第14回でも取り上げています。講義資料と教科書
      (キタミ式ITパスポート) の p.160 ～ p.191
      もあわせて復習しておくことをお勧めします。</p>
      <!-- ---------------------------------------- -->
    </main>

    <footer class="markdown-body">
      <p><a href="https://takeshiwada1980.github.io/Programming3-2024/">講義資料のIndexに移動</a></p>
    </footer>

    <script>
      window.onload = function () {
        // ナビゲーション関連
        let openBtn = document.getElementsByClassName("openbtn")[0];
        let navPnl = document.getElementById("g-nav");
        openBtn.onclick = () => {
          openBtn.classList.toggle("active");
          navPnl.classList.toggle("panelactive");
        };

        let items = navPnl.getElementsByTagName("a");
        Array.from(items).forEach((item) => {
          item.onclick = () => {
            openBtn.classList.toggle("active");
            navPnl.classList.toggle("panelactive");
          };
        });

        // マスク処理
        let maskedSpans = document.getElementsByClassName("masked");
        Array.from(maskedSpans).forEach((span) => {
          span.onclick = () => {
            span.classList.toggle("open");
          };
        });

        // data-startfrom 属性の行番号カウンタのリセット
        document.querySelectorAll("div.sourceCode").forEach(function (div) {
          var startFrom = div.getAttribute("data-startfrom");
          if (startFrom != null) {
            div.style.counterReset = "pg-line " + (startFrom - 1);
          }
        });

        // 画像にリンクを付与
        // let images = document.querySelectorAll("figure img");
        // Array.from(images).forEach((img) => {
        //   img.onclick = () => {
        //     location.href = img.getAttribute("src");
        //   };
        // });
      };
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=yes"
    />
    <meta name="robots" content="noindex,nofollow,noarchive" />
    <meta name="referrer" content="no-referrer" />

    <script>
      MathJax = {
        chtml: {
          displayAlign: "left",
          displayIndent: "1em",
        },
      };
    </script>

    

    <link rel="icon" href="favicon.ico" sizes="any" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css"
      integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZjVsC0lE40xsADsfeQoEypE+enwcOiGjk/bSuGGKHEyjSoQ1zVisanQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=M+PLUS+Rounded+1c"
    />
    <link rel="stylesheet" href="style.css" />

    <title>第09回 3I-プログラミング3</title>
  </head>

  <body>
    <div class="openbtn"><span></span><span></span><span></span></div>
    <nav id="g-nav">
      <div id="g-nav-list">
        <!-- ---------------------------------------- -->
         <ul>
<li><a href="#連絡概要" id="toc-連絡概要"><span class="toc-section-number">1</span> 連絡・概要</a>
<ul>
<li><a href="#連絡" id="toc-連絡"><span class="toc-section-number">1.1</span> 連絡</a></li>
<li><a href="#ここまでの授業の流れ" id="toc-ここまでの授業の流れ"><span
class="toc-section-number">1.2</span> ここまでの授業の流れ</a></li>
</ul></li>
<li><a href="#投稿記事に関連するウェブapiの実装" id="toc-投稿記事に関連するウェブapiの実装"><span
class="toc-section-number">2</span> 投稿記事に関連するウェブAPIの実装</a>
<ul>
<li><a href="#準備" id="toc-準備"><span class="toc-section-number">2.1</span> 準備</a></li>
<li><a href="#投稿記事の一覧を取得するウェブapiの実装"
id="toc-投稿記事の一覧を取得するウェブapiの実装"><span class="toc-section-number">2.2</span>
投稿記事の一覧を取得するウェブAPIの実装</a></li>
<li><a href="#投稿記事を新規作成するウェブapiの実装"
id="toc-投稿記事を新規作成するウェブapiの実装"><span class="toc-section-number">2.3</span>
投稿記事を新規作成するウェブAPIの実装</a></li>
<li><a href="#宿題-単一の投稿記事を取得するウェブapiの実装"
id="toc-宿題-単一の投稿記事を取得するウェブapiの実装"><span class="toc-section-number">2.4</span>
宿題⛄: 単一の投稿記事を取得するウェブAPIの実装</a></li>
<li><a href="#宿題-投稿記事を削除するウェブapiの実装"
id="toc-宿題-投稿記事を削除するウェブapiの実装"><span class="toc-section-number">2.5</span> 宿題⛄:
投稿記事を削除するウェブAPIの実装</a></li>
<li><a href="#宿題-投稿記事の内容を変更-更新-するウェブapiの実装"
id="toc-宿題-投稿記事の内容を変更-更新-するウェブapiの実装"><span
class="toc-section-number">2.6</span> 宿題⛄: 投稿記事の内容を変更 (更新)
するウェブAPIの実装</a></li>
<li><a href="#情報の整理-サイトマップとapリスト" id="toc-情報の整理-サイトマップとapリスト"><span
class="toc-section-number">2.7</span> 情報の整理: サイトマップとAPリスト</a></li>
</ul></li>
<li><a href="#カテゴリの新規作成ページの実装" id="toc-カテゴリの新規作成ページの実装"><span
class="toc-section-number">3</span> カテゴリの新規作成ページの実装</a>
<ul>
<li><a href="#準備-1" id="toc-準備-1"><span class="toc-section-number">3.1</span> 準備</a></li>
<li><a href="#画面の実装-postリクエストの処理を除く"
id="toc-画面の実装-postリクエストの処理を除く"><span class="toc-section-number">3.2</span>
画面の実装 (POSTリクエストの処理を除く)</a></li>
<li><a href="#画面の実装-postリクエストの処理を除く-1"
id="toc-画面の実装-postリクエストの処理を除く-1"><span class="toc-section-number">3.3</span>
画面の実装 (POSTリクエストの処理を除く)</a></li>
</ul></li>
<li><a href="#冬休みの宿題" id="toc-冬休みの宿題"><span class="toc-section-number">4</span>
冬休みの宿題</a></li>
</ul> 
        <!-- ---------------------------------------- -->
      </div>
    </nav>

    <header class="markdown-body">
      <p>2024-3I プログラミング3 第09回 講義資料</p>
      <p>2024年12月19日（木）1・2時限</p>
    </header>

    <main class="markdown-body">
      <!-- ---------------------------------------- -->
      <h1 data-number="1" id="連絡概要"><span class="header-section-number">1</span> 連絡・概要</h1>
      <h2 data-number="1.1" id="連絡"><span class="header-section-number">1.1</span> 連絡</h2>
      <ul>
      <li>「<strong>小テスト</strong>」を実施します。</li>
      <li>冬休みの宿題🥶があります。</li>
      <li>本日は、スペシャルコンテンツとして OB講演 (＝<span
      class="masked">現役のフリーランスエンジニアとして活躍している本校OB</span>) があります。</li>
      </ul>
      <h2 data-number="1.2" id="ここまでの授業の流れ"><span class="header-section-number">1.2</span>
      ここまでの授業の流れ</h2>
      <p>前回講義では「ブログアプリ」のバックエンド開発として、「<strong>カテゴリ</strong>」のCRUDに関連するウェブAPIの設計と実装を行ないました。</p>
      <table>
      <thead>
      <tr class="header">
      <th>エンドポイント</th>
      <th>HTTP<br>Method</th>
      <th>処理</th>
      <th>管理者<br>権限</th>
      <th>リクエスト<br>ボディ</th>
      </tr>
      </thead>
      <tbody>
      <tr class="odd">
      <td>/api/categories</td>
      <td>GET</td>
      <td>カテゴリの一覧を取得する</td>
      <td></td>
      <td></td>
      </tr>
      <tr class="even">
      <td>/api/admin/categories</td>
      <td>POST</td>
      <td>カテゴリを追加する</td>
      <td>必要</td>
      <td>必要</td>
      </tr>
      <tr class="odd">
      <td>/api/admin/categories/[id]</td>
      <td>PUT</td>
      <td>カテゴリの名前を変更する</td>
      <td>必要</td>
      <td>必要</td>
      </tr>
      <tr class="even">
      <td>/api/admin/categories/[id]</td>
      <td>DELETE</td>
      <td>カテゴリを削除する</td>
      <td>必要</td>
      <td></td>
      </tr>
      </tbody>
      </table>
      <p>各APIの実装では、O/R Mapper である <strong>PrismaClient</strong> を通して <span
      class="masked">リレーショナルデータベース (RDB) に対するCRUD操作</span>
      について学びました。なお、現在は RDB として「SQLite」を使用していますが、次々回以降に <a
      href="https://www.google.com/search?q=Supabaseとは">Supabase</a>
      の「PostgreSQL」に切り替える予定です。</p>
      <p>今回講義 (＋冬休みの宿題を含む)
      では「<strong>投稿記事</strong>」に関連するウェブAPIの実装と、各APIと連携するフロントエンド開発
      (＝<span class="masked">編集用のフォームを含む画面の実装</span>)
      について解説していきます。</p>
      <h1 data-number="2" id="投稿記事に関連するウェブapiの実装"><span
      class="header-section-number">2</span> 投稿記事に関連するウェブAPIの実装</h1>
      <p>「<strong>投稿記事</strong>」に関連するCRUD操作のインターフェイスとして、次のようなウェブAPIを実装していきます。</p>
      <table>
      <thead>
      <tr class="header">
      <th>エンドポイント</th>
      <th>HTTP<br>Method</th>
      <th>処理</th>
      <th>管理者<br>権限</th>
      <th>リクエスト<br>ボディ</th>
      </tr>
      </thead>
      <tbody>
      <tr class="odd">
      <td>/api/posts</td>
      <td>GET</td>
      <td>投稿記事の一覧を取得する</td>
      <td></td>
      <td></td>
      </tr>
      <tr class="even">
      <td>/api/posts/[id]</td>
      <td>GET</td>
      <td>投稿記事 (単体) を取得する</td>
      <td></td>
      <td></td>
      </tr>
      <tr class="odd">
      <td>/api/admin/posts</td>
      <td>POST</td>
      <td>投稿記事を追加する</td>
      <td>必要</td>
      <td>必要</td>
      </tr>
      <tr class="even">
      <td>/api/admin/posts/[id]</td>
      <td>PUT</td>
      <td>投稿記事の内容を変更 (編集) する</td>
      <td>必要</td>
      <td>必要</td>
      </tr>
      <tr class="odd">
      <td>/api/admin/posts/[id]</td>
      <td>DELETE</td>
      <td>投稿記事を削除する</td>
      <td>必要</td>
      <td></td>
      </tr>
      </tbody>
      </table>
      <p>投稿記事については、<code>id</code> を指定して <span class="masked">投稿記事 (単体)
      を取得</span> するAPI (GET Method 対応) も実装していきます。</p>
      <h2 data-number="2.1" id="準備"><span class="header-section-number">2.1</span> 準備</h2>
      <p>解説に示す実行結果と、皆さんの手元での実行結果を一致させるために、以下のコマンドを実行して
      <strong>DBのレコードの初期化</strong>
      を実行しておいてください。なお、適切に実行結果の読み替えができる場合は初期化の必要はありません。</p>
      <pre><code>npx prisma db seed</code></pre>
      <p><strong>注意</strong>: <code>prisma/seed.ts</code> の内容が<a
      href="https://github.com/TakeshiWada1980/Programming3-2024/blob/main/docs/codes/08/code01.ts">こちら<i class="fa-solid fa-person-chalkboard"></i></a>のようになっている前提です。</p>
      <h2 data-number="2.2" id="投稿記事の一覧を取得するウェブapiの実装"><span
      class="header-section-number">2.2</span> 投稿記事の一覧を取得するウェブAPIの実装</h2>
      <p>はじめに、<strong>GET</strong> メソッドに対応した
      <strong>投稿記事の「一覧」を取得するためのエンドポイント</strong> (<code>/api/posts</code>)
      を実装していきます。基本的には前回講義で実装した<a
      href="lecture08.html#カテゴリの一覧を取得するウェブapiの実装">カテゴリの一覧の取得</a>と同じ構造となります。</p>
      <p><code>src/app/api/posts/route.ts</code> を作成して、次のプログラムを貼付けてください
      (プログラムを読み解いてください)。</p>
      <div class="sourceCode" id="cb2"
      data-caption="api/posts/route.ts (投稿記事の「一覧」の取得)"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb2-1"><a href="#cb2-1"></a><span class="im">import</span> prisma <span class="im">from</span> <span class="st">&quot;@/lib/prisma&quot;</span><span class="op">;</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="im">import</span> { NextResponse<span class="op">,</span> NextRequest } <span class="im">from</span> <span class="st">&quot;next/server&quot;</span><span class="op">;</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="im">import</span> { Post } <span class="im">from</span> <span class="st">&quot;@prisma/client&quot;</span><span class="op">;</span></span>
<span id="cb2-4"><a href="#cb2-4"></a></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="im">export</span> <span class="kw">const</span> GET <span class="op">=</span> <span class="kw">async</span> (req<span class="op">:</span> NextRequest) <span class="kw">=&gt;</span> {</span>
<span id="cb2-6"><a href="#cb2-6"></a>  <span class="cf">try</span> {</span>
<span id="cb2-7"><a href="#cb2-7"></a>    <span class="kw">const</span> posts<span class="op">:</span> Post[] <span class="op">=</span> <span class="cf">await</span> prisma<span class="op">.</span><span class="at">post</span><span class="op">.</span><span class="fu">findMany</span>({</span>
<span id="cb2-8"><a href="#cb2-8"></a>      orderBy<span class="op">:</span> {</span>
<span id="cb2-9"><a href="#cb2-9"></a>        createdAt<span class="op">:</span> <span class="st">&quot;desc&quot;</span><span class="op">,</span></span>
<span id="cb2-10"><a href="#cb2-10"></a>      }<span class="op">,</span></span>
<span id="cb2-11"><a href="#cb2-11"></a>    })<span class="op">;</span></span>
<span id="cb2-12"><a href="#cb2-12"></a>    <span class="cf">return</span> NextResponse<span class="op">.</span><span class="fu">json</span>(posts)<span class="op">;</span></span>
<span id="cb2-13"><a href="#cb2-13"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb2-14"><a href="#cb2-14"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(error)<span class="op">;</span></span>
<span id="cb2-15"><a href="#cb2-15"></a>    <span class="cf">return</span> NextResponse<span class="op">.</span><span class="fu">json</span>(</span>
<span id="cb2-16"><a href="#cb2-16"></a>      { error<span class="op">:</span> <span class="st">&quot;投稿記事の一覧の取得に失敗しました&quot;</span> }<span class="op">,</span></span>
<span id="cb2-17"><a href="#cb2-17"></a>      { status<span class="op">:</span> <span class="dv">500</span> }</span>
<span id="cb2-18"><a href="#cb2-18"></a>    )<span class="op">;</span></span>
<span id="cb2-19"><a href="#cb2-19"></a>  }</span>
<span id="cb2-20"><a href="#cb2-20"></a>}<span class="op">;</span></span></code></pre></div>
      <p><strong>Thunder Clinet</strong> を使って <code>/api/posts</code>
      にGETリクエストを送って、次のような <span
      class="masked">「id」「title」「content」「coverImageURL」「createdAt」「updatedAt」を属性に持つオブジェクトの配列</span>
      がレスポンスとして得られることを確認してください。</p>
      <div class="sourceCode" id="cb3" data-caption="/api/posts のレスポンス(例)"><pre
      class="sourceCode numberSource json numberLines"><code class="sourceCode json"><span id="cb3-1"><a href="#cb3-1"></a><span class="ot">[</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>  <span class="fu">{</span></span>
<span id="cb3-3"><a href="#cb3-3"></a>    <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;d6993236-ac1c-40cf-a4af-7ff405b7e96f&quot;</span><span class="fu">,</span></span>
<span id="cb3-4"><a href="#cb3-4"></a>    <span class="dt">&quot;title&quot;</span><span class="fu">:</span> <span class="st">&quot;投稿4&quot;</span><span class="fu">,</span></span>
<span id="cb3-5"><a href="#cb3-5"></a>    <span class="dt">&quot;content&quot;</span><span class="fu">:</span> <span class="st">&quot;投稿4の本文。&lt;br/&gt;投稿4の本文。投稿4の本文。&quot;</span><span class="fu">,</span></span>
<span id="cb3-6"><a href="#cb3-6"></a>    <span class="dt">&quot;coverImageURL&quot;</span><span class="fu">:</span> <span class="st">&quot;https://...&quot;</span><span class="fu">,</span></span>
<span id="cb3-7"><a href="#cb3-7"></a>    <span class="dt">&quot;createdAt&quot;</span><span class="fu">:</span> <span class="st">&quot;2024-12-05T05:58:44.095Z&quot;</span><span class="fu">,</span></span>
<span id="cb3-8"><a href="#cb3-8"></a>    <span class="dt">&quot;updatedAt&quot;</span><span class="fu">:</span> <span class="st">&quot;2024-12-05T05:58:44.095Z&quot;</span></span>
<span id="cb3-9"><a href="#cb3-9"></a>  <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb3-10"><a href="#cb3-10"></a>  <span class="er">//</span> <span class="er">～</span> <span class="er">省略</span> <span class="er">～</span></span>
<span id="cb3-11"><a href="#cb3-11"></a>  <span class="fu">{</span></span>
<span id="cb3-12"><a href="#cb3-12"></a>    <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;18cd63c0-d364-4c29-9e92-fa68b8d65cfc&quot;</span><span class="fu">,</span></span>
<span id="cb3-13"><a href="#cb3-13"></a>    <span class="dt">&quot;title&quot;</span><span class="fu">:</span> <span class="st">&quot;投稿1&quot;</span><span class="fu">,</span></span>
<span id="cb3-14"><a href="#cb3-14"></a>    <span class="dt">&quot;content&quot;</span><span class="fu">:</span> <span class="st">&quot;投稿1の本文。&lt;br/&gt;投稿1の本文。投稿1の本文。&quot;</span><span class="fu">,</span></span>
<span id="cb3-15"><a href="#cb3-15"></a>    <span class="dt">&quot;coverImageURL&quot;</span><span class="fu">:</span> <span class="st">&quot;https://...&quot;</span><span class="fu">,</span></span>
<span id="cb3-16"><a href="#cb3-16"></a>    <span class="dt">&quot;createdAt&quot;</span><span class="fu">:</span> <span class="st">&quot;2024-12-05T05:58:44.073Z&quot;</span><span class="fu">,</span></span>
<span id="cb3-17"><a href="#cb3-17"></a>    <span class="dt">&quot;updatedAt&quot;</span><span class="fu">:</span> <span class="st">&quot;2024-12-05T05:58:44.073Z&quot;</span></span>
<span id="cb3-18"><a href="#cb3-18"></a>  <span class="fu">}</span></span>
<span id="cb3-19"><a href="#cb3-19"></a><span class="ot">]</span></span></code></pre></div>
      <p>ところで、このAPIを利用して以下のよいうな画面
      (＝投稿記事の一覧表示の画面・アプリのトップページ) を構成しようとすると <span
      class="masked">レスポンスのなかにカテゴリに関する情報が足りないこと</span>
      に気づくでしょうか。また <code>coverImageURL</code> と <code>updatedAt</code>
      が冗長な情報になることにも気づくでしょうか。</p>
      <figure>
      <img src="figs/06/app_09.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>RDB
      の各テーブルには、情報が「<strong>正規化</strong>」されて格納されているため、投稿記事テーブル
      (<code>Post</code>) <strong>だけ</strong>を参照しても <span
      class="masked">記事に紐づく「カテゴリ」の情報</span>
      を得ることは<strong>で・き・ま・せ・ん</strong>。このようなとき、RDB
      では「(中間テーブルを使った)
      <strong>テーブルの結合操作</strong>」が必要となってきます。SQL文では <code>JOIN</code>
      というキーワードを使ってテーブルの結合る処理を行います（この結合は、慣れるまではかなり難しいです）。</p>
      <p><strong>(プロンプト例)</strong></p>
      <blockquote>
      <p>リレーショナルデータベースにおいてテーブルの結合 (JOIN)
      は、どのようなときに必要となりますか。投稿記事とカテゴリが「多対多」の関係になっているブログデータを扱っている場合を例に考えてみてください。</p>
      </blockquote>
      <p>しかし、ここでのブログアプリ開発では、ORM である Prisma
      を利用しているため、(<code>JOIN</code> を使ったSQL文を記述することなく) 比較的簡単に
      <strong>投稿記事に紐づくカテゴリ情報</strong> の取得が可能となります🙌。具体的には
      <code>route.ts</code> の <strong>第07行目</strong> <code>findMany</code>
      メソッドの第1引数に「<strong>selectオプション</strong>」を追加することによって可能になります。</p>
      <p>実際に、次のように <code>findMany</code>
      の第1引数を変更してみてください。そして、投稿記事の情報 (<code>coverImageURL</code> と
      <code>updatedAt</code> を除いたもの) に加えて、<span
      class="masked">それに紐づけられたカテゴリの「id」と「name」</span>
      がレスポンスとして返ってくることを確認してください。</p>
      <div class="sourceCode" id="cb4" data-startFrom="7"
      data-caption="api/posts/route.ts (findManyの引数を変更) 抜粋"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 6;"><span id="cb4-7"><a href="#cb4-7"></a><span class="kw">const</span> posts <span class="op">=</span> <span class="cf">await</span> prisma<span class="op">.</span><span class="at">post</span><span class="op">.</span><span class="fu">findMany</span>({ <span class="co">// ◀ 推論を利用して posts の型を決定</span></span>
<span id="cb4-8"><a href="#cb4-8"></a>  select<span class="op">:</span> {</span>
<span id="cb4-9"><a href="#cb4-9"></a>    id<span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb4-10"><a href="#cb4-10"></a>    title<span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb4-11"><a href="#cb4-11"></a>    content<span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb4-12"><a href="#cb4-12"></a>    createdAt<span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb4-13"><a href="#cb4-13"></a>    categories<span class="op">:</span> {</span>
<span id="cb4-14"><a href="#cb4-14"></a>      select<span class="op">:</span> {</span>
<span id="cb4-15"><a href="#cb4-15"></a>        category<span class="op">:</span> {</span>
<span id="cb4-16"><a href="#cb4-16"></a>          select<span class="op">:</span> {</span>
<span id="cb4-17"><a href="#cb4-17"></a>            id<span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb4-18"><a href="#cb4-18"></a>            name<span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb4-19"><a href="#cb4-19"></a>          }<span class="op">,</span></span>
<span id="cb4-20"><a href="#cb4-20"></a>        }<span class="op">,</span></span>
<span id="cb4-21"><a href="#cb4-21"></a>      }<span class="op">,</span></span>
<span id="cb4-22"><a href="#cb4-22"></a>    }<span class="op">,</span></span>
<span id="cb4-23"><a href="#cb4-23"></a>  }<span class="op">,</span></span>
<span id="cb4-24"><a href="#cb4-24"></a>  orderBy<span class="op">:</span> {</span>
<span id="cb4-25"><a href="#cb4-25"></a>    createdAt<span class="op">:</span> <span class="st">&quot;desc&quot;</span><span class="op">,</span></span>
<span id="cb4-26"><a href="#cb4-26"></a>  }<span class="op">,</span></span>
<span id="cb4-27"><a href="#cb4-27"></a>})<span class="op">;</span></span></code></pre></div>
      <p>なお、上記のように変更したときは、<code>findMany</code>メソッドの「戻り値」に <span
      class="masked">カテゴリの情報が含まれるようになる</span> ため、<strong>第07行目</strong> の
      <code>const posts: Post[] = ...</code> を <code>const posts = ...</code>
      のように変更してください (つまり、型推論を利用して <code>posts</code>
      の型を決定するようにしてください)。現在のままでは (<code>posts: Post[]</code>
      のままでは)「型」の不一致によるエラーが発生してしまいます。</p>
      <div class="note type-senior">
      <p><strong>応用: selectを指定したときの「型」を明示するためには</strong></p>
      <p><code>findMany</code> の引数に <code>select</code>
      を含むオブジェクトを指定したとき、型推論を利用せずに <code>posts</code>
      に対して明示的に「型」を指定したいときは<a
      href="https://github.com/TakeshiWada1980/Programming3-2024/blob/main/docs/codes/09/code01.ts">こちら<i class="fa-solid fa-person-chalkboard"></i></a>のようにしてください。ただし、これは中級以上の内容になるので、無理に利用する必要はありません。</p>
      </div>
      <p>レスポンスのボディが次のようになっていること (＝<span
      class="masked">投稿記事に紐づくカテゴリの「 id」と「name」が取得できること</span>)
      を、実際に確認してください。</p>
      <div class="sourceCode" id="cb5"
      data-caption="select を指定したときの /api/posts のレスポンス(例)"><pre
      class="sourceCode numberSource json numberLines"><code class="sourceCode json"><span id="cb5-1"><a href="#cb5-1"></a><span class="fu">{</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>  <span class="dt">&quot;contents&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb5-3"><a href="#cb5-3"></a>    <span class="fu">{</span></span>
<span id="cb5-4"><a href="#cb5-4"></a>      <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;d6993236-ac1c-40cf-a4af-7ff405b7e96f&quot;</span><span class="fu">,</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>      <span class="dt">&quot;title&quot;</span><span class="fu">:</span> <span class="st">&quot;投稿4&quot;</span><span class="fu">,</span></span>
<span id="cb5-6"><a href="#cb5-6"></a>      <span class="dt">&quot;content&quot;</span><span class="fu">:</span> <span class="st">&quot;投稿4の本文。&lt;br/&gt;投稿4の本文。投稿4の本文。&quot;</span><span class="fu">,</span></span>
<span id="cb5-7"><a href="#cb5-7"></a>      <span class="dt">&quot;createdAt&quot;</span><span class="fu">:</span> <span class="st">&quot;2024-12-05T05:58:44.095Z&quot;</span><span class="fu">,</span></span>
<span id="cb5-8"><a href="#cb5-8"></a>      <span class="dt">&quot;categories&quot;</span><span class="fu">:</span> <span class="ot">[]</span></span>
<span id="cb5-9"><a href="#cb5-9"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb5-10"><a href="#cb5-10"></a>    <span class="er">//</span> <span class="er">～</span> <span class="er">省略</span> <span class="er">～</span></span>
<span id="cb5-11"><a href="#cb5-11"></a>    <span class="fu">{</span></span>
<span id="cb5-12"><a href="#cb5-12"></a>      <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;18cd63c0-d364-4c29-9e92-fa68b8d65cfc&quot;</span><span class="fu">,</span></span>
<span id="cb5-13"><a href="#cb5-13"></a>      <span class="dt">&quot;title&quot;</span><span class="fu">:</span> <span class="st">&quot;投稿1&quot;</span><span class="fu">,</span></span>
<span id="cb5-14"><a href="#cb5-14"></a>      <span class="dt">&quot;content&quot;</span><span class="fu">:</span> <span class="st">&quot;投稿1の本文。&lt;br/&gt;投稿1の本文。投稿1の本文。&quot;</span><span class="fu">,</span></span>
<span id="cb5-15"><a href="#cb5-15"></a>      <span class="dt">&quot;createdAt&quot;</span><span class="fu">:</span> <span class="st">&quot;2024-12-05T05:58:44.073Z&quot;</span><span class="fu">,</span></span>
<span id="cb5-16"><a href="#cb5-16"></a>      <span class="dt">&quot;categories&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb5-17"><a href="#cb5-17"></a>        <span class="fu">{</span></span>
<span id="cb5-18"><a href="#cb5-18"></a>          <span class="dt">&quot;category&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb5-19"><a href="#cb5-19"></a>            <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;f5ee7b9c-ee8e-466e-aafc-6aa112005d5a&quot;</span><span class="fu">,</span></span>
<span id="cb5-20"><a href="#cb5-20"></a>            <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;カテゴリ1&quot;</span></span>
<span id="cb5-21"><a href="#cb5-21"></a>          <span class="fu">}</span></span>
<span id="cb5-22"><a href="#cb5-22"></a>        <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb5-23"><a href="#cb5-23"></a>        <span class="fu">{</span></span>
<span id="cb5-24"><a href="#cb5-24"></a>          <span class="dt">&quot;category&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb5-25"><a href="#cb5-25"></a>            <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;d3e10601-3cfa-48f3-9ede-886647a1063b&quot;</span><span class="fu">,</span></span>
<span id="cb5-26"><a href="#cb5-26"></a>            <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;カテゴリ2&quot;</span></span>
<span id="cb5-27"><a href="#cb5-27"></a>          <span class="fu">}</span></span>
<span id="cb5-28"><a href="#cb5-28"></a>        <span class="fu">}</span></span>
<span id="cb5-29"><a href="#cb5-29"></a>      <span class="ot">]</span></span>
<span id="cb5-30"><a href="#cb5-30"></a>    <span class="fu">}</span></span>
<span id="cb5-31"><a href="#cb5-31"></a>  <span class="ot">]</span></span>
<span id="cb5-32"><a href="#cb5-32"></a><span class="fu">}</span></span></code></pre></div>
      <h3 data-number="2.2.1" id="補足-selectプロパティに関する解説-1"><span
      class="header-section-number">2.2.1</span> 補足: selectプロパティに関する解説 1</h3>
      <p>PrismaClient の <strong>findManyメソッド</strong> や <strong>findUniqueメソッド</strong>
      (＝単一データの取得に使用) の引数に設定可能な <code>select</code> プロパティは、SQL文の
      <code>SELECT</code> に相当するもので、戻り値として得たい <span class="masked">カラム
      (属性)</span> を明示的に指定するために使用します。</p>
      <p>引数として与えるオブジェクトに <code>select</code> プロパティを特に含めなければ <span
      class="masked">そのテーブルが持つすべてのカラム (列)</span> が戻り値となります。例えば
      <code>prisma.post.findMany</code> メソッドは、<code>select</code>
      を指定しなければ「id」「title」「content」「coverImageURL」「createdAt」「updatedAt」の
      <strong>6個のプロパティを持ったオブジェクト (単体/配列)</strong> が「戻り値」となります。</p>
      <p>一方で、メソッドの引数を <code>select: { id: true, title: true, content: true }</code>
      とすれば、「id」「title」「content」の <strong>3個だけのプロパティを持ったオブジェクト
      (単体/配列)</strong> が「戻り値」となります。</p>
      <p>ここで <span class="masked">「そのテーブルが持つすべてのカラム (列)とは何か？」</span>
      について正しく理解しておく必要があります。<a
      href="lecture08.html#schema.prisma-の編集">前回講義</a> では <code>prisma/schema.prisma</code>
      というファイルで、各テーブルのスキーマ (＝構造・型・制約) を次のように定義しました。</p>
      <div class="sourceCode" id="cb6" data-caption="prisma/schema.prisma (抜粋・再掲)"><pre
      class="sourceCode numberSource text numberLines"><code class="sourceCode"><span id="cb6-1"><a href="#cb6-1"></a>// 投稿記事テーブル</span>
<span id="cb6-2"><a href="#cb6-2"></a>model Post {</span>
<span id="cb6-3"><a href="#cb6-3"></a>  id             String @id @default(uuid())</span>
<span id="cb6-4"><a href="#cb6-4"></a>  title          String</span>
<span id="cb6-5"><a href="#cb6-5"></a>  content        String</span>
<span id="cb6-6"><a href="#cb6-6"></a>  coverImageURL  String</span>
<span id="cb6-7"><a href="#cb6-7"></a>  createdAt      DateTime @default(now())</span>
<span id="cb6-8"><a href="#cb6-8"></a>  updatedAt      DateTime @updatedAt</span>
<span id="cb6-9"><a href="#cb6-9"></a>  categories     PostCategory[]</span>
<span id="cb6-10"><a href="#cb6-10"></a>}</span>
<span id="cb6-11"><a href="#cb6-11"></a></span>
<span id="cb6-12"><a href="#cb6-12"></a>// カテゴリテーブル</span>
<span id="cb6-13"><a href="#cb6-13"></a>model Category {</span>
<span id="cb6-14"><a href="#cb6-14"></a>  id         String @id @default(uuid())</span>
<span id="cb6-15"><a href="#cb6-15"></a>  name       String @unique</span>
<span id="cb6-16"><a href="#cb6-16"></a>  createdAt  DateTime @default(now())</span>
<span id="cb6-17"><a href="#cb6-17"></a>  updatedAt  DateTime @updatedAt</span>
<span id="cb6-18"><a href="#cb6-18"></a>  posts      PostCategory[]</span>
<span id="cb6-19"><a href="#cb6-19"></a>}</span>
<span id="cb6-20"><a href="#cb6-20"></a></span>
<span id="cb6-21"><a href="#cb6-21"></a>// 投稿記事とカテゴリを紐づける中間テーブル</span>
<span id="cb6-22"><a href="#cb6-22"></a>model PostCategory {</span>
<span id="cb6-23"><a href="#cb6-23"></a>  id          String @id @default(uuid())</span>
<span id="cb6-24"><a href="#cb6-24"></a>  postId      String</span>
<span id="cb6-25"><a href="#cb6-25"></a>  categoryId  String</span>
<span id="cb6-26"><a href="#cb6-26"></a>  createdAt   DateTime @default(now())</span>
<span id="cb6-27"><a href="#cb6-27"></a>  updatedAt   DateTime @updatedAt</span>
<span id="cb6-28"><a href="#cb6-28"></a>  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)</span>
<span id="cb6-29"><a href="#cb6-29"></a>  post        Post     @relation(fields: [postId], references: [id], onDelete: Cascade)</span>
<span id="cb6-30"><a href="#cb6-30"></a>}</span></code></pre></div>
      <p>これらの定義を <strong>ER図 (風)</strong> に表現すると以下のようになります
      (<strong>ER図</strong>: Entity Relationship Diagram
      については「データベース工学」で詳しく学びます。ここでは「RDBの設計図」と考えてください)。<code>schema.prisma</code>
      の記述と 以下のER図の対応関係が (なんとなく) 分かるでしょうか。</p>
      <figure>
      <img src="figs/09/db_01.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>ここで、上記のER図のなかで <strong>赤色で prisma
      と示したカラム</strong>、具体的に言えば、投稿記事テーブルの <code>categories</code>
      カラム、中間テーブルの <code>category</code> と <code>post</code> カラム、カテゴリテーブルの
      <code>posts</code> のカラムは扱いに注意が必要です。</p>
      <p>これらのカラムは、<strong>Prisma が O/R Mapper として内部的に使用する参照情報</strong>
      (＝<span
      class="masked">オブジェクト指向的なデータアクセスをユーザに提供するための設定情報</span>)
      であり、<span class="masked">実際の RDB のテーブルのなかには存在しないカラム</span>
      となっています。</p>
      <p>実際に SQLite の<a
      href="https://www.sqlite.org/download.html">コマンドラインツール</a>である
      <code>sqlite3.exe</code> を使って <code>prisma/dev.db</code>
      に接続して「投稿記事テーブル」のスキーマを確認するコマンドを実行してみると、次のように結果になります。</p>
      <pre><code>sqlite&gt; .schema Post
CREATE TABLE IF NOT EXISTS &quot;Post&quot; (
    &quot;id&quot; TEXT NOT NULL PRIMARY KEY,
    &quot;title&quot; TEXT NOT NULL,
    &quot;content&quot; TEXT NOT NULL,
    &quot;coverImageURL&quot; TEXT NOT NULL,
    &quot;createdAt&quot; DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    &quot;updatedAt&quot; DATETIME NOT NULL
);</code></pre>
      <p><code>id</code> や <code>title</code> などのカラムは存在しますが、<code>categories</code>
      というカラムは<strong>存在しない</strong>ことが確認できると思います。このように <strong>実際の
      RDB のテーブルに存在しないカラムの値</strong> は、<code>select</code> オプション (あるいは
      <code>include</code> オプション) を指定して取得する必要があります。</p>
      <p>なお、<code>schema.prisma</code> のフィールドのうち、実際の DB にカラム (列)
      が作成されないのは <code>categories PostCategory[]</code> や <code>posts PostCategory[]</code>
      のように「配列型」になっているものと、<code>@relation(...)</code>
      の属性がついたものとなります。</p>
      <h3 data-number="2.2.2" id="補足-selectプロパティに関する解説-2"><span
      class="header-section-number">2.2.2</span> 補足: selectプロパティに関する解説 2</h3>
      <p><code>prisma.post.findMany</code> を使って、「カテゴリテーブル」のなかの <code>id</code> と
      <code>name</code> の情報も同時に取得するためには、以下の ➊ → ➋ → ➌
      のように<strong>段階的にアプローチ</strong>していく必要がなります。</p>
      <figure>
      <img src="figs/09/db_02.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>これが、さきほどの <code>select</code> の指定
      (<strong>第13行目</strong>から<strong>第22行目</strong>) に対応しています。</p>
      <div class="sourceCode" id="cb8" data-startFrom="7"
      data-caption="api/posts/route.ts (findManyの引数を変更) 抜粋"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 6;"><span id="cb8-7"><a href="#cb8-7"></a><span class="kw">const</span> posts <span class="op">=</span> <span class="cf">await</span> prisma<span class="op">.</span><span class="at">post</span><span class="op">.</span><span class="fu">findMany</span>({</span>
<span id="cb8-8"><a href="#cb8-8"></a>  select<span class="op">:</span> {</span>
<span id="cb8-9"><a href="#cb8-9"></a>    id<span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb8-10"><a href="#cb8-10"></a>    title<span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb8-11"><a href="#cb8-11"></a>    content<span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb8-12"><a href="#cb8-12"></a>    createdAt<span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb8-13"><a href="#cb8-13"></a>    categories<span class="op">:</span> { <span class="co">// ◀ ➊</span></span>
<span id="cb8-14"><a href="#cb8-14"></a>      select<span class="op">:</span> {</span>
<span id="cb8-15"><a href="#cb8-15"></a>        category<span class="op">:</span> { <span class="co">// ◀ ➋</span></span>
<span id="cb8-16"><a href="#cb8-16"></a>          select<span class="op">:</span> {</span>
<span id="cb8-17"><a href="#cb8-17"></a>            id<span class="op">:</span> <span class="kw">true</span><span class="op">,</span>    <span class="co">// ◀ ➌</span></span>
<span id="cb8-18"><a href="#cb8-18"></a>            name<span class="op">:</span> <span class="kw">true</span><span class="op">,</span>  <span class="co">// ◀ ➌</span></span>
<span id="cb8-19"><a href="#cb8-19"></a>          }<span class="op">,</span></span>
<span id="cb8-20"><a href="#cb8-20"></a>        }<span class="op">,</span></span>
<span id="cb8-21"><a href="#cb8-21"></a>      }<span class="op">,</span></span>
<span id="cb8-22"><a href="#cb8-22"></a>    }<span class="op">,</span></span>
<span id="cb8-23"><a href="#cb8-23"></a>  }<span class="op">,</span></span>
<span id="cb8-24"><a href="#cb8-24"></a>  orderBy<span class="op">:</span> {</span>
<span id="cb8-25"><a href="#cb8-25"></a>    createdAt<span class="op">:</span> <span class="st">&quot;desc&quot;</span><span class="op">,</span></span>
<span id="cb8-26"><a href="#cb8-26"></a>  }<span class="op">,</span></span>
<span id="cb8-27"><a href="#cb8-27"></a>})<span class="op">;</span></span></code></pre></div>
      <p><code>select</code>
      オプションの指定は理解が難しいと思うので、生成AIなどのサポートを受けてください。</p>
      <p><strong>(プロンプト例)</strong></p>
      <blockquote>
      <p>prisma の <code>findMany</code> の引数に設定可能な
      <code>select</code>、<code>inclue</code>、<code>_count</code>
      について丁寧に解説してください。投稿記事とカテゴリが「多対多」の関係になっているブログデータを扱っている場合を例に解説してください。</p>
      </blockquote>
      <blockquote>
      <p>上記以外に <code>findMany</code> メソッドでは、どのようなオプションが利用できますか。</p>
      </blockquote>
      <h2 data-number="2.3" id="投稿記事を新規作成するウェブapiの実装"><span
      class="header-section-number">2.3</span> 投稿記事を新規作成するウェブAPIの実装</h2>
      <p>投稿記事を新規作成 (POST メソッドで記事を<strong>新規投稿</strong>)
      するためのウェブAPIを実装していきます。エンドポイントは <code>/api/admin/posts</code>
      として、以下のようなリクエストボディを受け付ける想定で設計します。投稿記事にカテゴリを1個も設定しないことも許可し、その場合は
      <code>"categoryIds": []</code> のように <strong>空配列</strong> を与えるものとします。</p>
      <div class="sourceCode" id="cb9"
      data-caption="/api/admin/post に対するリクエストのボディ例"><pre
      class="sourceCode numberSource json numberLines"><code class="sourceCode json"><span id="cb9-1"><a href="#cb9-1"></a><span class="fu">{</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>  <span class="dt">&quot;title&quot;</span><span class="fu">:</span> <span class="st">&quot;投稿X&quot;</span><span class="fu">,</span></span>
<span id="cb9-3"><a href="#cb9-3"></a>  <span class="dt">&quot;content&quot;</span><span class="fu">:</span> <span class="st">&quot;投稿Xの本文。&lt;br/&gt;投稿Xの本文。投稿Xの本文。&quot;</span><span class="fu">,</span></span>
<span id="cb9-4"><a href="#cb9-4"></a>  <span class="dt">&quot;coverImageURL&quot;</span><span class="fu">:</span> <span class="st">&quot;https://....&quot;</span><span class="fu">,</span></span>
<span id="cb9-5"><a href="#cb9-5"></a>  <span class="dt">&quot;categoryIds&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb9-6"><a href="#cb9-6"></a>    <span class="st">&quot;d3e10601-3cfa-48f3-9ede-886647a1063b&quot;</span><span class="ot">,</span></span>
<span id="cb9-7"><a href="#cb9-7"></a>    <span class="st">&quot;5a8d8365-e435-4ed4-a05e-34237c1b2ff0&quot;</span></span>
<span id="cb9-8"><a href="#cb9-8"></a>  <span class="ot">]</span></span>
<span id="cb9-9"><a href="#cb9-9"></a><span class="fu">}</span></span></code></pre></div>
      <p>投稿記事の追加は、次のような点を考慮する必要があるため、前回講義の<a
      href="lecture08.html#カテゴリを追加するウェブapiの実装">カテゴリの追加</a>よりも複雑な処理になります。</p>
      <ol type="1">
      <li><strong>リクエストボディのバリエーション (データ検証) の処理</strong></li>
      <li><strong>categoryIdsの要素に一致するIDを持ったカテゴリが存在しない場合の処理</strong></li>
      <li><strong>中間テーブルにレコードを追加する処理</strong></li>
      </ol>
      <p>まず、「<strong>1番目</strong>」の<strong>バリエーション</strong>ですが、これはカテゴリの追加においても<strong>本来は必要だった処理</strong>になります。具体的には、リクエストボディについて「<strong>必要なプロパティを持っているか</strong>」<span
      class="masked">「プロパティが期待する型であるか」</span>「<strong>文字数制限
      (例えば2文字以上32文字以内) が守られているか</strong>」<span
      class="masked">「URLとして適切な形式になっているか」</span>といったチェックをする処理になります。ここでは
      <strong>紙面の都合で省略</strong>します
      (余裕がある学生は実装して、バリエーションエラーがあれば <code>400 Bad Request</code>
      をレスポンスするようにしてください)。</p>
      <p>次に「<strong>2番目</strong>」ですが、これは「<strong>存在するカテゴリだけを投稿記事に紐づける</strong>」<span
      class="masked">「「存在しないカテゴリがあれば、エラーとしてリクエストを拒否する」</span>
      などが考えられますが、ここではリクエストを拒否する方針で設計します。</p>
      <p>「<strong>3番目</strong>」は必須の処理となります。</p>
      <p>以上を踏まえて投稿記事の追加するウェブAPIは、以下のように実装することができます。</p>
      <div class="sourceCode" id="cb10"
      data-caption="api/admin/posts/route.ts (投稿記事の追加)"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb10-1"><a href="#cb10-1"></a><span class="im">import</span> prisma <span class="im">from</span> <span class="st">&quot;@/lib/prisma&quot;</span><span class="op">;</span></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="im">import</span> { NextResponse<span class="op">,</span> NextRequest } <span class="im">from</span> <span class="st">&quot;next/server&quot;</span><span class="op">;</span></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="im">import</span> { Post } <span class="im">from</span> <span class="st">&quot;@prisma/client&quot;</span><span class="op">;</span></span>
<span id="cb10-4"><a href="#cb10-4"></a></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="kw">type</span> RequestBody <span class="op">=</span> {</span>
<span id="cb10-6"><a href="#cb10-6"></a>  title<span class="op">:</span> <span class="dt">string</span><span class="op">;</span></span>
<span id="cb10-7"><a href="#cb10-7"></a>  content<span class="op">:</span> <span class="dt">string</span><span class="op">;</span></span>
<span id="cb10-8"><a href="#cb10-8"></a>  coverImageURL<span class="op">:</span> <span class="dt">string</span><span class="op">;</span></span>
<span id="cb10-9"><a href="#cb10-9"></a>  categoryIds<span class="op">:</span> <span class="dt">string</span>[]<span class="op">;</span></span>
<span id="cb10-10"><a href="#cb10-10"></a>}<span class="op">;</span></span>
<span id="cb10-11"><a href="#cb10-11"></a></span>
<span id="cb10-12"><a href="#cb10-12"></a><span class="im">export</span> <span class="kw">const</span> POST <span class="op">=</span> <span class="kw">async</span> (req<span class="op">:</span> NextRequest) <span class="kw">=&gt;</span> {</span>
<span id="cb10-13"><a href="#cb10-13"></a>  <span class="cf">try</span> {</span>
<span id="cb10-14"><a href="#cb10-14"></a>    <span class="kw">const</span> requestBody<span class="op">:</span> RequestBody <span class="op">=</span> <span class="cf">await</span> req<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb10-15"><a href="#cb10-15"></a></span>
<span id="cb10-16"><a href="#cb10-16"></a>    <span class="co">// 分割代入</span></span>
<span id="cb10-17"><a href="#cb10-17"></a>    <span class="kw">const</span> { title<span class="op">,</span> content<span class="op">,</span> coverImageURL<span class="op">,</span> categoryIds } <span class="op">=</span> requestBody<span class="op">;</span></span>
<span id="cb10-18"><a href="#cb10-18"></a></span>
<span id="cb10-19"><a href="#cb10-19"></a>    <span class="co">// categoryIds で指定されるカテゴリがDB上に存在するか確認</span></span>
<span id="cb10-20"><a href="#cb10-20"></a>    <span class="kw">const</span> categories <span class="op">=</span> <span class="cf">await</span> prisma<span class="op">.</span><span class="at">category</span><span class="op">.</span><span class="fu">findMany</span>({</span>
<span id="cb10-21"><a href="#cb10-21"></a>      where<span class="op">:</span> {</span>
<span id="cb10-22"><a href="#cb10-22"></a>        id<span class="op">:</span> {</span>
<span id="cb10-23"><a href="#cb10-23"></a>          <span class="kw">in</span><span class="op">:</span> categoryIds<span class="op">,</span></span>
<span id="cb10-24"><a href="#cb10-24"></a>        }<span class="op">,</span></span>
<span id="cb10-25"><a href="#cb10-25"></a>      }<span class="op">,</span></span>
<span id="cb10-26"><a href="#cb10-26"></a>    })<span class="op">;</span></span>
<span id="cb10-27"><a href="#cb10-27"></a>    <span class="cf">if</span> (categories<span class="op">.</span><span class="at">length</span> <span class="op">!==</span> categoryIds<span class="op">.</span><span class="at">length</span>) {</span>
<span id="cb10-28"><a href="#cb10-28"></a>      <span class="cf">return</span> NextResponse<span class="op">.</span><span class="fu">json</span>(</span>
<span id="cb10-29"><a href="#cb10-29"></a>        { error<span class="op">:</span> <span class="st">&quot;指定されたカテゴリのいくつかが存在しません&quot;</span> }<span class="op">,</span></span>
<span id="cb10-30"><a href="#cb10-30"></a>        { status<span class="op">:</span> <span class="dv">400</span> } <span class="co">// 400: Bad Request</span></span>
<span id="cb10-31"><a href="#cb10-31"></a>      )<span class="op">;</span></span>
<span id="cb10-32"><a href="#cb10-32"></a>    }</span>
<span id="cb10-33"><a href="#cb10-33"></a></span>
<span id="cb10-34"><a href="#cb10-34"></a>    <span class="co">// 投稿記事テーブルにレコードを追加</span></span>
<span id="cb10-35"><a href="#cb10-35"></a>    <span class="kw">const</span> post<span class="op">:</span> Post <span class="op">=</span> <span class="cf">await</span> prisma<span class="op">.</span><span class="at">post</span><span class="op">.</span><span class="fu">create</span>({</span>
<span id="cb10-36"><a href="#cb10-36"></a>      data<span class="op">:</span> {</span>
<span id="cb10-37"><a href="#cb10-37"></a>        title<span class="op">,</span> <span class="co">// title: title の省略形であることに注意。以下も同様</span></span>
<span id="cb10-38"><a href="#cb10-38"></a>        content<span class="op">,</span></span>
<span id="cb10-39"><a href="#cb10-39"></a>        coverImageURL<span class="op">,</span></span>
<span id="cb10-40"><a href="#cb10-40"></a>      }<span class="op">,</span></span>
<span id="cb10-41"><a href="#cb10-41"></a>    })<span class="op">;</span></span>
<span id="cb10-42"><a href="#cb10-42"></a></span>
<span id="cb10-43"><a href="#cb10-43"></a>    <span class="co">// 中間テーブルにレコードを追加</span></span>
<span id="cb10-44"><a href="#cb10-44"></a>    <span class="cf">for</span> (<span class="kw">const</span> categoryId <span class="kw">of</span> categoryIds) {</span>
<span id="cb10-45"><a href="#cb10-45"></a>      <span class="cf">await</span> prisma<span class="op">.</span><span class="at">postCategory</span><span class="op">.</span><span class="fu">create</span>({</span>
<span id="cb10-46"><a href="#cb10-46"></a>        data<span class="op">:</span> {</span>
<span id="cb10-47"><a href="#cb10-47"></a>          postId<span class="op">:</span> post<span class="op">.</span><span class="at">id</span><span class="op">,</span></span>
<span id="cb10-48"><a href="#cb10-48"></a>          categoryId<span class="op">:</span> categoryId<span class="op">,</span></span>
<span id="cb10-49"><a href="#cb10-49"></a>        }<span class="op">,</span></span>
<span id="cb10-50"><a href="#cb10-50"></a>      })<span class="op">;</span></span>
<span id="cb10-51"><a href="#cb10-51"></a>    }</span>
<span id="cb10-52"><a href="#cb10-52"></a></span>
<span id="cb10-53"><a href="#cb10-53"></a>    <span class="cf">return</span> NextResponse<span class="op">.</span><span class="fu">json</span>(post)<span class="op">;</span></span>
<span id="cb10-54"><a href="#cb10-54"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb10-55"><a href="#cb10-55"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(error)<span class="op">;</span></span>
<span id="cb10-56"><a href="#cb10-56"></a>    <span class="cf">return</span> NextResponse<span class="op">.</span><span class="fu">json</span>(</span>
<span id="cb10-57"><a href="#cb10-57"></a>      { error<span class="op">:</span> <span class="st">&quot;投稿記事の作成に失敗しました&quot;</span> }<span class="op">,</span></span>
<span id="cb10-58"><a href="#cb10-58"></a>      { status<span class="op">:</span> <span class="dv">500</span> }</span>
<span id="cb10-59"><a href="#cb10-59"></a>    )<span class="op">;</span></span>
<span id="cb10-60"><a href="#cb10-60"></a>  }</span>
<span id="cb10-61"><a href="#cb10-61"></a>}<span class="op">;</span></span></code></pre></div>
      <p><strong>第05行目</strong> から <strong>第10行目</strong>
      では、POSTリクエストの「ボディ」として想定される <strong>JSONデータ</strong>
      に適合する「型」を定義しています
      (他のAPIでも同じ型を使う場合は、別ファイルに定義してインポートするほうが望ましいです)。また、<strong>第14行目</strong>
      では、リクエストのボディのボディ (＝<span
      class="masked">あくまでJSONフォーマットに従って書かれた文字列</span>)
      を、JavaScriptオブジェクトに変換して <code>requestBody</code> に代入しています。</p>
      <p><strong>第20行目</strong> から <strong>第32行目</strong> では「リクエストボディの
      <code>categoryIds</code>
      に含まれるIDのカテゴリがDBに存在するか」を確認し、存在しないカテゴリがあれば、ステータスコード<a
      href="https://developer.mozilla.org/ja/docs/Web/HTTP/Status/400">400</a>を返して処理を中断するようにしています。ここでは
      <code>prisma.category.findMany</code> の引数を <code>where: {id: {in: categoryIds } }</code>
      とすることで「<strong>categoryIds
      配列の各要素に対応するカテゴリIDを一括検索する処理</strong>」を実行しています (<code>in</code>
      演算子によって、指定された複数の値に一致するレコードを効率的に取得しています)。これにより、<span
      class="masked">forループなどの繰り返し処理を使用することなく</span>
      配列の要素に対応するカテゴリを一度の操作で取得することが可能になります。取得したレコード数と
      <code>categoryIds</code> の要素数を比較し、一致しない場合は <span
      class="masked">指定されたカテゴリIDの一部がDBに存在しない</span>
      と判断してステータスコード「400」を返しています。</p>
      <div class="note type-tips">
      <p><strong>参考情報</strong></p>
      <p>次の <strong>PrismaClientの処理</strong> (TypeScriptプログラム) は、</p>
      <div class="sourceCode" id="cb11"><pre class="sourceCode ts"><code class="sourceCode typescript"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>prisma<span class="op">.</span><span class="at">category</span><span class="op">.</span><span class="fu">findMany</span>( { where<span class="op">:</span> { id<span class="op">:</span> { <span class="kw">in</span><span class="op">:</span> [<span class="st">&quot;c-001&quot;</span><span class="op">,</span><span class="st">&quot;c-002&quot;</span><span class="op">,</span><span class="st">&quot;c-003&quot;</span>] }}} )<span class="op">;</span></span></code></pre></div>
      <p>次の <strong>SQL</strong> と同等になります。</p>
      <div class="sourceCode" id="cb12"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> <span class="kw">category</span> <span class="kw">WHERE</span> <span class="kw">id</span> <span class="kw">IN</span> (<span class="st">&#39;c-001&#39;</span>, <span class="st">&#39;c-002&#39;</span>, <span class="st">&#39;c-003&#39;</span>);</span></code></pre></div>
      </div>
      <p><strong>第44行目</strong> から <strong>第51行目</strong> では、中間テーブル
      (<code>postCategory</code>)
      に、投稿記事とカテゴリを紐づけるためのレコードを挿入しています。</p>
      <p>各処理の概要が理解できたら、<strong>TunderClient</strong> と <strong>Prisma Studio</strong>
      を利用してエンドポイント <code>/api/admin/posts</code>
      の動作確認を行ってください。この際、<strong>あえて誤ったボディ</strong>
      (例えば、存在しないカテゴリIDを含むデータなど) を与え、そのレスポンスや <span
      class="masked">VSCodeのターミナルに出力されるエラーメッセージ</span>
      がどのようになるかを確認してください。</p>
      <figure>
      <img src="figs/09/vscode_01.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <h3 data-number="2.3.1" id="演習-10分"><span class="header-section-number">2.3.1</span> 演習
      (<i class="fa-solid fa-stopwatch"></i>10分)</h3>
      <p>次のような「誤った書式のJSON文字列」をボディに与えてリクエストを送ったとき、VSCodeのターミナルにはどのようなエラーメッセージが出力されるか確認してください。</p>
      <div class="sourceCode" id="cb13"
      data-caption="書式に誤りのあるJSON: プロパティ名をダブルクォーテーションで囲んでいない"><pre
      class="sourceCode numberSource json numberLines"><code class="sourceCode json"><span id="cb13-1"><a href="#cb13-1"></a><span class="fu">{</span></span>
<span id="cb13-2"><a href="#cb13-2"></a>  <span class="er">title</span><span class="fu">:</span> <span class="st">&quot;投稿X&quot;</span><span class="fu">,</span></span>
<span id="cb13-3"><a href="#cb13-3"></a>  <span class="er">content</span><span class="fu">:</span> <span class="st">&quot;投稿Xの本文。&lt;br/&gt;投稿Xの本文。投稿Xの本文。&quot;</span><span class="fu">,</span></span>
<span id="cb13-4"><a href="#cb13-4"></a>  <span class="er">coverImageURL</span><span class="fu">:</span> <span class="st">&quot;https://....&quot;</span><span class="fu">,</span></span>
<span id="cb13-5"><a href="#cb13-5"></a>  <span class="er">categoryIds</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb13-6"><a href="#cb13-6"></a>    <span class="st">&quot;d3e10601-3cfa-48f3-9ede-886647a1063b&quot;</span><span class="ot">,</span></span>
<span id="cb13-7"><a href="#cb13-7"></a>    <span class="st">&quot;5a8d8365-e435-4ed4-a05e-34237c1b2ff0&quot;</span></span>
<span id="cb13-8"><a href="#cb13-8"></a>  <span class="ot">]</span></span>
<span id="cb13-9"><a href="#cb13-9"></a><span class="fu">}</span></span></code></pre></div>
      <div class="sourceCode" id="cb14"
      data-caption="書式に誤りのあるJSON: 配列の末尾にカンマが付いている"><pre
      class="sourceCode numberSource json numberLines"><code class="sourceCode json"><span id="cb14-1"><a href="#cb14-1"></a><span class="fu">{</span></span>
<span id="cb14-2"><a href="#cb14-2"></a>  <span class="dt">&quot;title&quot;</span><span class="fu">:</span> <span class="st">&quot;投稿X&quot;</span><span class="fu">,</span></span>
<span id="cb14-3"><a href="#cb14-3"></a>  <span class="dt">&quot;content&quot;</span><span class="fu">:</span> <span class="st">&quot;投稿Xの本文。&lt;br/&gt;投稿Xの本文。投稿Xの本文。&quot;</span><span class="fu">,</span></span>
<span id="cb14-4"><a href="#cb14-4"></a>  <span class="dt">&quot;coverImageURL&quot;</span><span class="fu">:</span> <span class="st">&quot;https://....&quot;</span><span class="fu">,</span></span>
<span id="cb14-5"><a href="#cb14-5"></a>  <span class="dt">&quot;categoryIds&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb14-6"><a href="#cb14-6"></a>    <span class="st">&quot;d3e10601-3cfa-48f3-9ede-886647a1063b&quot;</span><span class="ot">,</span></span>
<span id="cb14-7"><a href="#cb14-7"></a>    <span class="st">&quot;5a8d8365-e435-4ed4-a05e-34237c1b2ff0&quot;</span><span class="ot">,</span></span>
<span id="cb14-8"><a href="#cb14-8"></a>  <span class="ot">]</span></span>
<span id="cb14-9"><a href="#cb14-9"></a><span class="fu">}</span></span></code></pre></div>
      <div class="note type-senior">
      <p><strong>EX: より高度でエレガント実装✨</strong></p>
      <p>投稿記事とカテゴリを紐付ける「中間テーブルへのレコードの挿入」については、前回講義の<a
      href="lecture08.html#dbの初期データの作成">DBの初期データの作成</a>で示した
      <code>seed.ts</code> の <strong>第23行目</strong> から <strong>第25行目</strong> のように
      <span class="masked">Prismaのリレーションを使用した一括作成機能</span>
      を利用することで、より効率的な実装ができます。</p>
      <p>実装例は<a
      href="https://github.com/TakeshiWada1980/Programming3-2024/blob/main/docs/codes/09/code02.ts">こちら<i class="fa-solid fa-person-chalkboard"></i></a>を参照してください。</p>
      <p>また、さらに、この実装では「<strong>カテゴリが存在することを事前確認せずに処理すること</strong>」が可能になります。投稿記事を作成する際に、存在しないカテゴリIDが与えられると、<strong>データベースの外部キー制約</strong>によってエラーが発生し、それを適切にハンドリングすることでステータスコード「400」を返すことができるようになります。</p>
      </div>
      <h2 data-number="2.4" id="宿題-単一の投稿記事を取得するウェブapiの実装"><span
      class="header-section-number">2.4</span> 宿題⛄: 単一の投稿記事を取得するウェブAPIの実装</h2>
      <p><code>/api/posts/[id]</code> というエンドポイントに、単一の投稿記事を取得するウェブAPI
      (<strong>GET Method</strong>に対応) を実装してください。</p>
      <p>URLパスで与える <code>id</code> に一致する投稿記事が <strong>存在したとき</strong>
      は、ステータスコード「<strong>200 OK</strong>」で以下のような JSON
      が返ってくるようにしてください。</p>
      <div class="sourceCode" id="cb15"
      data-caption="GET /api/posts/[id] の 200 のレスポンス(例)"><pre
      class="sourceCode numberSource json numberLines"><code class="sourceCode json"><span id="cb15-1"><a href="#cb15-1"></a><span class="fu">{</span></span>
<span id="cb15-2"><a href="#cb15-2"></a>  <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;58169a35-8f4c-4f62-b50b-876f254ef3a3&quot;</span><span class="fu">,</span></span>
<span id="cb15-3"><a href="#cb15-3"></a>  <span class="dt">&quot;title&quot;</span><span class="fu">:</span> <span class="st">&quot;投稿1&quot;</span><span class="fu">,</span></span>
<span id="cb15-4"><a href="#cb15-4"></a>  <span class="dt">&quot;content&quot;</span><span class="fu">:</span> <span class="st">&quot;投稿1の本文。&lt;br/&gt;投稿1の本文。投稿1の本文。&quot;</span><span class="fu">,</span></span>
<span id="cb15-5"><a href="#cb15-5"></a>  <span class="dt">&quot;coverImageURL&quot;</span><span class="fu">:</span> <span class="st">&quot;https://...&quot;</span><span class="fu">,</span></span>
<span id="cb15-6"><a href="#cb15-6"></a>  <span class="dt">&quot;createdAt&quot;</span><span class="fu">:</span> <span class="st">&quot;2024-12-08T12:00:42.720Z&quot;</span><span class="fu">,</span></span>
<span id="cb15-7"><a href="#cb15-7"></a>  <span class="dt">&quot;updatedAt&quot;</span><span class="fu">:</span> <span class="st">&quot;2024-12-08T12:00:42.720Z&quot;</span><span class="fu">,</span></span>
<span id="cb15-8"><a href="#cb15-8"></a>  <span class="dt">&quot;categories&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb15-9"><a href="#cb15-9"></a>    <span class="fu">{</span></span>
<span id="cb15-10"><a href="#cb15-10"></a>      <span class="dt">&quot;category&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb15-11"><a href="#cb15-11"></a>        <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;ad28ee69-359f-4d66-aaea-1680c97347b8&quot;</span><span class="fu">,</span></span>
<span id="cb15-12"><a href="#cb15-12"></a>        <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;カテゴリ1&quot;</span></span>
<span id="cb15-13"><a href="#cb15-13"></a>      <span class="fu">}</span></span>
<span id="cb15-14"><a href="#cb15-14"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb15-15"><a href="#cb15-15"></a>    <span class="fu">{</span></span>
<span id="cb15-16"><a href="#cb15-16"></a>      <span class="dt">&quot;category&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb15-17"><a href="#cb15-17"></a>        <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;f6a99736-ad29-493b-8323-c3b10c6390c2&quot;</span><span class="fu">,</span></span>
<span id="cb15-18"><a href="#cb15-18"></a>        <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;カテゴリ2&quot;</span></span>
<span id="cb15-19"><a href="#cb15-19"></a>      <span class="fu">}</span></span>
<span id="cb15-20"><a href="#cb15-20"></a>    <span class="fu">}</span></span>
<span id="cb15-21"><a href="#cb15-21"></a>  <span class="ot">]</span></span>
<span id="cb15-22"><a href="#cb15-22"></a><span class="fu">}</span></span></code></pre></div>
      <p>また、<code>id</code> に一致する <strong>投稿記事が存在しなかったとき</strong>
      は、ステータスコード「<strong>404 Not Found</strong>」で以下のような JSON
      が返ってくるようにしてください。</p>
      <div class="sourceCode" id="cb16"
      data-caption="GET /api/posts/[id] の 404 のレスポンス(例)"><pre
      class="sourceCode numberSource json numberLines"><code class="sourceCode json"><span id="cb16-1"><a href="#cb16-1"></a><span class="fu">{</span></span>
<span id="cb16-2"><a href="#cb16-2"></a>  <span class="dt">&quot;error&quot;</span><span class="fu">:</span> <span class="st">&quot;id=&#39;0120-00-9696&#39;の投稿記事は見つかりませんでした&quot;</span></span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="fu">}</span></span></code></pre></div>
      <ul>
      <li>URLパスのパラメータプレースホルダ <code>[id]</code> の処理については、前回講義の<a
      href="lecture08.html#カテゴリを削除するウェブapiの実装">こちら</a>を参考にしてください。</li>
      <li>単一のレコードの取得には <code>findUnique</code> メソッドを使用してください。
      <ul>
      <li><code>where</code> で指定する条件に一致するレコードが存在しない場合は <code>null</code>
      が戻り値となります (厳密には <code>await</code> した Promise の結果として <code>null</code>
      が返されます)。</li>
      </ul></li>
      </ul>
      <p>どうしても実装できないときは<a
      href="https://github.com/TakeshiWada1980/Programming3-2024/blob/main/docs/codes/09/code03.ts">こちら<i class="fa-solid fa-person-chalkboard"></i></a>を参考にしてください。</p>
      <h2 data-number="2.5" id="宿題-投稿記事を削除するウェブapiの実装"><span
      class="header-section-number">2.5</span> 宿題⛄: 投稿記事を削除するウェブAPIの実装</h2>
      <p><code>/api/admin/posts/[id]</code>
      というエンドポイントに、<strong>投稿記事を削除するウェブAPI</strong> (<strong>DELETE
      Method</strong> に対応) を実装してください。</p>
      <p>URLパスで与える <code>id</code>
      に一致する投稿記事が「<strong>削除できたとき</strong>」は、ステータスコード「<strong>200
      OK</strong>」で以下のようなJSONデータが返ってくるようにしてください。</p>
      <div class="sourceCode" id="cb17"
      data-caption="DELETE /api/admin/posts/[id] の 200 のレスポンス(例)"><pre
      class="sourceCode numberSource json numberLines"><code class="sourceCode json"><span id="cb17-1"><a href="#cb17-1"></a><span class="fu">{</span></span>
<span id="cb17-2"><a href="#cb17-2"></a>  <span class="dt">&quot;msg&quot;</span><span class="fu">:</span> <span class="st">&quot;「投稿X」を削除しました。&quot;</span></span>
<span id="cb17-3"><a href="#cb17-3"></a><span class="fu">}</span></span></code></pre></div>
      <p>また、id
      に一致する投稿記事が存在しないなどの理由で「<strong>削除できなかったとき</strong>」は、ステータスコード「<strong>500
      Internal Server Error</strong>」で以下のJSONデータが返ってくるようにしてください。</p>
      <div class="sourceCode" id="cb18"
      data-caption="DELETE /api/admin/posts/[id] の 500 のレスポンス(例)"><pre
      class="sourceCode numberSource json numberLines"><code class="sourceCode json"><span id="cb18-1"><a href="#cb18-1"></a><span class="fu">{</span></span>
<span id="cb18-2"><a href="#cb18-2"></a>  <span class="dt">&quot;error&quot;</span><span class="fu">:</span> <span class="st">&quot;投稿記事の削除に失敗しました&quot;</span></span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="fu">}</span></span></code></pre></div>
      <p>どうしても実装できないときは<a
      href="https://github.com/TakeshiWada1980/Programming3-2024/blob/main/docs/codes/09/code04.ts">こちら<i class="fa-solid fa-person-chalkboard"></i></a>を参考にしてください。</p>
      <h2 data-number="2.6" id="宿題-投稿記事の内容を変更-更新-するウェブapiの実装"><span
      class="header-section-number">2.6</span> 宿題⛄: 投稿記事の内容を変更 (更新)
      するウェブAPIの実装</h2>
      <p><code>/api/admin/posts/[id]</code> というエンドポイントに、<strong>投稿記事を変更 (更新)
      するウェブAPI</strong> (<strong>PUT Method</strong> に対応)
      を実装してください。このエンドポイントは <span
      class="masked">先ほどの「投稿記事の削除」と同じ</span> です。<code>DELETE</code>
      関数を記述したファイルに<strong>追記するように</strong> <code>PUT</code>
      関数を実装してください。</p>
      <p>PUTリクエストのボディは、POSTメソッドと同じ形式のJSONデータを想定してください。</p>
      <div class="sourceCode" id="cb19"
      data-caption="PUT /api/admin/post/[id] へのリクエストのボディ(例)"><pre
      class="sourceCode numberSource json numberLines"><code class="sourceCode json"><span id="cb19-1"><a href="#cb19-1"></a><span class="fu">{</span></span>
<span id="cb19-2"><a href="#cb19-2"></a>  <span class="dt">&quot;title&quot;</span><span class="fu">:</span> <span class="st">&quot;投稿Z&quot;</span><span class="fu">,</span></span>
<span id="cb19-3"><a href="#cb19-3"></a>  <span class="dt">&quot;content&quot;</span><span class="fu">:</span> <span class="st">&quot;投稿Zの本文。&lt;br/&gt;投稿Zの本文。投稿Zの本文。&quot;</span><span class="fu">,</span></span>
<span id="cb19-4"><a href="#cb19-4"></a>  <span class="dt">&quot;coverImageURL&quot;</span><span class="fu">:</span> <span class="st">&quot;https://....&quot;</span><span class="fu">,</span></span>
<span id="cb19-5"><a href="#cb19-5"></a>  <span class="dt">&quot;categoryIds&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb19-6"><a href="#cb19-6"></a>    <span class="st">&quot;d3e10601-3cfa-48f3-9ede-886647a1063b&quot;</span><span class="ot">,</span></span>
<span id="cb19-7"><a href="#cb19-7"></a>    <span class="st">&quot;5a8d8365-e435-4ed4-a05e-34237c1b2ff0&quot;</span></span>
<span id="cb19-8"><a href="#cb19-8"></a>  <span class="ot">]</span></span>
<span id="cb19-9"><a href="#cb19-9"></a><span class="fu">}</span></span></code></pre></div>
      <p>データベースに <code>id</code>
      に一致する投稿記事が存在し「<strong>内容を変更できたとき</strong>」は、ステータスコード「<strong>200
      OK</strong>」で以下のようなJSONデータ (更新された内容) が返ってくるようにしてください
      (カテゴリの情報は不要です)。</p>
      <div class="sourceCode" id="cb20"
      data-caption="PUT /api/admin/posts/[id] の 200 のレスポンス(例)"><pre
      class="sourceCode numberSource json numberLines"><code class="sourceCode json"><span id="cb20-1"><a href="#cb20-1"></a><span class="fu">{</span></span>
<span id="cb20-2"><a href="#cb20-2"></a>  <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;0d2f8c7e-08c4-4aa5-8ed7-a46d9a1ef3be&quot;</span><span class="fu">,</span></span>
<span id="cb20-3"><a href="#cb20-3"></a>  <span class="dt">&quot;title&quot;</span><span class="fu">:</span> <span class="st">&quot;投稿Z&quot;</span><span class="fu">,</span></span>
<span id="cb20-4"><a href="#cb20-4"></a>  <span class="dt">&quot;content&quot;</span><span class="fu">:</span> <span class="st">&quot;投稿Zの本文。&lt;br/&gt;投稿Zの本文。投稿Zの本文。&quot;</span><span class="fu">,</span></span>
<span id="cb20-5"><a href="#cb20-5"></a>  <span class="dt">&quot;coverImageURL&quot;</span><span class="fu">:</span> <span class="st">&quot;https://....&quot;</span><span class="fu">,</span></span>
<span id="cb20-6"><a href="#cb20-6"></a>  <span class="dt">&quot;createdAt&quot;</span><span class="fu">:</span> <span class="st">&quot;2024-12-10T08:51:42.829Z&quot;</span><span class="fu">,</span></span>
<span id="cb20-7"><a href="#cb20-7"></a>  <span class="dt">&quot;updatedAt&quot;</span><span class="fu">:</span> <span class="st">&quot;2024-12-11T05:33:45.884Z&quot;</span></span>
<span id="cb20-8"><a href="#cb20-8"></a><span class="fu">}</span></span></code></pre></div>
      <p>「<strong>内容を変更できなかったとき</strong>」は、ステータスコード「<strong>500 Internal
      Server Error</strong>」で以下のJSONデータが返ってくるようにしてください
      (カテゴリの情報は不要です)。</p>
      <div class="sourceCode" id="cb21"
      data-caption="PUT /api/admin/posts/[id] の 500 のレスポンス(例)"><pre
      class="sourceCode numberSource json numberLines"><code class="sourceCode json"><span id="cb21-1"><a href="#cb21-1"></a><span class="fu">{</span></span>
<span id="cb21-2"><a href="#cb21-2"></a>  <span class="dt">&quot;error&quot;</span><span class="fu">:</span> <span class="st">&quot;投稿記事の変更に失敗しました&quot;</span></span>
<span id="cb21-3"><a href="#cb21-3"></a><span class="fu">}</span></span></code></pre></div>
      <p>次のことに注意して実装してください。</p>
      <ul>
      <li>投稿記事とカテゴリを紐付けする情報の更新は、まず、中間テーブルから現在の紐づけ情報を削除したあとに、中間テーブルに新しい紐付け情報を挿入という2段階で行なう必要があります。</li>
      <li>リクエストボディの <code>"categoryIds"</code>
      に不正な値が含まれているときに「<strong>タイトル、本文、カバーイメージURLは更新されたが、カテゴリ設定については失敗した</strong>」といった
      <strong>中途半端な状態 (データの整合性が保たれない状態) が生じないように実装</strong>
      してください。<code>prisma.post.update</code> を実行するよりも <code>"categoryIds"</code>
      の検証をするようにしてください。
      <ul>
      <li>あるいは [トランザクション] を利用して処理してください
      (トランザクションの利用は必須ではありません)。</li>
      </ul></li>
      </ul>
      <p><strong>(プロンプト例)</strong></p>
      <blockquote>
      <p>RDBにおけるトランザクションの概念について教えてください。</p>
      </blockquote>
      <blockquote>
      <p>Prisma
      でトランザクションを使う方法を解説してください。投稿記事とカテゴリが「多対多」の関係になっているブログデータで更新
      (UPDATE) を実行するケースを題材に解説してください。</p>
      </blockquote>
      <p>どうしても実装できないときは<a
      href="https://github.com/TakeshiWada1980/Programming3-2024/blob/main/docs/codes/09/code05.ts">こちら<i class="fa-solid fa-person-chalkboard"></i></a>を参考にしてください。</p>
      <h2 data-number="2.7" id="情報の整理-サイトマップとapリスト"><span
      class="header-section-number">2.7</span> 情報の整理: サイトマップとAPリスト</h2>
      <p>ここまでの実装で、以下の9件が実装されているはずです。</p>
      <table>
      <thead>
      <tr class="header">
      <th>エンドポイント</th>
      <th>HTTP<br>Method</th>
      <th>処理</th>
      <th>管理者<br>権限</th>
      <th>リクエスト<br>ボディ</th>
      <th></th>
      </tr>
      </thead>
      <tbody>
      <tr class="odd">
      <td>/api/categories</td>
      <td>GET</td>
      <td>カテゴリの一覧を取得する</td>
      <td></td>
      <td></td>
      <td>第08回講義</td>
      </tr>
      <tr class="even">
      <td>/api/admin/categories</td>
      <td>POST</td>
      <td>カテゴリを追加する</td>
      <td>必要</td>
      <td>必要</td>
      <td>第08回講義</td>
      </tr>
      <tr class="odd">
      <td>/api/admin/categories/[id]</td>
      <td>PUT</td>
      <td>カテゴリの名前を変更する</td>
      <td>必要</td>
      <td>必要</td>
      <td>第08回講義</td>
      </tr>
      <tr class="even">
      <td>/api/admin/categories/[id]</td>
      <td>DELETE</td>
      <td>カテゴリを削除する</td>
      <td>必要</td>
      <td></td>
      <td>第08回講義</td>
      </tr>
      <tr class="odd">
      <td>/api/posts</td>
      <td>GET</td>
      <td>投稿記事の一覧を取得する</td>
      <td></td>
      <td></td>
      <td>第09回講義</td>
      </tr>
      <tr class="even">
      <td>/api/posts/[id]</td>
      <td>GET</td>
      <td>投稿記事 (単一) を取得する</td>
      <td></td>
      <td></td>
      <td>宿題⛄ (課題2)</td>
      </tr>
      <tr class="odd">
      <td>/api/admin/posts</td>
      <td>POST</td>
      <td>投稿記事を追加する</td>
      <td>必要</td>
      <td>必要</td>
      <td>第09回講義</td>
      </tr>
      <tr class="even">
      <td>/api/admin/posts/[id]</td>
      <td>PUT</td>
      <td>投稿記事の内容を変更 (編集) する</td>
      <td>必要</td>
      <td>必要</td>
      <td>宿題⛄ (課題2)</td>
      </tr>
      <tr class="odd">
      <td>/api/admin/posts/[id]</td>
      <td>DELETE</td>
      <td>投稿記事を削除する</td>
      <td>必要</td>
      <td></td>
      <td>宿題⛄ (課題2)</td>
      </tr>
      </tbody>
      </table>
      <p>サイトマップ</p>
      <table>
      <thead>
      <tr class="header">
      <th>URL</th>
      <th>処理</th>
      <th>管理者権限</th>
      </tr>
      </thead>
      <tbody>
      <tr class="odd">
      <td>/</td>
      <td>投稿記事の一覧</td>
      <td></td>
      </tr>
      <tr class="even">
      <td>/about</td>
      <td>制作者プロフィール<br>このサイトについて</td>
      <td></td>
      </tr>
      <tr class="odd">
      <td>/posts/[id]</td>
      <td>投稿記事の詳細</td>
      <td></td>
      </tr>
      <tr class="even">
      <td>/admin/posts</td>
      <td>投稿記事の一覧<br>編集ページへのリンク、削除機能 (オプション)</td>
      <td>必要</td>
      </tr>
      <tr class="odd">
      <td>/admin/posts/new</td>
      <td>投稿記事の新規作成</td>
      <td>必要</td>
      </tr>
      <tr class="even">
      <td>/admin/posts/[id]</td>
      <td>投稿記事の編集 (削除を含む)</td>
      <td>必要</td>
      </tr>
      <tr class="odd">
      <td>/admin/categories</td>
      <td>カテゴリの一覧<br>編集ページへのリンク、削除機能 (オプション)</td>
      <td>必要</td>
      </tr>
      <tr class="even">
      <td>/admin/categories/new</td>
      <td>カテゴリの新規作成</td>
      <td>必要</td>
      </tr>
      <tr class="odd">
      <td>/admin/categories/[id]</td>
      <td>カテゴリの編集 (削除を含む)</td>
      <td>必要</td>
      </tr>
      </tbody>
      </table>
      <h1 data-number="3" id="カテゴリの新規作成ページの実装"><span
      class="header-section-number">3</span> カテゴリの新規作成ページの実装</h1>
      <p>フロントエンド開発に戻って、ここまでに作成した各ウェブAPIを呼び出すためのページを実装します。まずは、<code>/admin/categories/new</code>
      に以下のような「<strong>カテゴリの新規作成</strong>」のページを実装していきます。</p>
      <figure>
      <img src="figs/09/app_01.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <h2 data-number="3.1" id="準備-1"><span class="header-section-number">3.1</span> 準備</h2>
      <p>ここでは、<strong>以下のウェブAPIが実装されていること</strong>を前提とします
      (いずれも前回授業で実装済みです)。</p>
      <table>
      <thead>
      <tr class="header">
      <th>エンドポイント</th>
      <th>HTTP Method</th>
      <th>処理</th>
      </tr>
      </thead>
      <tbody>
      <tr class="odd">
      <td>/api/categories</td>
      <td>GET</td>
      <td>カテゴリの一覧を取得する</td>
      </tr>
      <tr class="even">
      <td>/api/admin/categories</td>
      <td>POST</td>
      <td>カテゴリを追加する</td>
      </tr>
      </tbody>
      </table>
      <p>カテゴリの一覧を <code>/api/categories</code>
      のレスポンスは、次のようなJSON形式になっていることを <strong>ThunderClinet</strong> で
      <strong>必ず確認</strong> しておいてください。問題があれば、前回の<a
      href="lecture08.html#カテゴリの一覧を取得するウェブapiの実装">講義資料</a>を参照して修正してください。</p>
      <div class="sourceCode" id="cb22" data-caption="GET /api/categories"><pre
      class="sourceCode numberSource json numberLines"><code class="sourceCode json"><span id="cb22-1"><a href="#cb22-1"></a><span class="ot">[</span></span>
<span id="cb22-2"><a href="#cb22-2"></a>  <span class="fu">{</span></span>
<span id="cb22-3"><a href="#cb22-3"></a>    <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;db450dc7-a73b-4311-8b70-3af652efd144&quot;</span><span class="fu">,</span></span>
<span id="cb22-4"><a href="#cb22-4"></a>    <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;カテゴリ4&quot;</span><span class="fu">,</span></span>
<span id="cb22-5"><a href="#cb22-5"></a>    <span class="dt">&quot;createdAt&quot;</span><span class="fu">:</span> <span class="st">&quot;2024-12-08T12:00:42.713Z&quot;</span><span class="fu">,</span></span>
<span id="cb22-6"><a href="#cb22-6"></a>    <span class="dt">&quot;updatedAt&quot;</span><span class="fu">:</span> <span class="st">&quot;2024-12-08T12:00:42.713Z&quot;</span></span>
<span id="cb22-7"><a href="#cb22-7"></a>  <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb22-8"><a href="#cb22-8"></a>  <span class="er">//</span> <span class="er">...略...</span></span>
<span id="cb22-9"><a href="#cb22-9"></a>  <span class="fu">{</span></span>
<span id="cb22-10"><a href="#cb22-10"></a>    <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;ad28ee69-359f-4d66-aaea-1680c97347b8&quot;</span><span class="fu">,</span></span>
<span id="cb22-11"><a href="#cb22-11"></a>    <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;カテゴリ1&quot;</span><span class="fu">,</span></span>
<span id="cb22-12"><a href="#cb22-12"></a>    <span class="dt">&quot;createdAt&quot;</span><span class="fu">:</span> <span class="st">&quot;2024-12-08T12:00:42.695Z&quot;</span><span class="fu">,</span></span>
<span id="cb22-13"><a href="#cb22-13"></a>    <span class="dt">&quot;updatedAt&quot;</span><span class="fu">:</span> <span class="st">&quot;2024-12-08T12:00:42.695Z&quot;</span></span>
<span id="cb22-14"><a href="#cb22-14"></a>  <span class="fu">}</span></span>
<span id="cb22-15"><a href="#cb22-15"></a><span class="ot">]</span></span></code></pre></div>
      <p>また、カテゴリを追加 (新規作成) する <code>/api/categories</code>
      は、次のようなJSON形式のリクエストボディを受付けることを <strong>ThunderClinet</strong> で
      <strong>必ず確認</strong> 確認しておいてください。問題があれば、前回の<a
      href="lecture08.html#カテゴリを追加するウェブapiの実装-コードの解説">講義資料</a>を参照して修正してください。</p>
      <div class="sourceCode" id="cb23"
      data-caption="POST /api/admin/categories のリクエストボディ"><pre
      class="sourceCode numberSource json numberLines"><code class="sourceCode json"><span id="cb23-1"><a href="#cb23-1"></a><span class="fu">{</span></span>
<span id="cb23-2"><a href="#cb23-2"></a>  <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;カテゴリ5&quot;</span></span>
<span id="cb23-3"><a href="#cb23-3"></a><span class="fu">}</span></span></code></pre></div>
      <h2 data-number="3.2" id="画面の実装-postリクエストの処理を除く"><span
      class="header-section-number">3.2</span> 画面の実装 (POSTリクエストの処理を除く)</h2>
      <p><code>/api/admin/categories</code> に対する <strong>POSTリクエスト処理</strong> と
      <strong>バリデーション処理</strong> を除いた実装例を<a
      href="https://github.com/TakeshiWada1980/Programming3-2024/blob/main/docs/codes/09/code06.ts">こちら<i class="fa-solid fa-person-chalkboard"></i></a>に示します。</p>
      <p>比較的に長いコードになりますが、まずは動作確認してから、じっくりと読解に努めてください。</p>
      <p>テキストボックスやバリデーション関連の処理については<a
      href="lecture07.html">第05回講義</a>(Todoアプリ開発)
      のほぼ復習となります。また、カテゴリの一覧の取得処理
      (<strong>第29行目</strong>から<strong>第69行目</strong>の内容) は、<a
      href="lecture07.html#ブログ記事一覧の表示">第07回講義</a>(microCMSからのデータフェッチ)
      の復習となります。</p>
      <h2 data-number="3.3" id="画面の実装-postリクエストの処理を除く-1"><span
      class="header-section-number">3.3</span> 画面の実装 (POSTリクエストの処理を除く)</h2>
      <h1 data-number="4" id="冬休みの宿題"><span class="header-section-number">4</span>
      冬休みの宿題</h1>
      <p>次回の授業は、年明けの <strong>1月9日(木)</strong> となります。</p>
      <!-- ---------------------------------------- -->
    </main>

    <footer class="markdown-body">
      <p><a href="https://takeshiwada1980.github.io/Programming3-2024/">講義資料のIndexに移動</a></p>
    </footer>

    <script>
      window.onload = function () {
        // ナビゲーション関連
        let openBtn = document.getElementsByClassName("openbtn")[0];
        let navPnl = document.getElementById("g-nav");
        openBtn.onclick = () => {
          openBtn.classList.toggle("active");
          navPnl.classList.toggle("panelactive");
        };

        let items = navPnl.getElementsByTagName("a");
        Array.from(items).forEach((item) => {
          item.onclick = () => {
            openBtn.classList.toggle("active");
            navPnl.classList.toggle("panelactive");
          };
        });

        // マスク処理
        let maskedSpans = document.getElementsByClassName("masked");
        Array.from(maskedSpans).forEach((span) => {
          span.onclick = () => {
            span.classList.toggle("open");
          };
        });

        // data-startfrom 属性の行番号カウンタのリセット
        document.querySelectorAll("div.sourceCode").forEach(function (div) {
          var startFrom = div.getAttribute("data-startfrom");
          if (startFrom != null) {
            div.style.counterReset = "pg-line " + (startFrom - 1);
          }
        });

        // 画像にリンクを付与
        // let images = document.querySelectorAll("figure img");
        // Array.from(images).forEach((img) => {
        //   img.onclick = () => {
        //     location.href = img.getAttribute("src");
        //   };
        // });
      };
    </script>
  </body>
</html>

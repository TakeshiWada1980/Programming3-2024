<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=yes"
    />
    <meta name="robots" content="noindex,nofollow,noarchive" />
    <meta name="referrer" content="no-referrer" />

    <script>
      MathJax = {
        chtml: {
          displayAlign: "left",
          displayIndent: "1em",
        },
      };
    </script>

    

    <link rel="icon" href="favicon.ico" sizes="any" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css"
      integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZjVsC0lE40xsADsfeQoEypE+enwcOiGjk/bSuGGKHEyjSoQ1zVisanQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=M+PLUS+Rounded+1c"
    />
    <link rel="stylesheet" href="style.css" />

    <title>第08回 3I-プログラミング3</title>
  </head>

  <body>
    <div class="openbtn"><span></span><span></span><span></span></div>
    <nav id="g-nav">
      <div id="g-nav-list">
        <!-- ---------------------------------------- -->
         <ul>
<li><a href="#連絡概要" id="toc-連絡概要"><span class="toc-section-number">1</span> 連絡・概要</a>
<ul>
<li><a href="#連絡" id="toc-連絡"><span class="toc-section-number">1.1</span> 連絡</a></li>
<li><a href="#今後の授業の流れ" id="toc-今後の授業の流れ"><span
class="toc-section-number">1.2</span> 今後の授業の流れ</a></li>
</ul></li>
<li><a href="#データの永続化" id="toc-データの永続化"><span class="toc-section-number">2</span>
データの永続化</a></li>
<li><a href="#データベースについて" id="toc-データベースについて"><span
class="toc-section-number">3</span> データベースについて</a>
<ul>
<li><a href="#nosql" id="toc-nosql"><span class="toc-section-number">3.1</span> NoSQL</a></li>
<li><a href="#rdb" id="toc-rdb"><span class="toc-section-number">3.2</span> RDB</a></li>
<li><a href="#orm" id="toc-orm"><span class="toc-section-number">3.3</span> ORM</a></li>
<li><a href="#prisma-のインストール" id="toc-prisma-のインストール"><span
class="toc-section-number">3.4</span> Prisma のインストール</a></li>
<li><a href="#prisma-の初期化処理-セットアップ処理"
id="toc-prisma-の初期化処理-セットアップ処理"><span class="toc-section-number">3.5</span> Prisma
の初期化処理 (セットアップ処理)</a></li>
<li><a href="#env-の内容確認" id="toc-env-の内容確認"><span class="toc-section-number">3.6</span>
.env の内容確認</a></li>
<li><a href="#schema.prisma-の内容確認" id="toc-schema.prisma-の内容確認"><span
class="toc-section-number">3.7</span> schema.prisma の内容確認</a></li>
<li><a href="#schema.prisma-の編集" id="toc-schema.prisma-の編集"><span
class="toc-section-number">3.8</span> schema.prisma の編集</a></li>
<li><a href="#データベースの作成と確認" id="toc-データベースの作成と確認"><span
class="toc-section-number">3.9</span> データベースの作成と確認</a></li>
<li><a href="#dbの初期データの作成" id="toc-dbの初期データの作成"><span
class="toc-section-number">3.10</span> DBの初期データの作成</a></li>
<li><a href="#スキーマに変更を加えたときは" id="toc-スキーマに変更を加えたときは"><span
class="toc-section-number">3.11</span> スキーマに変更を加えたときは…</a></li>
</ul></li>
<li><a href="#バックエンド-ウェブapi-の実装" id="toc-バックエンド-ウェブapi-の実装"><span
class="toc-section-number">4</span> バックエンド (ウェブAPI) の実装</a>
<ul>
<li><a href="#準備" id="toc-準備"><span class="toc-section-number">4.1</span> 準備</a></li>
<li><a href="#apiの設計" id="toc-apiの設計"><span class="toc-section-number">4.2</span>
APIの設計</a></li>
<li><a href="#カテゴリの一覧を取得するウェブapiの実装"
id="toc-カテゴリの一覧を取得するウェブapiの実装"><span class="toc-section-number">4.3</span>
カテゴリの一覧を取得するウェブAPIの実装</a></li>
<li><a href="#thunder-client-を使ったapiのテスト" id="toc-thunder-client-を使ったapiのテスト"><span
class="toc-section-number">4.4</span> Thunder Client を使ったAPIのテスト</a></li>
<li><a href="#カテゴリを追加するウェブapiの実装" id="toc-カテゴリを追加するウェブapiの実装"><span
class="toc-section-number">4.5</span> カテゴリを追加するウェブAPIの実装</a></li>
<li><a href="#カテゴリを追加するウェブapiの実装-コードの解説"
id="toc-カテゴリを追加するウェブapiの実装-コードの解説"><span class="toc-section-number">4.6</span>
カテゴリを追加するウェブAPIの実装 (コードの解説)</a></li>
<li><a href="#カテゴリを削除するウェブapiの実装" id="toc-カテゴリを削除するウェブapiの実装"><span
class="toc-section-number">4.7</span> カテゴリを削除するウェブAPIの実装</a></li>
<li><a href="#カテゴリを編集するウェブapiの実装" id="toc-カテゴリを編集するウェブapiの実装"><span
class="toc-section-number">4.8</span> カテゴリを編集するウェブAPIの実装</a></li>
</ul></li>
</ul> 
        <!-- ---------------------------------------- -->
      </div>
    </nav>

    <header class="markdown-body">
      <p>2024-3I プログラミング3 第08回 講義資料</p>
      <p>2024年12月12日（木）1・2時限</p>
    </header>

    <main class="markdown-body">
      <!-- ---------------------------------------- -->
      <h1 data-number="1" id="連絡概要"><span class="header-section-number">1</span> 連絡・概要</h1>
      <h2 data-number="1.1" id="連絡"><span class="header-section-number">1.1</span> 連絡</h2>
      <p>後期中間試験、お疲れ様でした。後期中間成績は <strong><em>小テスト➊～➌</em></strong>
      を<strong>20%</strong>、<a href="lecture05.html#課題1">課題1</a>(Todoアプリ)を
      <strong>80%</strong> の割合で総合して評価します。課題1は、README.md
      を<strong>3点</strong>、アプリ本体を<strong>7点</strong>の合計「10点満点」で評価しています
      (7.5点が標準評価になります)。</p>
      <ul>
      <li>皆さんの制作物 (課題1) の一覧は<a
      href="https://classroom.google.com/c/NzA2ODk3OTU3MzYy/m/NzM1OTkzNTg4NzE5/details">こちら</a>です
      (学内ONLY)</li>
      </ul>
      <h2 data-number="1.2" id="今後の授業の流れ"><span class="header-section-number">1.2</span>
      今後の授業の流れ</h2>
      <p>前回講義では<a
      href="https://microcms.io/">microCMS</a>を使ってブログアプリの「<strong>バックエンド</strong>」を構築・構成しました。ここからの授業では、<strong><em>Next.js</em></strong>
      を使って<strong>自前でバックエンドを実装</strong>していきます。</p>
      <p>具体的には、<strong>データ永続化</strong>、ウェブAPI、ユーザ認証
      (外部サービス利用)、投稿記事やカテゴリの<strong>CRUD操作機能
      (フロントエンドによるフォームの実装も含む)</strong> などの実装を進めていきます。まずは、<span
      class="masked">リレーショナルデータベース (RDB)</span>
      を使ったバックエンドサイドの「<strong>データの永続化</strong>」からはじめていきます。</p>
      <p>ここから、また一段と難易度が高くなりますが、頑張っていきましょう🔥なお、繰り返しになりますが、本科目は学修単位科目であり、<strong>1回の授業あたり「4時間相当の授業時間外学習」をすることを前提</strong>
      としたボリュームと展開速度となっています。1週間の間隔をあけての90分の取り組みでは理解・習得できるものではないので、適宜、復習に努めてください。</p>
      <p>「バックエンド」や「データの永続化」という概念は既に解説済みですが、もし、理解に自信がない場合は生成AIを使って再確認しておいてください。</p>
      <p><strong>(プロンプト例)</strong></p>
      <blockquote>
      <p>ウェブアプリ開発の文脈における「バックエンド」とは何ですか。</p>
      </blockquote>
      <p><strong>(プロンプト例)</strong></p>
      <blockquote>
      <p>ウェブアプリ開発の文脈における「データの永続化」とは何ですか。</p>
      </blockquote>
      <div class="note type-tips">
      <p><strong>リレーショナルデータベース (RDB)</strong>
      については、2年次の「情報2」の第13回と第14回でも取り上げています。講義資料と教科書
      (キタミ式ITパスポート) の p.160 ～ p.191
      もあわせて復習しておくことをお勧めします。理論を含めた専門的な内容については、4年生の後期開講の
      <strong>データベース工学</strong> (学修単位・2単位) で学びます。</p>
      </div>
      <h1 data-number="2" id="データの永続化"><span class="header-section-number">2</span>
      データの永続化</h1>
      <p><a href="lecture04.html">第04回講義</a>と<a
      href="lecture05.html">第05回講義</a>のなかで取り組んだ「Todoアプリの開発」では、ウェブブラウザの機能である<a
      href="lecture05.html#localstorageを利用したデータの永続化">ローカルストレージ</a>(Window.localStorage
      API)
      を使用して「データの永続化」を実装しました。つまり、フロントエンドでデータの永続化を行なっていました。</p>
      <p>しかし、ローカルストレージは <span
      class="masked">ブラウザが管理する領域にデータを保存する方式</span>
      であるため、それを利用したTodoアプリでは「<strong>PCから登録したタスクを、スマートフォンから確認する</strong>」といった使い方はできませんでした😭</p>
      <p>また、同じ PC
      からアクセスしても「Chromeを使ったとき」と「Edgeを使ったとき」でデータを共有することができませんでした。本来「<strong>インターネットに接続可能な環境であればデバイスや場所を選ばずに利用できる</strong>」というのがウェブアプリのメリットなのですが、ローカルストレージを使ったデータの永続化では、残念ながらこのメリットを活かすことはできませんでした。</p>
      <p>このようなことから、一般的なウェブアプリでは <span
      class="masked">バックエンドに配置したデータベースなど使ってデータの永続化</span>
      が行なわれます。この方式であれば、先の問題の解決に加えて、次のようなメリットが得られます。</p>
      <p>第一に、<strong>複数のユーザでデータを共有できるようになります</strong>。例えば、チームでタスク
      (Todo)
      を管理する場合、メンバー全員が同じタスクリストを参照し、更新内容をリアルタイムで共有することができます。</p>
      <p>第二に、<strong>大量のデータを安全に保管できるようになります</strong>。ローカルストレージでは、その仕様上、<strong>保存容量に制限</strong>
      (=<span class="masked">文字列形式で約5MB</span>)
      がありましたが、データベースを使えばテラバイト単位のデータも扱うことができ、なおかつ
      <strong>バックアップ</strong>
      などの堅牢な仕組みによってデータの消失を防ぐことも可能になります。</p>
      <p>また、(リレーショナルデータベースとは別の仕組みになりますが)
      <strong>オブジェクトストレージ関連のウェブサービス</strong> (<a
      href="https://www.google.com/search?q=Amazon+S3とは">Amazon S3</a>や Azure Blob Storage、GCP
      Cloud Storage)
      を利用すれば画像、音声、動画など任意のバイナリデータを扱うことも可能になります。</p>
      <p>ここからの「ブログアプリ開発」では、以上のメリットを活かすために、バックエンドで<strong>リレーショナルデータベース
      (RDB) をデータを永続化する機能</strong>を実装していきます。</p>
      <h3 data-number="2.0.1" id="定着確認"><span class="header-section-number">2.0.1</span>
      定着確認</h3>
      <ul>
      <li>Window.localStorage API
      は「ウェブサーバ」と「ウェブブラウザ」のどちらで提供される機能か答えよ。
      <ul>
      <li><strong>答え</strong>: <span class="masked">ウェブブラウザ</span></li>
      </ul></li>
      <li>Window.localStorage API は HTTP/HTTPS 経由で利用する API
      である。この説明は「適切」か「不適切」か答えよ。
      <ul>
      <li><strong>答え</strong>: <span class="masked">不適切</span></li>
      </ul></li>
      </ul>
      <h1 data-number="3" id="データベースについて"><span class="header-section-number">3</span>
      データベースについて</h1>
      <p>データベースの<strong>アーキテクチャ</strong> (内部の仕組み/データの整理方法)
      は、大きく分けると「<strong>RDB
      (リレーショナルデータベース)</strong>」と「<strong>NoSQL</strong>」の2つに分類されます。</p>
      <p>ここで取り組む「ブログアプリの開発」には、<strong>リレーショナルデータベース</strong>
      を利用していきます。</p>
      <h2 data-number="3.1" id="nosql"><span class="header-section-number">3.1</span> NoSQL</h2>
      <p><strong>NoSQL</strong> (ノーエスキューエル)
      の代表的なものとして「<strong>ドキュメント指向DB</strong>
      (ドキュメント型DB)」があります。<strong>ドキュメント指向DB</strong>
      は、ウェブブラウザのローカルストレージと同じように
      <strong>固定的なスキーマを必要とせず</strong> <span
      class="masked">「JSON形式」や「XML形式」</span>
      でデータを自由に格納できるという特徴を持っています。</p>
      <p>ここで「<strong>固定的なスキーマを必要としない</strong>」とは <span
      class="masked">データのスキーマ (構造・型) が統一されていなくても良い</span>
      ということを意味します。例えば、ドキュメント指向DBには、以下のように
      <strong>異なるスキーマを持った レコード (データ) を「同じ保存領域」に格納すること</strong>
      ができます。</p>
      <div class="sourceCode" id="cb1" data-caption="1件目のレコード"><pre
      class="sourceCode numberSource json numberLines"><code class="sourceCode json"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">{</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>  <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;user1&quot;</span><span class="fu">,</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>  <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;寝屋川タヌキ&quot;</span><span class="fu">,</span></span>
<span id="cb1-4"><a href="#cb1-4"></a>  <span class="dt">&quot;age&quot;</span><span class="fu">:</span> <span class="dv">5</span><span class="fu">,</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>  <span class="dt">&quot;hobbies&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;どんぐり収集&quot;</span><span class="ot">,</span> <span class="st">&quot;毛づくろい&quot;</span><span class="ot">]</span></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="fu">}</span></span></code></pre></div>
      <div class="sourceCode" id="cb2" data-caption="2件目のレコード"><pre
      class="sourceCode numberSource json numberLines"><code class="sourceCode json"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">{</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>  <span class="dt">&quot;id&quot;</span><span class="fu">:</span> <span class="st">&quot;user2&quot;</span><span class="fu">,</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>  <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;萱島ウサギ&quot;</span><span class="fu">,</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>  <span class="dt">&quot;email&quot;</span><span class="fu">:</span> <span class="st">&quot;abbit@example.com&quot;</span><span class="fu">,</span></span>
<span id="cb2-5"><a href="#cb2-5"></a>  <span class="dt">&quot;skills&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb2-6"><a href="#cb2-6"></a>    <span class="dt">&quot;jump&quot;</span><span class="fu">:</span> <span class="dv">3</span><span class="fu">,</span></span>
<span id="cb2-7"><a href="#cb2-7"></a>    <span class="dt">&quot;speed&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span></span>
<span id="cb2-8"><a href="#cb2-8"></a>    <span class="dt">&quot;stealth&quot;</span><span class="fu">:</span> <span class="dv">4</span> </span>
<span id="cb2-9"><a href="#cb2-9"></a>  <span class="fu">}</span></span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="fu">}</span></span></code></pre></div>
      <p>1件目のレコードは <code>age</code> と <code>hobbies</code>
      という属性を持ち、2件目のレコードは、それとは異なる <code>email</code> と <code>skills</code>
      という属性を持っています。このようにドキュメント指向DBでは <strong>レコード (データ)
      ごとに異なる項目や構造を持たせること</strong> が可能となっています。また <span
      class="masked">配列や階層構造 (ネスト構造) のデータ</span>
      が柔軟に格納できることも大きな特徴となっています。</p>
      <p>さらに、ほとんどのドキュメント指向DBが <strong>JSON形式 (JavaScript Object Notation
      形式)</strong> / BSON に対応しており、JavaScript / TypeScript
      との親和性が高く、ウェブアプリ開発で採用されることが増えています。その場合、<strong>フロントエンドからバックエンドまで一貫してJSON形式でデータをやり取りできる</strong>ため、<span
      class="masked">データの変換作業が最小限で済む</span> というメリットがあります。</p>
      <p><strong>(プロンプト例)</strong></p>
      <blockquote>
      <p>ドキュメント指向データベースの文脈において「BSON」について解説してください。</p>
      </blockquote>
      <p>一方で、後述の RDB では、<strong>同じテーブル (表) に格納する全てのレコードは「共通のカラム
      (列)」</strong> を持つことが要求されます。さらに、そのテーブルのスキーマ
      (カラムの名前、データ型、値の制約など) は <span
      class="masked">レコードを登録する前に設計しておく必要がある</span> という原則があります。</p>
      <p>ドキュメント指向DBの代表的なプロダクトとしては<a
      href="https://www.google.com/search?q=MongoDBとは">MongoDB</a>(モンゴディービー) や<a
      href="https://www.google.com/search?q=CouchDBとは">CouchDB</a>(カウチディービー)
      があります。また、ドキュメント指向DBの特性を活かした BaaS (= <span class="masked">Backend as a
      Service</span>) として<a href="https://www.google.com/search?q=Firebaseとは">GCP
      Firebase</a>や<a href="https://www.google.com/search?q=Amazon%20DynamoDBとは">Amazon
      DynamoDB</a>、<a href="https://www.google.com/search?q=MongoDB%20Atlas">MongoDB
      Atlas</a>などのクラウドサービスがあり、様々なモバイルアプリやウェブサービスにおいて利用されています。</p>
      <p>この他、NoSQLとしては「<strong>キーバリューストア型DB</strong>」や「<strong>グラフ型DB
      (ネットワーク型DB)</strong>」などのデータベースも存在します。興味がある学生は、生成AIやウェブ検索を利用して概要を把握しておいてください。</p>
      <p><strong>(プロンプト例)</strong></p>
      <blockquote>
      <p>ドキュメント指向DB、キーバリューストア型DB、グラフ型DBの概要を説明してください。</p>
      </blockquote>
      <p><strong>(プロンプト例)</strong></p>
      <blockquote>
      <p>ウェブアプリ開発の文脈で「BaaS」とは何ですか。専門用語でできるだけ避けて、初心者向けに機能や採用のメリットなどを解説してください。</p>
      </blockquote>
      <h3 data-number="3.1.1" id="定着確認-1"><span class="header-section-number">3.1.1</span>
      定着確認</h3>
      <ul>
      <li>原則としてスキーマの事前定義が要求されるのは「RDB」と「ドキュメント指向DB」のどちらか答えよ。
      <ul>
      <li>答え: <span class="masked">RDB</span></li>
      </ul></li>
      <li>RDBにおけるテーブルの「スキーマ」とは、どのようなものを指すか答えよ。
      <ul>
      <li>答え: <span class="masked">カラム (列) の名前、データ型、制約など</span></li>
      </ul></li>
      <li>オブジェクト指向プログラミングにおける「オブジェクト」は、その属性 (プロパティ)
      として「配列」や「階層構造」を持つことがある。これらのオブジェクトをより直接的に扱えるのは「ドキュメント指向DB」と「RDB」のどちらか。
      <ul>
      <li>答え: <span class="masked">ドキュメント指向DB</span></li>
      </ul></li>
      <li>ドキュメント指向DBの代表的なプロダクト (≠クラウドサービス) を答えよ。
      <ul>
      <li>答え: <span class="masked">MongoDB、CouchDB</span></li>
      </ul></li>
      <li>一般的なドキュメント指向DBがサポートしている主要なドキュメント形式を2つ答えよ。
      <ul>
      <li>答え: <span class="masked">JSON、XML、YAML</span></li>
      </ul></li>
      <li>NoSQLデータベースにはいくつかの種類が存在する。そのなかでも代表的な3つの型を答えよ。
      <ul>
      <li>答え: <span class="masked">ドキュメント指向DB、キーバリュー型DB、グラフ型DB</span></li>
      </ul></li>
      <li>ウェブアプリ開発の文脈で「BaaS」とは何の略語か答えよ。
      <ul>
      <li>答え: <span class="masked">Backend as a Service</span></li>
      </ul></li>
      </ul>
      <h2 data-number="3.2" id="rdb"><span class="header-section-number">3.2</span> RDB</h2>
      <p>RDB (Relational Database) は
      <strong>シンプルな「2次元の表形式」でデータを保持することが特徴</strong> のDBです。近年では
      NoSQL の普及も進んでいますが、単に「DB」と言えば RDB
      を指すほど一般的であり、特に「銀行システム」や「ECサイト」などで広く採用されています。表形式によるデータ管理には多くのメリットがあるものの、<strong>可変長配列</strong>
      や <strong>階層構造のデータ</strong> を <strong>直接的に扱えない</strong>
      という欠点があります。</p>
      <p><strong>(プロンプト例)</strong></p>
      <blockquote>
      <p>プログラム開発者の観点では、オブジェクトデータの永続化が直接的に可能なドキュメント指向DBのほうが、RDBと比較してストレージとしてのメリットが大きいように考えます。しかし、実際にはRDBが採用されることが多いのは、どのような理由か解説してください。</p>
      </blockquote>
      <p>例えば、JavaScript/TypeScriptで、次のようなオブジェクトデータを扱っているとします。このデータでは、<strong>第7行目</strong>～<strong>第11行目</strong>のように「カテゴリ」に関する情報が
      <strong>階層的な構造を持ち、その要素数が可変</strong> (＝<span
      class="masked">例えば、2個のカテゴリをもつ場合もあれば、3個のカテゴリを持つ場合もある構造</span>)
      となっています。</p>
      <div class="sourceCode" id="cb3"
      data-caption="階層構造および可変長配列を持つオブジェクトデータの例"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb3-1"><a href="#cb3-1"></a>[</span>
<span id="cb3-2"><a href="#cb3-2"></a>  {</span>
<span id="cb3-3"><a href="#cb3-3"></a>    id<span class="op">:</span> <span class="st">&quot;p-001&quot;</span><span class="op">,</span></span>
<span id="cb3-4"><a href="#cb3-4"></a>    title<span class="op">:</span> <span class="st">&quot;JavaScriptだと動いたのに…な毎日&quot;</span><span class="op">,</span></span>
<span id="cb3-5"><a href="#cb3-5"></a>    content<span class="op">:</span> <span class="st">&quot;TypeScriptに移行してから…&quot;</span><span class="op">,</span></span>
<span id="cb3-6"><a href="#cb3-6"></a>    createdAt<span class="op">:</span> <span class="st">&quot;2024-03-19&quot;</span><span class="op">,</span></span>
<span id="cb3-7"><a href="#cb3-7"></a>    categories<span class="op">:</span> [</span>
<span id="cb3-8"><a href="#cb3-8"></a>      { id<span class="op">:</span> <span class="st">&quot;c-001&quot;</span><span class="op">,</span> name<span class="op">:</span> <span class="st">&quot;プログラミング&quot;</span> }<span class="op">,</span></span>
<span id="cb3-9"><a href="#cb3-9"></a>      { id<span class="op">:</span> <span class="st">&quot;c-002&quot;</span><span class="op">,</span> name<span class="op">:</span> <span class="st">&quot;TypeScript&quot;</span> }<span class="op">,</span></span>
<span id="cb3-10"><a href="#cb3-10"></a>      { id<span class="op">:</span> <span class="st">&quot;c-003&quot;</span><span class="op">,</span> name<span class="op">:</span> <span class="st">&quot;JavaScript&quot;</span> }<span class="op">,</span></span>
<span id="cb3-11"><a href="#cb3-11"></a>    ]<span class="op">,</span></span>
<span id="cb3-12"><a href="#cb3-12"></a>  }<span class="op">,</span></span>
<span id="cb3-13"><a href="#cb3-13"></a>  {</span>
<span id="cb3-14"><a href="#cb3-14"></a>    id<span class="op">:</span> <span class="st">&quot;p-002&quot;</span><span class="op">,</span></span>
<span id="cb3-15"><a href="#cb3-15"></a>    title<span class="op">:</span> <span class="st">&quot;リストの[-1]ってマイナスなのになんで動くの?&quot;</span><span class="op">,</span></span>
<span id="cb3-16"><a href="#cb3-16"></a>    content<span class="op">:</span> <span class="st">&quot;Pythonのリストで…&quot;</span><span class="op">,</span></span>
<span id="cb3-17"><a href="#cb3-17"></a>    createdAt<span class="op">:</span> <span class="st">&quot;2024-03-24&quot;</span><span class="op">,</span></span>
<span id="cb3-18"><a href="#cb3-18"></a>    categories<span class="op">:</span> [</span>
<span id="cb3-19"><a href="#cb3-19"></a>      { id<span class="op">:</span> <span class="st">&quot;c-001&quot;</span><span class="op">,</span> name<span class="op">:</span> <span class="st">&quot;プログラミング&quot;</span> }<span class="op">,</span></span>
<span id="cb3-20"><a href="#cb3-20"></a>      { id<span class="op">:</span> <span class="st">&quot;c-004&quot;</span><span class="op">,</span> name<span class="op">:</span> <span class="st">&quot;Python&quot;</span> }<span class="op">,</span></span>
<span id="cb3-21"><a href="#cb3-21"></a>    ]<span class="op">,</span></span>
<span id="cb3-22"><a href="#cb3-22"></a>  }<span class="op">,</span></span>
<span id="cb3-23"><a href="#cb3-23"></a>]<span class="op">;</span></span></code></pre></div>
      <p>このようなオブジェクトデータを <strong>RDBを用いて永続化するためには</strong> <span
      class="masked">正規化</span> という処理を施して、次のように <strong>複数のテーブル (表)
      に分解して扱う必要</strong> があります。</p>
      <p><strong>■ posts テーブル</strong></p>
      <table>
      <thead>
      <tr class="header">
      <th>id</th>
      <th>title</th>
      <th>content</th>
      <th>created_at</th>
      </tr>
      </thead>
      <tbody>
      <tr class="odd">
      <td>p-001</td>
      <td>JavaScriptだと…</td>
      <td>TypeScriptに移行…</td>
      <td>2024-03-19</td>
      </tr>
      <tr class="even">
      <td>p-002</td>
      <td>リストの[-1]って…</td>
      <td>Pythonのリストで…</td>
      <td>2024-03-24</td>
      </tr>
      </tbody>
      </table>
      <p><strong>■ categories テーブル</strong></p>
      <table>
      <thead>
      <tr class="header">
      <th>id</th>
      <th>name</th>
      </tr>
      </thead>
      <tbody>
      <tr class="odd">
      <td>c-001</td>
      <td>プログラミング</td>
      </tr>
      <tr class="even">
      <td>c-002</td>
      <td>TypeScript</td>
      </tr>
      <tr class="odd">
      <td>c-003</td>
      <td>JavaScript</td>
      </tr>
      <tr class="even">
      <td>c-004</td>
      <td>Python</td>
      </tr>
      </tbody>
      </table>
      <p><strong>■ posts_categories テーブル</strong></p>
      <table>
      <thead>
      <tr class="header">
      <th>post_id</th>
      <th>category_id</th>
      </tr>
      </thead>
      <tbody>
      <tr class="odd">
      <td>p-001</td>
      <td>c-001</td>
      </tr>
      <tr class="even">
      <td>p-001</td>
      <td>c-002</td>
      </tr>
      <tr class="odd">
      <td>p-001</td>
      <td>c-003</td>
      </tr>
      <tr class="even">
      <td>p-002</td>
      <td>c-001</td>
      </tr>
      <tr class="odd">
      <td>p-002</td>
      <td>c-004</td>
      </tr>
      </tbody>
      </table>
      <p>このテーブル設計において「<strong>posts_categoriesテーブル</strong>」は橋渡し的な役割を果たしています。このような<strong>複数のテーブルの「紐付け」を行なうテーブル</strong>を「中間テーブル」「Join
      Table」「Junction
      Table」と言います。<strong>1つの投稿記事が複数のカテゴリを持ち</strong>、なおかつ、<strong>1つのカテゴリが複数の投稿記事に属する</strong>
      という <span class="masked">多対多 (N:N)</span>
      の関係性をRDBの形式で実現しています。このような変換をRDBでは <strong>データの正規化
      (Normalization)</strong> と呼びます。正規化によって <span class="masked">データの重複</span>
      を排除し、<strong>一貫性を保ちながら効率的なデータ管理</strong> が可能になります。</p>
      <div class="note type-senior">
      <p>RDBにおける「中間テーブル」や「多対多 (N:N)」の概念については「<a
      href="https://qiita.com/ramuneru/items/db43589551dd0c00fef9">やさしい図解で学ぶ 中間テーブル
      多対多
      概念編</a>」などを参照してください。詳しくは、4年生後期開講の「<strong>データベース工学</strong>」で学びます。</p>
      </div>
      <p>このように適切に正規化されたRDBでは、例えば、カテゴリ <code>c-001</code>
      の「<strong>プログラミング</strong>」という名前を「<strong>コーディング</strong>」に変更したいとき、<span
      class="masked">categoriesテーブルのなかの1件のレコードを更新するだけ</span>
      で完了するという大きなメリットがあります。</p>
      <p>一方で、RDBを使用すると「プログラムからRDBにデータを保存するとき」と「RDBからプログラムにデータを読み込むとき」に<strong>煩雑な変換処理</strong>が必要となります。具体的には、データを保存するときには
      <span class="masked">オブジェクトの内容を、各テーブルに記録するようなクエリ (SQL文)
      を作成して、それをRDBに発行する必要</span>
      があります。逆に、読み込む際には、<strong>各テーブルから必要なデータを抽出するためのクエリ
      (SQL文) を作成してRDBに発行し、その実行結果 (平坦化されたレコードの配列)
      を元の階層構造を持つオブジェクト形式に再構築</strong>する必要があります。</p>
      <div class="note type-tips">
      <p>SQL (エス・キュー・エル: Structured Query Language) は、RDB に対する
      <strong>クエリ</strong> (検索、取得、挿入、更新、削除などの一操作指示)
      を記述するための言語です。</p>
      </div>
      <p>このような「オブジェクトデータ」と「リレーショナルデータ」を接続する際の困難さを <span
      class="masked">O/Rインピーダンス・ミスマッチ</span> と呼びます。</p>
      <p><strong>(プロンプト例)</strong></p>
      <blockquote>
      <p>O/Rインピーダンスミスマッチに関する質問です。現在、TypeScriptを使ってブログアプリ（ブログ記事とカテゴリがN:Nの関係）を開発しています。先生から、RDBから取得したデータは「平坦化されたレコードの配列」であるため、それを元の「階層構造を持つオブジェクト形式」に再構築する必要がある、と言われました。このことについて具体的なイメージがつかめないので解説してください。変換のプログラムを知りたいのではなく、それぞれのデータ構造と変換のイメージを把握したいです。</p>
      </blockquote>
      <h2 data-number="3.3" id="orm"><span class="header-section-number">3.3</span> ORM</h2>
      <p>O/Rインピーダンス・ミスマッチを解決するための概念・技術として <strong>Object-Relational
      Mapping (ORM)</strong>
      というものがあります。これは、オブジェクト指向プログラミングにおける「オブジェクトモデル」と、RDBにおける「リレーショナルモデル」の間の<strong>「溝」を埋めるための</strong>
      (<strong>違いを吸収するための</strong>) 設計パターンとなります。</p>
      <p>この <strong>Object-Relational Mapping</strong> を実装したツール/ライブラリは
      <strong>Object-Relational Mapper（ORM）</strong>
      と呼ばれ、開発者がRDBを直接意識することなく（つまり、<strong>SQL文でクエリを記述することなく</strong>）、プログラミング言語の
      <span class="masked">ネイティブなオブジェクトとしてデータを扱うことを可能</span>
      にします。</p>
      <p>TypeScript/JavaScript には <strong>Prisma (プリズマ)</strong> という ORM
      があり、広く使われています。このブログアプリ開発でも、Prisma を最大限に利用して RDB
      とのデータのやりとりを行ないます。</p>
      <h2 data-number="3.4" id="prisma-のインストール"><span
      class="header-section-number">3.4</span> Prisma のインストール</h2>
      <p>プロジェクトに <a href="https://www.npmjs.com/package/prisma">Prisma</a>(O/R Mapper)
      をインストールしていきます。VSCode でプロジェクト (<code>next-blog-app</code>)
      をオープンして、<code>Ctrl+J</code> でターミナルを開き、以下のコマンドを実行してください。</p>
      <pre><code>npm i -D prisma</code></pre>
      <p>また、データベースの「<strong>初期データ</strong> (Seed)」を作成する際に<a
      href="https://www.google.com/search?q=ts-nodeとは">ts-node</a>を使用するので、こちらもプロジェクトのローカルにインストールしてください。</p>
      <pre><code>npm i -D ts-node</code></pre>
      <p><strong>ts-node</strong> は<a
      href="lecture01.html#開発を効率的に行なうためのパッケージの追加">第01回講義</a>でも解説したように
      <span class="masked">TypeScriptを (JavaScriptに変換せずに) Node.js 上で 直接実行
      するためのランタイム</span> になります。</p>
      <div class="note type-tips">
      <p><strong>npmのアップデート</strong></p>
      <p>npmコマンドを実行した際に、次のように <strong>npm のアップデートを促すメッセージ</strong>
      が表示されたときは、適宜、指示に従ってアップデートしてください。</p>
      <pre><code>npm notice New minor version of npm available! 10.8.3 -&gt; 10.9.1
npm notice Changelog: https://github.com/npm/cli/releases/tag/v10.9.1
npm notice To update run: npm install -g npm@10.9.1</code></pre>
      <p>具体的には、ターミナルから次のようなコマンドを実行してください。<code>@</code>
      以降のバージョン番号は、適宜、読み替えてください。</p>
      <pre><code>npm install -g npm@10.9.1</code></pre>
      <p>なお、<code>-g</code> は、グローバル環境を対象にインストール (アップデート)
      することを指示するオプションになります。<a
      href="lecture01.html#npm-関連の初期設定">第01回講義</a>でも触れたように、npm
      は、通常、プロジェクトのローカル環境ではなく、グローバル環境にインストールします。</p>
      </div>
      <div class="note type-caution">
      <p><strong>セキュリティ脆弱性に対する緊急対応</strong></p>
      <p>npmコマンドを実行した際に「<strong>XX high severity
      vulnerability</strong>」のように表示されたときは <span
      class="masked">XX件の深刻なセキュリティ脆弱性</span>
      が検出されたことを意味します。インストール済みのパッケージのなかに緊急対応を要する脆弱性を持つものが存在し、それに対して対応を促すメッセージとなっています。</p>
      <p>「<strong>XX high severity
      vulnerability</strong>」というメッセージが表示されたときは、まずは以下のコマンドで詳細を確認してください。</p>
      <pre><code>npm audit</code></pre>
      <p>つづいて、次のコマンドで、当該パッケージをセキュティ対応したバージョンにアップデートします。成功すると「<strong>found
      0 vulnerabilities</strong>」というメッセージが出力されます。</p>
      <pre><code>npm audit fix</code></pre>
      <p>なお、依存関係の問題などで <code>npm audit fix</code> では対応できない (解決できない)
      こともあります。その場合は、個別に情報収集して対応したり、生成AIを使って解決してください。</p>
      </div>
      <h2 data-number="3.5" id="prisma-の初期化処理-セットアップ処理"><span
      class="header-section-number">3.5</span> Prisma の初期化処理 (セットアップ処理)</h2>
      <p>次に Prisma を <strong>使用するための準備</strong> を行なっていきます。
      この初期化処理は、プロジェクトのローカル環境に Prisma をインストール後、基本的に <span
      class="masked">初回のみに実行すればよい</span> ものとなります。</p>
      <p>VSCodeのターミナルから次のコマンドを実行してください。<code>npm</code> ではなく
      <code>npx</code> であることに注意してください。<code>--datasource-provider sqlite</code>
      のオプションにより、DB として <strong>SQLite</strong> (エスキューライト、スクライト)
      を使用する設定にするように指示しています。</p>
      <p>なお、Prisma は「SQLite」の他に MySQL、PostgreSQL など様々な DB に対応しています。</p>
      <pre><code>npx prisma init --datasource-provider sqlite</code></pre>
      <p>このコマンドを実行すると、プロジェクトフォルダの直下に <code>prisma</code>
      というフォルダが作成され、さらに、そのなかに <code>schema.prisma</code> という
      <strong>設定ファイル</strong> が作成されます。また、プロジェクトフォルダの直下の
      <code>.env</code> (<a href="lecture07.html#準備-環境変数の設定">前回講義</a>で <span
      class="masked">環境変数の設定</span> を記述したファイル) に情報が追記がされます。</p>
      <figure>
      <img src="figs/08/vscode_01.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <h2 data-number="3.6" id="env-の内容確認"><span class="header-section-number">3.6</span> .env
      の内容確認</h2>
      <p><code>.env</code>
      を開いて、Prismaの初期化処理によって追記された内容を確認してください。<code>#</code>
      から開始する行は <strong>コメント</strong> なので編集・削除しても問題ありません。</p>
      <p>ファイルの最後のほうに <code>DATABASE_URL</code> という環境変数設定が追加され、そこに
      <code>"file:./dev.db"</code> がセット (代入) されていることが確認できると思います。</p>
      <div class="sourceCode" id="cb11" data-caption=".env"><pre
      class="sourceCode numberSource sh numberLines"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1"></a><span class="co"># microCMS</span></span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="va">NEXT_PUBLIC_MICROCMS_BASE_EP</span><span class="op">=</span>https://XXXXX.microcms.io/api/v1</span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="va">NEXT_PUBLIC_MICROCMS_API_KEY</span><span class="op">=</span>YYYYY</span>
<span id="cb11-4"><a href="#cb11-4"></a></span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="co"># prisma ▼▼ 追加されていることを確認 ▼▼</span></span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="va">DATABASE_URL</span><span class="op">=</span><span class="st">&quot;file:./dev.db&quot;</span></span></code></pre></div>
      <p>これは <span class="masked">Prisma がデータベース接続に際して参照する環境変数</span>
      で、この値によって、Prisma は <code>dev.db</code>
      という「<strong>SQLiteのデータベースファイル</strong>
      (現時点ではまだ作成されていません)」に接続するようになります。</p>
      <h2 data-number="3.7" id="schema.prisma-の内容確認"><span
      class="header-section-number">3.7</span> schema.prisma の内容確認</h2>
      <p><code>prisma</code> フォルダのなかの <code>schema.prisma</code>
      を開いて内容を確認してください。<code>//</code> から開始する行は <strong>コメント</strong>
      なので編集・削除して問題ありません。</p>
      <div class="sourceCode" id="cb12" data-caption="prisma/schema.prisma"><pre
      class="sourceCode numberSource text numberLines"><code class="sourceCode"><span id="cb12-1"><a href="#cb12-1"></a>generator client {</span>
<span id="cb12-2"><a href="#cb12-2"></a>  provider = &quot;prisma-client-js&quot;</span>
<span id="cb12-3"><a href="#cb12-3"></a>}</span>
<span id="cb12-4"><a href="#cb12-4"></a></span>
<span id="cb12-5"><a href="#cb12-5"></a>datasource db {</span>
<span id="cb12-6"><a href="#cb12-6"></a>  provider = &quot;sqlite&quot;</span>
<span id="cb12-7"><a href="#cb12-7"></a>  url      = env(&quot;DATABASE_URL&quot;)</span>
<span id="cb12-8"><a href="#cb12-8"></a>}</span></code></pre></div>
      <p><strong>第02行目</strong> では、JavaScript (TypeScript) に対応した「Prisma
      Client」を生成することを指定しています。Prisma Client クラスから生成されるインスタンスを通して
      <span class="masked">(SQLを記述することなく) TypeScript プログラムから DB のCURD操作</span>
      ができるようになります。</p>
      <p><strong>第06行目</strong> では、使用するDB (Prismaが接続するDB)
      が「<strong>SQLite</strong>」であることを指定しています。</p>
      <p><strong>第07行目</strong> では <code>.env</code> ファイルの <code>DATABASE_URL</code> から
      <strong>DB接続情報</strong>
      を読み取るように指示しています。現状では、<code>DATABASE_URL</code> に
      <code>file:./dev.db</code> が設定されています。</p>
      <p>また、<code>schema.prisma</code> は、<span class="masked">データベースのスキーマ定義
      (＝テーブルやフィールドの構造定義)</span>
      を記述するファイルとしての役割も持ちます。次のセクションでは
      <strong>ブログアプリに必要となる各テーブルのスキーマを定義</strong>していきます。</p>
      <h2 data-number="3.8" id="schema.prisma-の編集"><span class="header-section-number">3.8</span>
      schema.prisma の編集</h2>
      <p>ブログアプリに必要な各種データ (投稿記事、カテゴリ) を保存するためのスキーマを
      <code>schema.prisma</code> に記述していきます。まず、<code>schema.prisma</code>
      を次のように書き換えて、保存してください。</p>
      <div class="sourceCode" id="cb13" data-caption="prisma/schema.prisma"><pre
      class="sourceCode numberSource text numberLines"><code class="sourceCode"><span id="cb13-1"><a href="#cb13-1"></a>// このファイルを更新したら...</span>
<span id="cb13-2"><a href="#cb13-2"></a>// 0. `npm run dev` や `npx prisma studio` を停止</span>
<span id="cb13-3"><a href="#cb13-3"></a>// 1. dev.db を削除</span>
<span id="cb13-4"><a href="#cb13-4"></a>// 2. npx prisma db push</span>
<span id="cb13-5"><a href="#cb13-5"></a>// 3. npx prisma generate</span>
<span id="cb13-6"><a href="#cb13-6"></a>// 4. npx prisma db seed</span>
<span id="cb13-7"><a href="#cb13-7"></a></span>
<span id="cb13-8"><a href="#cb13-8"></a>generator client {</span>
<span id="cb13-9"><a href="#cb13-9"></a>  provider = &quot;prisma-client-js&quot;</span>
<span id="cb13-10"><a href="#cb13-10"></a>}</span>
<span id="cb13-11"><a href="#cb13-11"></a></span>
<span id="cb13-12"><a href="#cb13-12"></a>datasource db {</span>
<span id="cb13-13"><a href="#cb13-13"></a>  provider = &quot;sqlite&quot;</span>
<span id="cb13-14"><a href="#cb13-14"></a>  url      = env(&quot;DATABASE_URL&quot;)</span>
<span id="cb13-15"><a href="#cb13-15"></a>}</span>
<span id="cb13-16"><a href="#cb13-16"></a></span>
<span id="cb13-17"><a href="#cb13-17"></a>// 投稿記事テーブル</span>
<span id="cb13-18"><a href="#cb13-18"></a>model Post {</span>
<span id="cb13-19"><a href="#cb13-19"></a>  id             String @id @default(uuid())</span>
<span id="cb13-20"><a href="#cb13-20"></a>  title          String</span>
<span id="cb13-21"><a href="#cb13-21"></a>  content        String</span>
<span id="cb13-22"><a href="#cb13-22"></a>  coverImageURL  String</span>
<span id="cb13-23"><a href="#cb13-23"></a>  createdAt      DateTime @default(now())</span>
<span id="cb13-24"><a href="#cb13-24"></a>  updatedAt      DateTime @updatedAt</span>
<span id="cb13-25"><a href="#cb13-25"></a>  categories     PostCategory[]</span>
<span id="cb13-26"><a href="#cb13-26"></a>}</span>
<span id="cb13-27"><a href="#cb13-27"></a></span>
<span id="cb13-28"><a href="#cb13-28"></a>// カテゴリテーブル</span>
<span id="cb13-29"><a href="#cb13-29"></a>model Category {</span>
<span id="cb13-30"><a href="#cb13-30"></a>  id         String @id @default(uuid())</span>
<span id="cb13-31"><a href="#cb13-31"></a>  name       String @unique</span>
<span id="cb13-32"><a href="#cb13-32"></a>  createdAt  DateTime @default(now())</span>
<span id="cb13-33"><a href="#cb13-33"></a>  updatedAt  DateTime @updatedAt</span>
<span id="cb13-34"><a href="#cb13-34"></a>  posts      PostCategory[]</span>
<span id="cb13-35"><a href="#cb13-35"></a>}</span>
<span id="cb13-36"><a href="#cb13-36"></a></span>
<span id="cb13-37"><a href="#cb13-37"></a>// 投稿記事とカテゴリを紐づける中間テーブル</span>
<span id="cb13-38"><a href="#cb13-38"></a>model PostCategory {</span>
<span id="cb13-39"><a href="#cb13-39"></a>  id          String @id @default(uuid())</span>
<span id="cb13-40"><a href="#cb13-40"></a>  postId      String</span>
<span id="cb13-41"><a href="#cb13-41"></a>  categoryId  String</span>
<span id="cb13-42"><a href="#cb13-42"></a>  createdAt   DateTime @default(now())</span>
<span id="cb13-43"><a href="#cb13-43"></a>  updatedAt   DateTime @updatedAt</span>
<span id="cb13-44"><a href="#cb13-44"></a>  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)</span>
<span id="cb13-45"><a href="#cb13-45"></a>  post        Post     @relation(fields: [postId], references: [id], onDelete: Cascade)</span>
<span id="cb13-46"><a href="#cb13-46"></a>}</span></code></pre></div>
      <p><strong>第17行目</strong> 以降で「投稿記事テーブル <code>Post</code>」「カテゴリテーブル
      <code>Category</code>」「投稿記事とカテゴリを紐づける中間テーブル
      <code>PostCategory</code>」の3つのテーブルのスキーマ (モデル)
      を定義しています。この定義に基づき、Prisma によって DB にテーブルが作成され、また、<span
      class="masked">それらのテーブルを操作するための「メソッド」</span> や
      <strong>テーブルから取得される「データ型」</strong> が TypeScript
      で利用できるようになります。</p>
      <p><strong>投稿記事テーブル</strong> (<code>Post</code>) の定義の <strong>第22行目</strong>
      では、今後の展開の都合で「<code>src/app/_types/CoverImage.ts</code> で定義したような
      <code>url</code>、<code>height</code>、<code>width</code> という属性を持った
      <code>coverImage</code>」ではなく、<code>coverImageURL</code>
      に変更している点に注意してください。</p>
      <p><code>schema.prisma</code> の詳細 (記述方法)
      については、ウェブ記事や生成AIを利用して概要だけ把握しておいてください。特に
      <strong>第44行目</strong> と <strong>第45行目</strong>
      では特徴的な設定がされているので注意してください。</p>
      <p><strong>(プロンプト例)</strong></p>
      <blockquote>
      <p>TypeScript で Prisma を使用するにあたって、次のような <code>schema.prisma</code>
      を受け取りました。「投稿記事テーブル」のスキーマ定義について、丁寧に解説してください。特にカラムの「型」や「制約」について説明してください。</p>
      <p>～ schema.prisma の内容を貼付け ～</p>
      </blockquote>
      <blockquote>
      <p>つづいて「カテゴリテーブル」について同様に解説してください。</p>
      </blockquote>
      <blockquote>
      <p>つづいて「中間テーブル」について同様に解説してください。</p>
      </blockquote>
      <h2 data-number="3.9" id="データベースの作成と確認"><span
      class="header-section-number">3.9</span> データベースの作成と確認</h2>
      <p><code>schema.prisma</code> を編集・保存したら、次のコマンドを実行してください。</p>
      <pre><code>npx prisma db push</code></pre>
      <p>このコマンドにより、<code>schema.prisma</code> に基づいて
      <strong>実際にデータベースが新規作成され</strong> (現在の設定の場合は <code>dev.db</code>
      というファイルが新規作成され)、その DB のなかに <strong>「3つのテーブル」が作成</strong>
      されます。既にデータベースが存在する場合は
      <code>The database is already in sync with the Prisma schema.</code> となります。</p>
      <p>さらに、次のコマンドを実行してください。この操作により <code>schema.prisma</code>
      に基づき、<strong>プロジェクトのなかで参照可能なメソッドや型情報</strong>などが生成されます。</p>
      <pre><code>npx prisma generate</code></pre>
      <div class="note type-tips">
      <p><strong>補足: 自動生成される「型」の参照</strong></p>
      <p><code>npx prisma generate</code> を実行すると、プロジェクトのなかで
      <code>schema.prisma</code> に記述したスキーマ (モデル)
      に基づいて自動的に「型」が定義され、それを参照することができます。</p>
      <p>例えば <code>import { Category } from "@prisma/client";</code>
      とすれば、以下のようにカテゴリの型を参照できるようになります。</p>
      <figure>
      <img src="figs/08/vscode_04.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      </div>
      <p>つづいて、VSCode から、次のように <code>dev.db</code>
      が作成されていることを確認してください。</p>
      <figure>
      <img src="figs/08/vscode_02.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>Prismaによって作成されたDBの内容は「<strong>Prisma
      Studio</strong>」というツールを使って、ウェブブラウザから確認することができます。Prisma Studio
      は、VSCodeのターミナルから、以下のコマンドで起動することができます
      (デフォルトでは5555番ポートで起動します)。</p>
      <pre><code>npx prisma studio</code></pre>
      <p>Prisma Studio のトップ画面では、<strong>テーブル一覧</strong> (<strong>モデル一覧</strong>)
      が表示されます。いまは「投稿記事のテーブル」を確認したいので「<strong>Post</strong>」をクリックしてください。</p>
      <figure>
      <img src="figs/08/prisma_01.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>画面が切り替わり、下図のように「投稿記事テーブル (<code>Post</code>)」の「<strong>カラム
      (列)
      の構成</strong>」を確認することができます。現時点では、まだ投稿記事のレコードが1件も存在しませんが、レコード追加後は、その内容について確認・編集することもできます。</p>
      <figure>
      <img src="figs/08/prisma_02.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <ul>
      <li>「<strong>Add
      record</strong>」のボタンを押下すると、この画面からレコードを追加することもできます
      (いまは追加しないでください)。</li>
      <li>「<strong>＋</strong>」のボタンを押下すると他のテーブルについて内容を確認することができます。</li>
      <li>レコードが存在するときは、その内容を編集することもできます。
      <ul>
      <li>Prisma Studio では <strong>スキーマの変更 (カラムの追加や削除、名前変更など)</strong>
      はできません。スキーマを変更するためには <code>schema.prisma</code>
      の編集が必要になります。</li>
      </ul></li>
      </ul>
      <p>ターミナルで <code>Ctrl+C</code> を入力すると Prisma Studio
      を終了することができます。一旦、Prisma Studio を終了しておいてください。</p>
      <h2 data-number="3.10" id="dbの初期データの作成"><span
      class="header-section-number">3.10</span> DBの初期データの作成</h2>
      <p>Prisma Studio
      の画面から1件ずつ手作業でレコードを追加することも可能ですが、ここでは<strong>プログラムを使って初期データを生成して、それを
      DB
      に挿入していきます</strong>。なお、データベースの初期データを作成して投入する作業を「<strong>シーディング
      (seeding)</strong>」といい、その際に使用する初期データを「<strong>シードデータ (Seed
      Data)</strong>」と呼びます。</p>
      <p><code>prisma</code> フォルダのなかに <code>seed.ts</code>
      というファイルを新規作成して・・・</p>
      <figure>
      <img src="figs/08/vscode_03.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>以下のコード (シーディングのためのTypeScriptプログラム) を貼付け、保存してください。</p>
      <div class="sourceCode" id="cb17" data-caption="prisma/seed.ts"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb17-1"><a href="#cb17-1"></a><span class="im">import</span> { PrismaClient } <span class="im">from</span> <span class="st">&quot;@prisma/client&quot;</span><span class="op">;</span></span>
<span id="cb17-2"><a href="#cb17-2"></a></span>
<span id="cb17-3"><a href="#cb17-3"></a><span class="kw">const</span> prisma <span class="op">=</span> <span class="kw">new</span> <span class="fu">PrismaClient</span>()<span class="op">;</span> <span class="co">// PrismaClientのインスタンス生成</span></span>
<span id="cb17-4"><a href="#cb17-4"></a></span>
<span id="cb17-5"><a href="#cb17-5"></a><span class="kw">const</span> main <span class="op">=</span> <span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb17-6"><a href="#cb17-6"></a>  <span class="co">// 各テーブルから既存の全レコードを削除</span></span>
<span id="cb17-7"><a href="#cb17-7"></a>  <span class="cf">await</span> prisma<span class="op">.</span><span class="at">postCategory</span><span class="op">?.</span><span class="fu">deleteMany</span>()<span class="op">;</span></span>
<span id="cb17-8"><a href="#cb17-8"></a>  <span class="cf">await</span> prisma<span class="op">.</span><span class="at">post</span><span class="op">?.</span><span class="fu">deleteMany</span>()<span class="op">;</span></span>
<span id="cb17-9"><a href="#cb17-9"></a>  <span class="cf">await</span> prisma<span class="op">.</span><span class="at">category</span><span class="op">?.</span><span class="fu">deleteMany</span>()<span class="op">;</span></span>
<span id="cb17-10"><a href="#cb17-10"></a></span>
<span id="cb17-11"><a href="#cb17-11"></a>  <span class="co">// カテゴリデータの作成 (テーブルに対するレコードの挿入)</span></span>
<span id="cb17-12"><a href="#cb17-12"></a>  <span class="kw">const</span> c1 <span class="op">=</span> <span class="cf">await</span> prisma<span class="op">.</span><span class="at">category</span><span class="op">.</span><span class="fu">create</span>({ data<span class="op">:</span> { name<span class="op">:</span> <span class="st">&quot;カテゴリ1&quot;</span> } })<span class="op">;</span></span>
<span id="cb17-13"><a href="#cb17-13"></a>  <span class="kw">const</span> c2 <span class="op">=</span> <span class="cf">await</span> prisma<span class="op">.</span><span class="at">category</span><span class="op">.</span><span class="fu">create</span>({ data<span class="op">:</span> { name<span class="op">:</span> <span class="st">&quot;カテゴリ2&quot;</span> } })<span class="op">;</span></span>
<span id="cb17-14"><a href="#cb17-14"></a>  <span class="kw">const</span> c3 <span class="op">=</span> <span class="cf">await</span> prisma<span class="op">.</span><span class="at">category</span><span class="op">.</span><span class="fu">create</span>({ data<span class="op">:</span> { name<span class="op">:</span> <span class="st">&quot;カテゴリ3&quot;</span> } })<span class="op">;</span></span>
<span id="cb17-15"><a href="#cb17-15"></a></span>
<span id="cb17-16"><a href="#cb17-16"></a>  <span class="co">// 投稿記事データの作成  (テーブルに対するレコードの挿入)</span></span>
<span id="cb17-17"><a href="#cb17-17"></a>  <span class="kw">const</span> p1 <span class="op">=</span> <span class="cf">await</span> prisma<span class="op">.</span><span class="at">post</span><span class="op">.</span><span class="fu">create</span>({</span>
<span id="cb17-18"><a href="#cb17-18"></a>    data<span class="op">:</span> {</span>
<span id="cb17-19"><a href="#cb17-19"></a>      title<span class="op">:</span> <span class="st">&quot;投稿1&quot;</span><span class="op">,</span></span>
<span id="cb17-20"><a href="#cb17-20"></a>      content<span class="op">:</span> <span class="st">&quot;投稿1の本文。&lt;br/&gt;投稿1の本文。投稿1の本文。&quot;</span><span class="op">,</span></span>
<span id="cb17-21"><a href="#cb17-21"></a>      coverImageURL<span class="op">:</span></span>
<span id="cb17-22"><a href="#cb17-22"></a>        <span class="st">&quot;https://w1980.blob.core.windows.net/pg3/cover-img-red.jpg&quot;</span><span class="op">,</span></span>
<span id="cb17-23"><a href="#cb17-23"></a>      categories<span class="op">:</span> {</span>
<span id="cb17-24"><a href="#cb17-24"></a>        create<span class="op">:</span> [{ categoryId<span class="op">:</span> c1<span class="op">.</span><span class="at">id</span> }<span class="op">,</span> { categoryId<span class="op">:</span> c2<span class="op">.</span><span class="at">id</span> }]<span class="op">,</span> <span class="co">// ◀◀ 注目</span></span>
<span id="cb17-25"><a href="#cb17-25"></a>      }<span class="op">,</span></span>
<span id="cb17-26"><a href="#cb17-26"></a>    }<span class="op">,</span></span>
<span id="cb17-27"><a href="#cb17-27"></a>  })<span class="op">;</span></span>
<span id="cb17-28"><a href="#cb17-28"></a></span>
<span id="cb17-29"><a href="#cb17-29"></a>  <span class="kw">const</span> p2 <span class="op">=</span> <span class="cf">await</span> prisma<span class="op">.</span><span class="at">post</span><span class="op">.</span><span class="fu">create</span>({</span>
<span id="cb17-30"><a href="#cb17-30"></a>    data<span class="op">:</span> {</span>
<span id="cb17-31"><a href="#cb17-31"></a>      title<span class="op">:</span> <span class="st">&quot;投稿2&quot;</span><span class="op">,</span></span>
<span id="cb17-32"><a href="#cb17-32"></a>      content<span class="op">:</span> <span class="st">&quot;投稿2の本文。&lt;br/&gt;投稿2の本文。投稿2の本文。&quot;</span><span class="op">,</span></span>
<span id="cb17-33"><a href="#cb17-33"></a>      coverImageURL<span class="op">:</span></span>
<span id="cb17-34"><a href="#cb17-34"></a>        <span class="st">&quot;https://w1980.blob.core.windows.net/pg3/cover-img-green.jpg&quot;</span><span class="op">,</span></span>
<span id="cb17-35"><a href="#cb17-35"></a>      categories<span class="op">:</span> {</span>
<span id="cb17-36"><a href="#cb17-36"></a>        create<span class="op">:</span> [{ categoryId<span class="op">:</span> c2<span class="op">.</span><span class="at">id</span> }<span class="op">,</span> { categoryId<span class="op">:</span> c3<span class="op">.</span><span class="at">id</span> }]<span class="op">,</span> <span class="co">// ◀◀ 注目</span></span>
<span id="cb17-37"><a href="#cb17-37"></a>      }<span class="op">,</span></span>
<span id="cb17-38"><a href="#cb17-38"></a>    }<span class="op">,</span></span>
<span id="cb17-39"><a href="#cb17-39"></a>  })<span class="op">;</span></span>
<span id="cb17-40"><a href="#cb17-40"></a></span>
<span id="cb17-41"><a href="#cb17-41"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(p1<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></span>
<span id="cb17-42"><a href="#cb17-42"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(p2<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></span>
<span id="cb17-43"><a href="#cb17-43"></a>}<span class="op">;</span></span>
<span id="cb17-44"><a href="#cb17-44"></a></span>
<span id="cb17-45"><a href="#cb17-45"></a><span class="fu">main</span>()</span>
<span id="cb17-46"><a href="#cb17-46"></a>  <span class="op">.</span><span class="fu">catch</span>((e) <span class="kw">=&gt;</span> {</span>
<span id="cb17-47"><a href="#cb17-47"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(e)<span class="op">;</span></span>
<span id="cb17-48"><a href="#cb17-48"></a>    <span class="bu">process</span><span class="op">.</span><span class="fu">exit</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb17-49"><a href="#cb17-49"></a>  })</span>
<span id="cb17-50"><a href="#cb17-50"></a>  <span class="op">.</span><span class="fu">finally</span>(<span class="kw">async</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb17-51"><a href="#cb17-51"></a>    <span class="cf">await</span> prisma<span class="op">.</span><span class="fu">$disconnect</span>()<span class="op">;</span></span>
<span id="cb17-52"><a href="#cb17-52"></a>  })<span class="op">;</span></span></code></pre></div>
      <p>上記のプログラム (<code>prisma/seed.ts</code>) は、Next.js
      からは切り離された<strong>独立したプログラム</strong>になります。</p>
      <ul>
      <li><strong>第12行目</strong> ～ <strong>第14行目</strong> : 「カテゴリテーブル」に <span
      class="masked">3件分</span> のレコードを追加しています。
      <ul>
      <li><a href="lecture08.html#schema.prisma-の編集">先ほど編集</a>した
      <code>schema.prisma</code> の <strong>第30行目</strong>～<strong>第34行目</strong>
      で定義している <code>id</code> や
      <code>createdAt</code>、<code>updatedAt</code>、<code>posts</code> については
      <strong>明示的に値を与えていないこと</strong> に注意してください。</li>
      <li>詳しいことは省略しますが、<code>id</code> には <code>@default(uuid())</code> 設定により
      UUIDv4 が自動代入され、<code>createdAt</code> には <code>@default(now())</code>
      設定により現在時刻が自動代入されます。</li>
      </ul></li>
      <li><strong>第17行目</strong> ～ <strong>第39行目</strong> : 「投稿記事テーブル」に <span
      class="masked">2件分</span> のレコードを追加しています。
      <ul>
      <li>投稿記事のカテゴリの設定 (<strong>第24行目</strong>と<strong>第36行目</strong>)
      では、<code>c1.id</code> や <code>c2.id</code>
      のように、<strong>カテゴリテーブルにレコードを追加したときの戻り値</strong>
      (<code>c1</code>、<code>c2</code>、<code>c3</code>)
      からIDを参照して行なっている点に注意してください。</li>
      </ul></li>
      <li>中間テーブルに対しては <span class="masked">明示的にレコードを追加していないこと</span>
      を確認してください。</li>
      <li>DBに対する操作 (<code>deleteMany</code> や <code>create</code>) は、すべて PrismaClient
      (＝<strong>第03行目</strong> で PrismaClientクラス から生成したインスタンス)
      を通じて行なっていることを確認してください。
      <ul>
      <li>「クラス」や「インスタンス」については、昨年度の<a
      href="https://takeshiwada1980.github.io/Programming1-2023/lecture23.html#オブジェクト指向プログラミング-超々入門">プログラミング1の講義資料</a>を参照してください。</li>
      </ul></li>
      </ul>
      <h3 data-number="3.10.1" id="シーディングコマンドの設定"><span
      class="header-section-number">3.10.1</span> シーディングコマンドの設定</h3>
      <p>つづいて <code>package.json</code> を次のように編集してください
      (<strong>第11行目</strong>から<strong>第13行目</strong>の設定を追加してください)。編集する際は、<strong>第10行目</strong>と<strong>第13行目</strong>の末尾のカンマを忘れないようにしてください。</p>
      <div class="sourceCode" id="cb18" data-caption="package.json"><pre
      class="sourceCode numberSource json numberLines"><code class="sourceCode json"><span id="cb18-1"><a href="#cb18-1"></a><span class="fu">{</span></span>
<span id="cb18-2"><a href="#cb18-2"></a>  <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;next-blog-app&quot;</span><span class="fu">,</span></span>
<span id="cb18-3"><a href="#cb18-3"></a>  <span class="dt">&quot;version&quot;</span><span class="fu">:</span> <span class="st">&quot;0.1.0&quot;</span><span class="fu">,</span></span>
<span id="cb18-4"><a href="#cb18-4"></a>  <span class="dt">&quot;private&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb18-5"><a href="#cb18-5"></a>  <span class="dt">&quot;scripts&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb18-6"><a href="#cb18-6"></a>    <span class="dt">&quot;dev&quot;</span><span class="fu">:</span> <span class="st">&quot;next dev&quot;</span><span class="fu">,</span></span>
<span id="cb18-7"><a href="#cb18-7"></a>    <span class="dt">&quot;build&quot;</span><span class="fu">:</span> <span class="st">&quot;next build&quot;</span><span class="fu">,</span></span>
<span id="cb18-8"><a href="#cb18-8"></a>    <span class="dt">&quot;start&quot;</span><span class="fu">:</span> <span class="st">&quot;next start&quot;</span><span class="fu">,</span></span>
<span id="cb18-9"><a href="#cb18-9"></a>    <span class="dt">&quot;lint&quot;</span><span class="fu">:</span> <span class="st">&quot;next lint&quot;</span></span>
<span id="cb18-10"><a href="#cb18-10"></a>  <span class="fu">},</span></span>
<span id="cb18-11"><a href="#cb18-11"></a>  <span class="dt">&quot;prisma&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb18-12"><a href="#cb18-12"></a>    <span class="dt">&quot;seed&quot;</span><span class="fu">:</span> <span class="st">&quot;ts-node --compiler-options {</span><span class="ch">\&quot;</span><span class="st">module</span><span class="ch">\&quot;</span><span class="st">:</span><span class="ch">\&quot;</span><span class="st">CommonJS</span><span class="ch">\&quot;</span><span class="st">} prisma/seed.ts&quot;</span></span>
<span id="cb18-13"><a href="#cb18-13"></a>  <span class="fu">},</span></span>
<span id="cb18-14"><a href="#cb18-14"></a>  <span class="dt">&quot;dependencies&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb18-15"><a href="#cb18-15"></a>    <span class="dt">&quot;@fortawesome/fontawesome-svg-core&quot;</span><span class="fu">:</span> <span class="st">&quot;^6.6.0&quot;</span><span class="fu">,</span></span>
<span id="cb18-16"><a href="#cb18-16"></a></span>
<span id="cb18-17"><a href="#cb18-17"></a>  <span class="er">～</span> <span class="er">以下、省略</span> <span class="er">～</span></span></code></pre></div>
      <p>以上の設定により、<code>ts-node --compiler-options {"module":"CommonJS"} prisma/seed.ts</code>
      というシーディングのための長いコマンドが、<code>npx prisma db seed</code>
      というショートカットで実行できるようになります。</p>
      <h3 data-number="3.10.2" id="シーディングの実行と結果の確認"><span
      class="header-section-number">3.10.2</span> シーディングの実行と結果の確認</h3>
      <p>VSCodeのターミナルから次のコマンドを打ち込んで、<strong>シーディング</strong>
      (<strong>DBの初期データの生成</strong>) を実行してください。</p>
      <pre><code>npx prisma db seed</code></pre>
      <p>なお、<code>seed.ts</code> の <strong>第41行目</strong> と <strong>第42行目</strong>
      では、生成した投稿記事の内容を <code>console.log()</code>
      でログ出力していますが、このログは以下のように (ウェブブラウザの開発者ツールではなく)
      <strong>VSCode のターミナルに出力</strong>されることに注意してください。</p>
      <figure>
      <img src="figs/08/vscode_06.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>次に、Prisma Studio を起動 (<code>npx prisma studio</code> コマンドを実行) して、DB
      の各テーブルにレコードが追加されていることを確認してください。</p>
      <figure>
      <img src="figs/08/prisma_03.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>Prisma Studio では、日時が <span class="masked">ISO8601形式</span>
      で表示されることを確認してください。また、<a
      href="lecture06.html#実装の方針">第06回講義</a>で解説したように、末尾の <code>Z</code> は
      <strong>UTC（協定世界時）</strong> を表すことに注意してください。</p>
      <figure>
      <img src="figs/08/prisma_04.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>各テーブルのレコードは <code>id</code> カラムの値 (ランダムに設定されたUUIDv4の値)
      で自動的にソートされることを確認してください。</p>
      <figure>
      <img src="figs/08/prisma_05.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p><code>prisma/seed.ts</code> では、中間テーブル (<code>PostCategory</code>)
      にレコードを追加する文を記述していませんが、実際には当該にテーブルに適切なレコードが追加されていることに注意してください。このような中間テーブルに対するレコードの挿入なども
      Prisma が提供する ORM としての機能となります。</p>
      <p>以上のように、Prisma Client を利用することで、<strong>SQL文を記述せずに、TypeScript
      プログラムから DB に対しての CURD操作</strong> (Create、Update、Read、Delete)
      が可能になります。</p>
      <h3 data-number="3.10.3" id="演習-15分"><span class="header-section-number">3.10.3</span> 演習
      (<i class="fa-solid fa-stopwatch"></i>15分)</h3>
      <ul>
      <li><p>初期データとして「<strong>カテゴリ4</strong>」を追加するように <code>seed.ts</code>
      を編集し、その後、<code>npx prisma db seed</code> を実行してください。そして、Prisma Client
      から「<strong>カテゴリ4</strong>」が追加されていることを確認してください。</p></li>
      <li><p>初期データとして「<strong>投稿3</strong>」を追加するように <code>seed.ts</code>
      を編集し、実行結果を確認してください。「<strong>投稿3</strong>」には「<strong>カテゴリ1</strong>」「<strong>カテゴリ3</strong>」「<strong>カテゴリ4</strong>」を設定してください。</p></li>
      <li><p>初期データとして「<strong>投稿4</strong>」を追加するように <code>seed.ts</code>
      を編集し、実行結果を確認してください。「<strong>投稿4</strong>」には、<strong>いずれのカテゴリも設定しない</strong>ようにしてください。</p></li>
      </ul>
      <p>どうしても実装できないときは<a
      href="https://github.com/TakeshiWada1980/Programming3-2024/blob/main/docs/codes/08/code01.tsx">こちら<i class="fa-solid fa-person-chalkboard"></i></a>を参照してください。</p>
      <h2 data-number="3.11" id="スキーマに変更を加えたときは"><span
      class="header-section-number">3.11</span> スキーマに変更を加えたときは…</h2>
      <p>テーブルに新しくカラムを追加したり、カラムの名前を変更するなどの
      <strong>スキーマの定義に関わる変更</strong> を <code>schema.prisma</code>
      に行ったときは、以下の手続きが必要になります。これらを実行すると、<strong>DBのすべてのレコードとテーブルと消える</strong>
      ので注意してください。</p>
      <ol type="1">
      <li>ターミナルで <code>npm run dev</code> や
      <code>npx prisma studio</code>を実行中しているときは停止する。</li>
      <li><code>prisma</code> フォルダのなかの <code>dev.db</code> を削除する。</li>
      <li>ターミナルから <code>npx prisma db push</code> を実行する。</li>
      <li>ターミナルから <code>npx prisma generate</code> を実行する。
      <ul>
      <li>この処理によって「型」の情報が更新されるので、それが確実に反映されるように<a
      href="lecture03.html#vscodeの再読み込み">VSCodeの再読み込み</a>を (念のために) 実行する。</li>
      </ul></li>
      <li>ターミナルから <code>npx prisma db seed</code> を実行する。</li>
      </ol>
      <p>なお、<code>prisma migrate</code> というコマンドを使用すれば <span
      class="masked">既存のデータを保持したままスキーマの変更を適用することも可能</span>
      ですが、開発の初期段階 (消えて困るようなデータが DB に格納されていない状態)
      では上記の手続きの方が確実です。</p>
      <p><code>prisma migrate</code> の使い方については<a
      href="https://www.prisma.io/docs/orm/prisma-migrate/getting-started">公式リファレンス</a>や生成AIなどで調べてください。</p>
      <p>以上で、バックエンドで DB
      を機能させるための準備が完了しました。なお、ここでは、一時的に「SQLite」を使用しますが、最終的には
      <a href="https://supabase.com/">Supabase</a>
      というクラウドサービスの「<strong>PostgreSQL</strong>」に切り替えていきます。</p>
      <h1 data-number="4" id="バックエンド-ウェブapi-の実装"><span
      class="header-section-number">4</span> バックエンド (ウェブAPI) の実装</h1>
      <p>ここからは、Next.js
      を使って、ブログアプリ関連の「<strong>ウェブAPI</strong>」の機能を実装していきます。つまり、前回講義で取り上げた「<a
      href="lecture07.html#郵便番号検索apiの組込み">郵便番号検索API</a>」や「<a
      href="lecture07.html#apiの利用テスト">microCMS</a>」のように、特定のエンドポイント (URL)
      にHTTPリクエストを送ると、<span class="masked">JSONフォーマットでデータが取得できる</span>
      ような機能を Next.js の枠組みで実装していきます。</p>
      <p>例えば <code>http://localhost:3000/api/categories</code> というエンドポイントに
      <strong>HTTPリクエスト (GET)</strong> を送ると、以下のような <strong>HTTP レスポンス</strong>
      (主にJSONデータ) が取得できるような機能を Next.js で実装していきます。</p>
      <figure>
      <img src="figs/08/app_01.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <h2 data-number="4.1" id="準備"><span class="header-section-number">4.1</span> 準備</h2>
      <p>Prisma を利用して RDB とデータをやりとりするためには <code>seed.ts</code> の
      <strong>第03行目</strong>
      のように、PrismaClientクラスのインスタンスを作成する必要があります。そのため、ウェブAPIを実装するプログラムのなかでも
      <code>const prisma = new PrismaClient();</code> のような処理が必要となります。</p>
      <p><strong>しかし</strong>、Next.js を <strong>開発モード</strong> (<code>npm run dev</code>)
      で動かすと、その <strong>ホットリロード機能</strong> (＝<span
      class="masked">ファイルの変更を検知して自動的にアプリケーションを再起動する機能</span>)
      との兼ね合いで、<strong>Prisma Client
      インスタンスが重複して生成されるという問題</strong>が生じます。このような形で
      PrismaClientのインスタンス が重複生成されると<a
      href="https://www.google.com/search?q=メモリリーク">メモリリーク</a>や「Too many
      connections」(＝<span
      class="masked">データベース接続数が上限を超えた場合に発生するエラー</span>)
      が生じる可能性があります。ちなみに、開発モード以外では、ホットリロードは使われないのでこの懸念はありません。</p>
      <p>この問題を回避するための対策をしていきます。まず <code>src/app/lib</code> に
      <code>prisma.ts</code> というファイルを新規作成してください
      (<code>lib</code>フォルダも存在しないので新規作成してください)。</p>
      <figure>
      <img src="figs/08/vscode_05.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>作成した <code>prisma.ts</code> に以下のプログラムを貼付けて保存してください。</p>
      <div class="sourceCode" id="cb20" data-caption="src/lib/prisma.ts"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb20-1"><a href="#cb20-1"></a><span class="im">import</span> { PrismaClient } <span class="im">from</span> <span class="st">&quot;@prisma/client&quot;</span><span class="op">;</span></span>
<span id="cb20-2"><a href="#cb20-2"></a></span>
<span id="cb20-3"><a href="#cb20-3"></a><span class="co">// データベース接続用のインスタンスを作成する関数を定義</span></span>
<span id="cb20-4"><a href="#cb20-4"></a><span class="kw">const</span> prismaClientSingleton <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb20-5"><a href="#cb20-5"></a>  <span class="cf">return</span> <span class="kw">new</span> <span class="fu">PrismaClient</span>()<span class="op">;</span></span>
<span id="cb20-6"><a href="#cb20-6"></a>}<span class="op">;</span></span>
<span id="cb20-7"><a href="#cb20-7"></a></span>
<span id="cb20-8"><a href="#cb20-8"></a><span class="co">// グローバルスコープに prismaGlobal という変数が存在することをTypeScriptに伝える型定義</span></span>
<span id="cb20-9"><a href="#cb20-9"></a><span class="kw">declare</span> <span class="kw">const</span> globalThis<span class="op">:</span> {</span>
<span id="cb20-10"><a href="#cb20-10"></a>  prismaGlobal<span class="op">:</span> <span class="bu">ReturnType</span><span class="op">&lt;</span><span class="kw">typeof</span> prismaClientSingleton<span class="op">&gt;;</span></span>
<span id="cb20-11"><a href="#cb20-11"></a>} <span class="op">&amp;</span> <span class="kw">typeof</span> <span class="bu">global</span><span class="op">;</span></span>
<span id="cb20-12"><a href="#cb20-12"></a></span>
<span id="cb20-13"><a href="#cb20-13"></a><span class="co">// 既存の prismaGlobal があればそれを使用し、なければ新しくインスタンスを作成</span></span>
<span id="cb20-14"><a href="#cb20-14"></a><span class="kw">const</span> prisma <span class="op">=</span> globalThis<span class="op">.</span><span class="at">prismaGlobal</span> <span class="op">??</span> <span class="fu">prismaClientSingleton</span>()<span class="op">;</span></span>
<span id="cb20-15"><a href="#cb20-15"></a></span>
<span id="cb20-16"><a href="#cb20-16"></a><span class="co">// 作成した prisma インスタンスを他から利用できるようにエクスポート</span></span>
<span id="cb20-17"><a href="#cb20-17"></a><span class="im">export</span> <span class="im">default</span> prisma<span class="op">;</span></span>
<span id="cb20-18"><a href="#cb20-18"></a></span>
<span id="cb20-19"><a href="#cb20-19"></a><span class="co">// 開発環境の場合のみ、作成したインスタンスをグローバルスコープに保存し、</span></span>
<span id="cb20-20"><a href="#cb20-20"></a><span class="co">// ホットリロード時の再利用を可能にする</span></span>
<span id="cb20-21"><a href="#cb20-21"></a><span class="cf">if</span> (<span class="bu">process</span><span class="op">.</span><span class="at">env</span><span class="op">.</span><span class="at">NODE_ENV</span> <span class="op">!==</span> <span class="st">&quot;production&quot;</span>) globalThis<span class="op">.</span><span class="at">prismaGlobal</span> <span class="op">=</span> prisma<span class="op">;</span></span></code></pre></div>
      <p>このプログラムは、グローバル変数を使って
      PrismaClientインスタンスを保持し、ホットリロードが起きたときも単一のインスタンスを再利用するように機能します
      (やや難しい話になるので、現時点で理解できなくても問題ありません)。</p>
      <p>詳細については、Next.js の公式リファレンスの<a
      href="https://www.prisma.io/docs/orm/more/help-and-troubleshooting/help-articles/nextjs-prisma-client-dev-practices">Best
      practice for instantiating Prisma Client with
      Next.js</a>を参照してください。また、参考図書の「<strong>これからはじめるReact実践入門</strong>」の
      p.592 を参照してください。</p>
      <h2 data-number="4.2" id="apiの設計"><span class="header-section-number">4.2</span>
      APIの設計</h2>
      <p>カテゴリに関して次のようにCRUD操作に対応する4個のウェブAPIを実装していきます。カテゴリの新規作成・変更・削除に関係するAPIについては
      <span class="masked">管理者としてログインしているときだけ利用できる</span>
      ようにしていきます。</p>
      <table>
      <thead>
      <tr class="header">
      <th>エンドポイント</th>
      <th>HTTP<br>Method</th>
      <th>処理</th>
      <th>管理者<br>権限</th>
      <th>リクエスト<br>ボディ</th>
      </tr>
      </thead>
      <tbody>
      <tr class="odd">
      <td>/api/categories</td>
      <td>GET</td>
      <td>カテゴリの一覧を取得する</td>
      <td></td>
      <td></td>
      </tr>
      <tr class="even">
      <td>/api/admin/categories</td>
      <td>POST</td>
      <td>カテゴリを追加する</td>
      <td>必要</td>
      <td>必要</td>
      </tr>
      <tr class="odd">
      <td>/api/admin/categories/[id]</td>
      <td>PUT</td>
      <td>カテゴリの名前を変更する</td>
      <td>必要</td>
      <td>必要</td>
      </tr>
      <tr class="even">
      <td>/api/admin/categories/[id]</td>
      <td>DELETE</td>
      <td>カテゴリを削除する</td>
      <td>必要</td>
      <td></td>
      </tr>
      </tbody>
      </table>
      <p>管理者だけが利用できるように制限する処理は <strong>ログイン機能を実装してから追加</strong>
      します。今回講義のなかでは、誰でも利用可能なAPIとして実装します。</p>
      <p>なお、ここでは「カテゴリ」のCRUD操作について解説しますが、次回以降、(宿題で)
      <strong>投稿記事に関するCRUD操作を各自で実装してもらう予定なので、</strong>しっかりと理解しながら読み進めるようにしてください。</p>
      <h2 data-number="4.3" id="カテゴリの一覧を取得するウェブapiの実装"><span
      class="header-section-number">4.3</span> カテゴリの一覧を取得するウェブAPIの実装</h2>
      <p>Next.js (App Router) では <code>src/app/api</code> の配下に <code>route.ts</code>
      (≠<code>page.tsx</code>)
      という名前のファイルを配置することで、<strong>ウェブAPIのエンドポイントを作成</strong>
      することができます。</p>
      <p>例えば、以下のように <code>src/app/api/categories/route.ts</code>
      というファイルを作成して、そこに <code>GET</code> 関数を定義すると <span
      class="masked">http://localhost:3000/api/categories</span>
      というURLで利用可能なエンドポイントが作成できます（<strong>GET Method</strong> の
      HTTPリクエストを受付けて処理できるようになります）。</p>
      <pre><code>📂 src/
└─ 📂 app/
    └─ 📂 api/
        └─ 📂 categories/
            └─ route.ts</code></pre>
      <p>上記のようにフォルダとファイル (<code>route.ts</code>)
      を作成して、以下の内容を貼付けて保存してください。</p>
      <div class="sourceCode" id="cb22"
      data-caption="src/app/api/categories/route.ts (HTTP GET Request によるカテゴリの一覧取得)"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb22-1"><a href="#cb22-1"></a><span class="im">import</span> prisma <span class="im">from</span> <span class="st">&quot;@/lib/prisma&quot;</span><span class="op">;</span></span>
<span id="cb22-2"><a href="#cb22-2"></a><span class="im">import</span> { NextResponse<span class="op">,</span> NextRequest } <span class="im">from</span> <span class="st">&quot;next/server&quot;</span><span class="op">;</span></span>
<span id="cb22-3"><a href="#cb22-3"></a></span>
<span id="cb22-4"><a href="#cb22-4"></a><span class="co">// [GET] /api/categories カテゴリ一覧の取得</span></span>
<span id="cb22-5"><a href="#cb22-5"></a><span class="im">export</span> <span class="kw">const</span> GET <span class="op">=</span> <span class="kw">async</span> (req<span class="op">:</span> NextRequest) <span class="kw">=&gt;</span> {</span>
<span id="cb22-6"><a href="#cb22-6"></a>  <span class="cf">try</span> {</span>
<span id="cb22-7"><a href="#cb22-7"></a>    <span class="kw">const</span> categories <span class="op">=</span> <span class="cf">await</span> prisma<span class="op">.</span><span class="at">category</span><span class="op">.</span><span class="fu">findMany</span>({</span>
<span id="cb22-8"><a href="#cb22-8"></a>      orderBy<span class="op">:</span> {</span>
<span id="cb22-9"><a href="#cb22-9"></a>        createdAt<span class="op">:</span> <span class="st">&quot;desc&quot;</span><span class="op">,</span> <span class="co">// 降順 (新しい順)</span></span>
<span id="cb22-10"><a href="#cb22-10"></a>      }<span class="op">,</span></span>
<span id="cb22-11"><a href="#cb22-11"></a>    })<span class="op">;</span></span>
<span id="cb22-12"><a href="#cb22-12"></a>    <span class="cf">return</span> NextResponse<span class="op">.</span><span class="fu">json</span>(categories)<span class="op">;</span></span>
<span id="cb22-13"><a href="#cb22-13"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb22-14"><a href="#cb22-14"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(error)<span class="op">;</span></span>
<span id="cb22-15"><a href="#cb22-15"></a>    <span class="cf">return</span> NextResponse<span class="op">.</span><span class="fu">json</span>(</span>
<span id="cb22-16"><a href="#cb22-16"></a>      { error<span class="op">:</span> <span class="st">&quot;カテゴリの取得に失敗しました&quot;</span> }<span class="op">,</span></span>
<span id="cb22-17"><a href="#cb22-17"></a>      { status<span class="op">:</span> <span class="dv">500</span> } <span class="co">// 500: Internal Server Error</span></span>
<span id="cb22-18"><a href="#cb22-18"></a>    )<span class="op">;</span></span>
<span id="cb22-19"><a href="#cb22-19"></a>  }</span>
<span id="cb22-20"><a href="#cb22-20"></a>}<span class="op">;</span></span></code></pre></div>
      <p>まずは、開発モードでアプリを立ち上げて <code>http://localhost:3000/api/categories</code>
      にアクセスして、以下のように <span class="masked">「カテゴリの一覧」が
      JSON形式で得られること</span>
      を確認してください。なお、Chromeでは、画面上部の「<strong>プリティ
      プリント</strong>」にチェックを入れないと下図のように整形表示されないので注意してください。</p>
      <figure>
      <img src="figs/08/app_01.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>以下、<code>route.ts</code> のコードを解説していきます。</p>
      <p>まず、<strong>第01行目</strong>では、前のセクションで作成した
      <code>src/app/lib/prisma.ts</code> のなかで定義した <strong>PrismaClient</strong> (＝O/R
      Mapper) のインスタンスである <code>prisma</code> をインポートしています。基本的は、この
      <code>prisma</code> を通じて DB とデータのやりとりをするので、このファイルのなかで、あらためて
      <code>const prisma = new PrismaClient();</code>
      のような処理は<strong>必要ありません</strong>。</p>
      <p><strong>第07行目</strong> から <strong>第11行目</strong> では、DB のカテゴリテーブルから
      <strong>レコード全件</strong> を取得して、定数 <code>categories</code>
      に格納しています。ここでは、<strong>第01行目</strong> でインポートした <code>prisma</code>
      が持つ <code>findMany</code>
      というメソッドを使っていますが、このメソッドは「<strong>非同期メソッド</strong>」なので、<span
      class="masked"><code>await</code>が必要になること</span>
      に注意してください。ここでは、<code>findMany</code> に対して引数で「<code>createdAt</code>
      属性に基づいて<strong>降順にソート</strong>」するようにも指示しています。戻り値を代入している
      <code>categories</code> ですが、下図のようにエディタ上でマウスカーソルを重ねると
      <strong>オブジェクトの「配列」</strong> になっていることが確認できます。</p>
      <figure>
      <img src="figs/08/vscode_07.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>このように <strong>第07行目</strong> の <code>categories</code> の型は TypeScript
      により「<strong>型推論</strong>」されますが、もし<strong>明示的に「型」を指定したい場合</strong>は、ファイルの冒頭に
      <code>import { Category } from "@prisma/client";</code> を追加したうえで
      <code>const categories: Category[] = ...</code> のようにします (次の図を参照)。</p>
      <figure>
      <img src="figs/08/vscode_08.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p><strong>第05行目</strong>では、アロー関数形式で <code>GET</code>
      という関数を定義して処理を記述していますが、ここでの <strong>名前の設定</strong>
      は非常に重要です。<code>GET</code> という関数名を付けることで「<strong>HTTP GET
      リクエスト</strong>」を受付けるようになります。これを <code>Get</code> や
      <code>get</code>、<code>GetCategories</code>
      などに変更すると<strong>機能しなくなるので注意</strong>してください。</p>
      <p>GET 以外の HTTP Method (POST、PUT、DELETE)
      を受け付けるウェブAPIを実装するときは、そのメソッドにあわせて関数名を設定する必要があります。HTTP
      Method の概要が分からないときは、生成AIを使って概要を把握しておいてください。</p>
      <p><code>route.ts</code> のなかに記述する GET / POST / PUT / DELETE 関数は、基本的に
      <code>NextRequest</code> を引数にして「<strong>HTTP
      Request</strong>」の情報を読み取り、<code>NextResponse</code> で「<strong>HTTP
      NextResponse</strong>」を生成するように構成します。</p>
      <p><strong>(プロンプト例)</strong></p>
      <blockquote>
      <p>Next.js (App Router) でウェブAPIを実装しようとしています。そのための前提知識として HTTP
      Method について解説してください。</p>
      </blockquote>
      <h3 data-number="4.3.1" id="定着確認-2"><span class="header-section-number">4.3.1</span>
      定着確認</h3>
      <ul>
      <li>CRUD操作に対応する4つの HTTP Method を答えよ。
      <ul>
      <li>答え: <span class="masked">POST、GET、PUT、DELETE</span></li>
      </ul></li>
      <li>新しいリソースを作成するために使用される HTTP Method を答えよ。
      <ul>
      <li>答え: <span class="masked">POST</span></li>
      </ul></li>
      <li>既存のリソースを更新するために使用される HTTP Method を答えよ。
      <ul>
      <li>答え: <span class="masked">PUT</span></li>
      </ul></li>
      <li>リソースを取得するため使用される HTTP Method を答えよ。
      <ul>
      <li>答え: <span class="masked">GET</span></li>
      </ul></li>
      <li>リソースを削除するために使用される HTTP Method を答えよ。
      <ul>
      <li>答え: <span class="masked">DELETE</span></li>
      </ul></li>
      </ul>
      <p>HTTPに関する文脈において「<strong>リソース</strong>」とは <span
      class="masked">URLでアクセス可能なデータや情報、ファイル</span> を指します。</p>
      <h2 data-number="4.4" id="thunder-client-を使ったapiのテスト"><span
      class="header-section-number">4.4</span> Thunder Client を使ったAPIのテスト</h2>
      <p><a href="lecture07.html#apiの利用テスト">前回講義</a>のなかで導入した <strong>Thunder
      Client</strong> (VSCodeの拡張機能) を使って、前のセクションで実装した APIのエンドポイント
      <code>/api/categories</code> のテスト (動作検証) を行ないます。予め開発モードでアプリを起動
      (<code>npm run dev</code>) しておいてください。</p>
      <p>VSCodeの左パネルの「⚡」のアイコンをクリックするか、<code>Ctrl+Shift+R</code> を押下すると
      Thunder Client のパネルが表示されるので、「<strong>New
      Request</strong>」のボタンを押下してください。</p>
      <figure>
      <img src="figs/07/vscode_05.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>次に、HTTP Method として「<strong>GET</strong>」を選択 (確認) して、エンドポイントに
      <code>http://localhost:3000/api/categories</code>
      を設定してください。そして、「Send」ボタンを押下してリクエストを送信して、そのレスポンスを確認してください。VSCodeのウィンドウ幅が大きいときは、右側にレスポンスが表示されることがあります。</p>
      <figure>
      <img src="figs/08/vscode_09.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>レスポンスでは、<strong>ステータスコード</strong> (上記の場合は❸の「<strong>200
      OK</strong>」の箇所)
      が重要となります。基本的には200番台が「<strong>成功</strong>」、その他、400番台、500番台が「<strong>失敗</strong>」を表します。知能情報実験実習2の後期のテーマ
      (サーバ構築基礎実習)
      のなかでもステータスコードについて習っていると思います。概要を把握しておいてください。</p>
      <p><strong>(プロンプト例)</strong></p>
      <blockquote>
      <p>HTTPレスポンスのステータスコードについて、主要なものを解説してください。</p>
      </blockquote>
      <h3 data-number="4.4.1" id="定着確認-3"><span class="header-section-number">4.4.1</span>
      定着確認</h3>
      <ul>
      <li>HTTPレスポンスのステータス「OK」を表わす番号を答えよ。
      <ul>
      <li>答え: <span class="masked">200</span></li>
      </ul></li>
      <li>HTTPレスポンスのステータス「Unauthorized」を表わす番号を答えよ。
      <ul>
      <li>答え: <span class="masked">401</span></li>
      </ul></li>
      <li>HTTPレスポンスのステータス「Bad Request」を表わす番号を答えよ。
      <ul>
      <li>答え: <span class="masked">400</span></li>
      </ul></li>
      <li>HTTPレスポンスのステータス「Internal Server Error」を表わす番号を答えよ。
      <ul>
      <li>答え: <span class="masked">500</span></li>
      </ul></li>
      <li>HTTPレスポンスのステータス「Method Not Allowed」を表わす番号を答えよ。
      <ul>
      <li>答え: <span class="masked">405</span></li>
      </ul></li>
      </ul>
      <h3 data-number="4.4.2" id="演習-5分"><span class="header-section-number">4.4.2</span> 演習
      (<i class="fa-solid fa-stopwatch"></i>5分)</h3>
      <p>バックエンドで処理される <code>route.ts</code> のなかに <code>console.log()</code>
      を記述すると、そのログが <strong>VSCodeのターミナル</strong>
      に出力されることを確認してください。</p>
      <div class="note type-tips">
      <p>VSCode の補完機能により、意図せずに <code>import console from "inspector"</code>
      などがファイルに追加されていることがあります。それらがインポートされていると
      <code>console.log()</code> を実行しても
      <strong>VSCodeのターミナルにログが出力されないこと</strong>
      があるので注意してください。console に関して見慣れないインポートがあれば削除してください。</p>
      </div>
      <h3 data-number="4.4.3" id="演習-10分"><span class="header-section-number">4.4.3</span> 演習
      (<i class="fa-solid fa-stopwatch"></i>10分)</h3>
      <p>PrismaClient の各種メソッドのうち、<code>findMany</code>
      のようにDBとデータのやりとりをするメソッドは基本的に「<strong>非同期処理</strong>」になっています。非同期メソッドは
      <code>await</code> と組み合わせないと期待する動作をしません
      (<code>await</code>の付け忘れは、初心者がハマるポイントです)。</p>
      <ul>
      <li><strong>同期処理</strong>と<strong>非同期処理</strong> (＝ <code>await</code> と
      <code>async</code> の基本的な使用法) については<a
      href="lecture07.html#同期処理と非同期処理">前回講義</a>で学習済みです。理解に不安がある人は復習しておいてください。</li>
      </ul>
      <p>以下のコードのように <code>findMany</code> メソッドに <code>await</code>
      を付け忘れると、どのようになるか (＝コンパイルエラーになるのか、ランタイムエラー
      (実行時エラー) になるのか、エラーが発生しないのか) を実際に確認してみてください。</p>
      <div class="sourceCode" id="cb23"
      data-caption="api/categories/route.ts (awaitを付け忘れ)"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb23-1"><a href="#cb23-1"></a><span class="im">import</span> prisma <span class="im">from</span> <span class="st">&quot;@/lib/prisma&quot;</span><span class="op">;</span></span>
<span id="cb23-2"><a href="#cb23-2"></a><span class="im">import</span> { NextResponse<span class="op">,</span> NextRequest } <span class="im">from</span> <span class="st">&quot;next/server&quot;</span><span class="op">;</span></span>
<span id="cb23-3"><a href="#cb23-3"></a></span>
<span id="cb23-4"><a href="#cb23-4"></a><span class="im">export</span> <span class="kw">const</span> GET <span class="op">=</span> <span class="kw">async</span> (req<span class="op">:</span> NextRequest) <span class="kw">=&gt;</span> {</span>
<span id="cb23-5"><a href="#cb23-5"></a>  <span class="cf">try</span> {</span>
<span id="cb23-6"><a href="#cb23-6"></a>    <span class="kw">const</span> categories <span class="op">=</span> prisma<span class="op">.</span><span class="at">category</span><span class="op">.</span><span class="fu">findMany</span>({ <span class="co">// ◀ 意図的にawait忘れ</span></span>
<span id="cb23-7"><a href="#cb23-7"></a>      orderBy<span class="op">:</span> {</span>
<span id="cb23-8"><a href="#cb23-8"></a>        createdAt<span class="op">:</span> <span class="st">&quot;desc&quot;</span><span class="op">,</span> </span>
<span id="cb23-9"><a href="#cb23-9"></a>      }<span class="op">,</span></span>
<span id="cb23-10"><a href="#cb23-10"></a>    })<span class="op">;</span></span>
<span id="cb23-11"><a href="#cb23-11"></a>    <span class="cf">return</span> NextResponse<span class="op">.</span><span class="fu">json</span>(categories)<span class="op">;</span></span>
<span id="cb23-12"><a href="#cb23-12"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb23-13"><a href="#cb23-13"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(error)<span class="op">;</span></span>
<span id="cb23-14"><a href="#cb23-14"></a>    <span class="cf">return</span> NextResponse<span class="op">.</span><span class="fu">json</span>(</span>
<span id="cb23-15"><a href="#cb23-15"></a>      { error<span class="op">:</span> <span class="st">&quot;カテゴリの取得に失敗しました&quot;</span> }<span class="op">,</span></span>
<span id="cb23-16"><a href="#cb23-16"></a>      { status<span class="op">:</span> <span class="dv">500</span> } </span>
<span id="cb23-17"><a href="#cb23-17"></a>    )<span class="op">;</span></span>
<span id="cb23-18"><a href="#cb23-18"></a>  }</span>
<span id="cb23-19"><a href="#cb23-19"></a>}<span class="op">;</span></span></code></pre></div>
      <p>コンパイルエラーも、実行時エラーも発生せず、<strong>非常に解決しずらいバグ</strong>🐛が誕生していること
      (=<span class="masked">何が問題でレスポンスが空になっているか分からない</span>)
      に注意してください。</p>
      <p>一方で、次のように <code>categories</code> に
      <strong>明示的に型を与えると</strong>、<code>await</code> を忘れているときに
      <strong>コンパイルエラーが発生して注意喚起してくれること</strong>
      (問題箇所が把握しやすいこと、問題を早期発見できること) を確認してください。</p>
      <div class="sourceCode" id="cb24"
      data-caption="api/categories/route.ts (awaitを付け忘れ・型を明示)"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb24-1"><a href="#cb24-1"></a><span class="im">import</span> prisma <span class="im">from</span> <span class="st">&quot;@/lib/prisma&quot;</span><span class="op">;</span></span>
<span id="cb24-2"><a href="#cb24-2"></a><span class="im">import</span> { NextResponse<span class="op">,</span> NextRequest } <span class="im">from</span> <span class="st">&quot;next/server&quot;</span><span class="op">;</span></span>
<span id="cb24-3"><a href="#cb24-3"></a><span class="im">import</span> { Category } <span class="im">from</span> <span class="st">&quot;@prisma/client&quot;</span><span class="op">;</span> <span class="co">// ◀ 型をインポート</span></span>
<span id="cb24-4"><a href="#cb24-4"></a></span>
<span id="cb24-5"><a href="#cb24-5"></a><span class="im">export</span> <span class="kw">const</span> GET <span class="op">=</span> <span class="kw">async</span> (req<span class="op">:</span> NextRequest) <span class="kw">=&gt;</span> {</span>
<span id="cb24-6"><a href="#cb24-6"></a>  <span class="cf">try</span> {</span>
<span id="cb24-7"><a href="#cb24-7"></a>    <span class="co">// ▼ 型を明示している</span></span>
<span id="cb24-8"><a href="#cb24-8"></a>    <span class="kw">const</span> categories<span class="op">:</span> Category[] <span class="op">=</span> prisma<span class="op">.</span><span class="at">category</span><span class="op">.</span><span class="fu">findMany</span>({ </span>
<span id="cb24-9"><a href="#cb24-9"></a>      orderBy<span class="op">:</span> {</span>
<span id="cb24-10"><a href="#cb24-10"></a>        createdAt<span class="op">:</span> <span class="st">&quot;desc&quot;</span><span class="op">,</span></span>
<span id="cb24-11"><a href="#cb24-11"></a>      }<span class="op">,</span></span>
<span id="cb24-12"><a href="#cb24-12"></a>    })<span class="op">;</span></span>
<span id="cb24-13"><a href="#cb24-13"></a>    <span class="cf">return</span> NextResponse<span class="op">.</span><span class="fu">json</span>(categories)<span class="op">;</span></span>
<span id="cb24-14"><a href="#cb24-14"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb24-15"><a href="#cb24-15"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(error)<span class="op">;</span></span>
<span id="cb24-16"><a href="#cb24-16"></a>    <span class="cf">return</span> NextResponse<span class="op">.</span><span class="fu">json</span>(</span>
<span id="cb24-17"><a href="#cb24-17"></a>      { error<span class="op">:</span> <span class="st">&quot;カテゴリの取得に失敗しました&quot;</span> }<span class="op">,</span></span>
<span id="cb24-18"><a href="#cb24-18"></a>      { status<span class="op">:</span> <span class="dv">500</span> } </span>
<span id="cb24-19"><a href="#cb24-19"></a>    )<span class="op">;</span></span>
<span id="cb24-20"><a href="#cb24-20"></a>  }</span>
<span id="cb24-21"><a href="#cb24-21"></a>}<span class="op">;</span></span></code></pre></div>
      <p>この例のように <span class="masked">「型」を明示するような堅牢なコード</span>
      を記述することで、結果的として効率的に開発を進めることできます。<strong>可読性を損なわない範囲で「型」を明示</strong>するようにしてください。</p>
      <h3 data-number="4.4.4" id="演習-10分-1"><span class="header-section-number">4.4.4</span> 演習
      (<i class="fa-solid fa-stopwatch"></i>10分)</h3>
      <p>次のように意図的にエラーを発生させるコード (<strong>第12行目</strong>)
      を追加してください。そのうえで、<strong>Thunder Client</strong> から HTTPリクエスト
      を送信し、そのレスポンスがどのようになるか
      (<strong>ステータスコード</strong>や<strong>レスポンスのボディ</strong>がどのようになるか)
      を確認してください。</p>
      <p>また、VSCodeのターミナルのログも確認してください。</p>
      <div class="sourceCode" id="cb25"
      data-caption="api/categories/route.ts (意図的にエラーを発生)"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb25-1"><a href="#cb25-1"></a><span class="im">import</span> prisma <span class="im">from</span> <span class="st">&quot;@/lib/prisma&quot;</span><span class="op">;</span></span>
<span id="cb25-2"><a href="#cb25-2"></a><span class="im">import</span> { NextResponse<span class="op">,</span> NextRequest } <span class="im">from</span> <span class="st">&quot;next/server&quot;</span><span class="op">;</span></span>
<span id="cb25-3"><a href="#cb25-3"></a><span class="im">import</span> { Category } <span class="im">from</span> <span class="st">&quot;@prisma/client&quot;</span><span class="op">;</span></span>
<span id="cb25-4"><a href="#cb25-4"></a></span>
<span id="cb25-5"><a href="#cb25-5"></a><span class="im">export</span> <span class="kw">const</span> GET <span class="op">=</span> <span class="kw">async</span> (req<span class="op">:</span> NextRequest) <span class="kw">=&gt;</span> {</span>
<span id="cb25-6"><a href="#cb25-6"></a>  <span class="cf">try</span> {</span>
<span id="cb25-7"><a href="#cb25-7"></a>    <span class="kw">const</span> categories<span class="op">:</span> Category[] <span class="op">=</span> <span class="cf">await</span> prisma<span class="op">.</span><span class="at">category</span><span class="op">.</span><span class="fu">findMany</span>({</span>
<span id="cb25-8"><a href="#cb25-8"></a>      orderBy<span class="op">:</span> {</span>
<span id="cb25-9"><a href="#cb25-9"></a>        createdAt<span class="op">:</span> <span class="st">&quot;desc&quot;</span><span class="op">,</span></span>
<span id="cb25-10"><a href="#cb25-10"></a>      }<span class="op">,</span></span>
<span id="cb25-11"><a href="#cb25-11"></a>    })<span class="op">;</span></span>
<span id="cb25-12"><a href="#cb25-12"></a>    <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&quot;意図的にエラーを発生させる!!!&quot;</span>)<span class="op">;</span> <span class="co">// ◀ 追加</span></span>
<span id="cb25-13"><a href="#cb25-13"></a>    <span class="cf">return</span> NextResponse<span class="op">.</span><span class="fu">json</span>(categories)<span class="op">;</span></span>
<span id="cb25-14"><a href="#cb25-14"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb25-15"><a href="#cb25-15"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(error)<span class="op">;</span></span>
<span id="cb25-16"><a href="#cb25-16"></a>    <span class="cf">return</span> NextResponse<span class="op">.</span><span class="fu">json</span>(</span>
<span id="cb25-17"><a href="#cb25-17"></a>      { error<span class="op">:</span> <span class="st">&quot;カテゴリの取得に失敗しました&quot;</span> }<span class="op">,</span></span>
<span id="cb25-18"><a href="#cb25-18"></a>      { status<span class="op">:</span> <span class="dv">500</span> } <span class="co">// 500: Internal Server Error</span></span>
<span id="cb25-19"><a href="#cb25-19"></a>    )<span class="op">;</span></span>
<span id="cb25-20"><a href="#cb25-20"></a>  }</span>
<span id="cb25-21"><a href="#cb25-21"></a>}<span class="op">;</span></span></code></pre></div>
      <ul>
      <li>例外処理 <code>try ~ catch</code> の概念については<a
      href="https://takeshiwada1980.github.io/Programming1-2023/lecture28.html#例外処理">プログラミング1</a>で学習済みです。理解に不安がある場合は、生成AIなどを利用して概要を理解してください。</li>
      </ul>
      <p><strong>(プロンプト例)</strong></p>
      <blockquote>
      <p>TypeScriptにおける例外処理について解説してください。特に
      <code>try</code>、<code>catch</code>、<code>throw</code>
      のキーワードと使い方について解説してください。</p>
      </blockquote>
      <h3 data-number="4.4.5" id="演習-15分-1"><span class="header-section-number">4.4.5</span> 演習
      (<i class="fa-solid fa-stopwatch"></i>15分)</h3>
      <p><code>api/categories/route.ts</code>
      について、HTTPリクエストを正常に処理できた場合の「戻り値
      (=<code>NextResponse</code>)」を、次のように変更したとき、レスポンスの「ステータスコード」と「レスポンスのボディ」がどのように変化するか
      (あるいは変化しないのか) を <strong>Thunder Client</strong> から確認してください。</p>
      <div class="sourceCode" id="cb26" data-caption="変更前"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb26-1"><a href="#cb26-1"></a><span class="cf">return</span> NextResponse<span class="op">.</span><span class="fu">json</span>(categories)<span class="op">;</span></span></code></pre></div>
      <p>また、<strong>各変更に「どのような意味があるか (あるいは意味がないか)」</strong>
      についても、生成AIを利用して考察してみてください。</p>
      <p><strong>(プロンプト例)</strong></p>
      <blockquote>
      <p>Next.js (App Router) の API Routes の戻り値として
      <code>return NextResponse.json(categories);</code> を
      <code>return NextResponse.json(categories, { status: 200 });</code>
      に書き換えることには、どのような意味や意図があると考えられますか。</p>
      </blockquote>
      <hr />
      <p><strong>変更1</strong> : <code>NextResponse.json</code>
      メソッドの<strong>第2引数</strong>に「<strong>ステータスコード「200」</strong>」を明示的に与える。</p>
      <div class="sourceCode" id="cb27" data-caption="変更1"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb27-1"><a href="#cb27-1"></a><span class="cf">return</span> NextResponse<span class="op">.</span><span class="fu">json</span>(categories<span class="op">,</span> { status<span class="op">:</span> <span class="dv">200</span> })<span class="op">;</span></span></code></pre></div>
      <hr />
      <p><strong>変更2</strong> : <code>NextResponse.json</code> メソッドの <strong>第1引数</strong>
      を次のように変更する。</p>
      <div class="sourceCode" id="cb28" data-caption="変更2a"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb28-1"><a href="#cb28-1"></a><span class="cf">return</span> NextResponse<span class="op">.</span><span class="fu">json</span>({ contents<span class="op">:</span> categories })<span class="op">;</span></span></code></pre></div>
      <div class="sourceCode" id="cb29" data-caption="変更2b"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb29-1"><a href="#cb29-1"></a><span class="cf">return</span> NextResponse<span class="op">.</span><span class="fu">json</span>({</span>
<span id="cb29-2"><a href="#cb29-2"></a>  isSuccess<span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb29-3"><a href="#cb29-3"></a>  contents<span class="op">:</span> categories<span class="op">,</span></span>
<span id="cb29-4"><a href="#cb29-4"></a>})<span class="op">;</span></span></code></pre></div>
      <h3 data-number="4.4.6" id="ex演習-宿題-20分"><span class="header-section-number">4.4.6</span>
      EX演習 (宿題: <i class="fa-solid fa-stopwatch"></i>20分)</h3>
      <p><code>prisma.category.findMany</code> の <strong>第1引数</strong>
      に与えるオブジェクトを次のように変更すると、<code>categories</code>
      に格納されるデータがどのように変わるかを確認してください
      (ThunderClientでレスポンスのボディを確認してください)。</p>
      <p>なお、ここでは <code>categories: Category[] = ...</code>
      のように型を指定するとコンパイルエラーになるので注意してください。</p>
      <div class="sourceCode" id="cb30" data-caption="selectプロパティの追加1"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb30-1"><a href="#cb30-1"></a><span class="kw">const</span> categories <span class="op">=</span> <span class="cf">await</span> prisma<span class="op">.</span><span class="at">category</span><span class="op">.</span><span class="fu">findMany</span>({</span>
<span id="cb30-2"><a href="#cb30-2"></a>  select<span class="op">:</span> {</span>
<span id="cb30-3"><a href="#cb30-3"></a>    id<span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb30-4"><a href="#cb30-4"></a>    name<span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb30-5"><a href="#cb30-5"></a>  }<span class="op">,</span></span>
<span id="cb30-6"><a href="#cb30-6"></a>  orderBy<span class="op">:</span> {</span>
<span id="cb30-7"><a href="#cb30-7"></a>    createdAt<span class="op">:</span> <span class="st">&quot;desc&quot;</span><span class="op">,</span></span>
<span id="cb30-8"><a href="#cb30-8"></a>  }<span class="op">,</span></span>
<span id="cb30-9"><a href="#cb30-9"></a>})<span class="op">;</span></span></code></pre></div>
      <div class="sourceCode" id="cb31" data-caption="selectプロパティの追加2"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb31-1"><a href="#cb31-1"></a><span class="kw">const</span> categories <span class="op">=</span> <span class="cf">await</span> prisma<span class="op">.</span><span class="at">category</span><span class="op">.</span><span class="fu">findMany</span>({</span>
<span id="cb31-2"><a href="#cb31-2"></a>  select<span class="op">:</span> {</span>
<span id="cb31-3"><a href="#cb31-3"></a>    id<span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb31-4"><a href="#cb31-4"></a>    name<span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb31-5"><a href="#cb31-5"></a>    posts<span class="op">:</span> {</span>
<span id="cb31-6"><a href="#cb31-6"></a>      select<span class="op">:</span> {</span>
<span id="cb31-7"><a href="#cb31-7"></a>        post<span class="op">:</span> {</span>
<span id="cb31-8"><a href="#cb31-8"></a>          select<span class="op">:</span> {</span>
<span id="cb31-9"><a href="#cb31-9"></a>            id<span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb31-10"><a href="#cb31-10"></a>            title<span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb31-11"><a href="#cb31-11"></a>          }<span class="op">,</span></span>
<span id="cb31-12"><a href="#cb31-12"></a>        }<span class="op">,</span></span>
<span id="cb31-13"><a href="#cb31-13"></a>      }<span class="op">,</span></span>
<span id="cb31-14"><a href="#cb31-14"></a>    }<span class="op">,</span></span>
<span id="cb31-15"><a href="#cb31-15"></a>  }<span class="op">,</span></span>
<span id="cb31-16"><a href="#cb31-16"></a>  orderBy<span class="op">:</span> {</span>
<span id="cb31-17"><a href="#cb31-17"></a>    createdAt<span class="op">:</span> <span class="st">&quot;desc&quot;</span><span class="op">,</span></span>
<span id="cb31-18"><a href="#cb31-18"></a>  }<span class="op">,</span></span>
<span id="cb31-19"><a href="#cb31-19"></a>})<span class="op">;</span></span></code></pre></div>
      <div class="sourceCode" id="cb32" data-caption="_countプロパティの追加"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb32-1"><a href="#cb32-1"></a><span class="kw">const</span> categories <span class="op">=</span> <span class="cf">await</span> prisma<span class="op">.</span><span class="at">category</span><span class="op">.</span><span class="fu">findMany</span>({</span>
<span id="cb32-2"><a href="#cb32-2"></a>  select<span class="op">:</span> {</span>
<span id="cb32-3"><a href="#cb32-3"></a>    id<span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb32-4"><a href="#cb32-4"></a>    name<span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb32-5"><a href="#cb32-5"></a>    _count<span class="op">:</span> {</span>
<span id="cb32-6"><a href="#cb32-6"></a>      select<span class="op">:</span> {</span>
<span id="cb32-7"><a href="#cb32-7"></a>        posts<span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb32-8"><a href="#cb32-8"></a>      }<span class="op">,</span></span>
<span id="cb32-9"><a href="#cb32-9"></a>    }<span class="op">,</span></span>
<span id="cb32-10"><a href="#cb32-10"></a>  }<span class="op">,</span></span>
<span id="cb32-11"><a href="#cb32-11"></a>  orderBy<span class="op">:</span> {</span>
<span id="cb32-12"><a href="#cb32-12"></a>    createdAt<span class="op">:</span> <span class="st">&quot;desc&quot;</span><span class="op">,</span></span>
<span id="cb32-13"><a href="#cb32-13"></a>  }<span class="op">,</span></span>
<span id="cb32-14"><a href="#cb32-14"></a>})<span class="op">;</span></span></code></pre></div>
      <p><strong>(プロンプト例)</strong></p>
      <blockquote>
      <p>Next.js において Prisma を使ってバックエンド開発をしています。<code>schema.prisma</code>
      は次のようになっています。<br />
      ～ (ここに <code>schema.prisma</code> を貼付け) ～<br />
      次のように PrismaClient の <code>findMany</code> メソッドを実行すると、<code>categories</code>
      にはどのような値が得られますか。特に、メソッド引数の <code>select</code> と
      <code>_count</code> の意味について解説してください。</p>
      </blockquote>
      <h2 data-number="4.5" id="カテゴリを追加するウェブapiの実装"><span
      class="header-section-number">4.5</span> カテゴリを追加するウェブAPIの実装</h2>
      <p><strong>カテゴリを追加 (新規作成) するウェブAPI</strong>を実装します。</p>
      <p>このAPIは、将来的に (次々回以降の講義で) <span
      class="masked">管理者でログインしている場合のみ受理される</span>
      ように拡張していくので、エンドポイントを <code>/api/admin/categories</code>
      のように設計したいと思います。また、リソースの追加処理に相当するので HTTP Method の <span
      class="masked">POST</span> に対応させるように実装します。</p>
      <p>次の位置に <code>route.ts</code> を新規作成してください。</p>
      <pre><code>📂 src/
└─ 📂 app/
    └─ 📂 api/
        ├─ 📂 categories/
        │   └─ route.ts ( GET 作成済み )
        └─ 📂 admin/
            └─ 📂 categories/
                └─ route.ts ◀◀◀ 新規作成</code></pre>
      <p>次のプログラムを <code>route.ts</code>
      に貼り付けてください。コードの解説は後回しにします。</p>
      <div class="sourceCode" id="cb34"
      data-caption="api/admin/categories/route.ts (カテゴリの追加)"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb34-1"><a href="#cb34-1"></a><span class="im">import</span> prisma <span class="im">from</span> <span class="st">&quot;@/lib/prisma&quot;</span><span class="op">;</span></span>
<span id="cb34-2"><a href="#cb34-2"></a><span class="im">import</span> { NextResponse<span class="op">,</span> NextRequest } <span class="im">from</span> <span class="st">&quot;next/server&quot;</span><span class="op">;</span></span>
<span id="cb34-3"><a href="#cb34-3"></a><span class="im">import</span> { Category } <span class="im">from</span> <span class="st">&quot;@prisma/client&quot;</span><span class="op">;</span></span>
<span id="cb34-4"><a href="#cb34-4"></a></span>
<span id="cb34-5"><a href="#cb34-5"></a><span class="kw">type</span> RequestBody <span class="op">=</span> {</span>
<span id="cb34-6"><a href="#cb34-6"></a>  name<span class="op">:</span> <span class="dt">string</span><span class="op">;</span></span>
<span id="cb34-7"><a href="#cb34-7"></a>}<span class="op">;</span></span>
<span id="cb34-8"><a href="#cb34-8"></a></span>
<span id="cb34-9"><a href="#cb34-9"></a><span class="im">export</span> <span class="kw">const</span> POST <span class="op">=</span> <span class="kw">async</span> (req<span class="op">:</span> NextRequest) <span class="kw">=&gt;</span> {</span>
<span id="cb34-10"><a href="#cb34-10"></a>  <span class="cf">try</span> {</span>
<span id="cb34-11"><a href="#cb34-11"></a>    <span class="kw">const</span> { name }<span class="op">:</span> RequestBody <span class="op">=</span> <span class="cf">await</span> req<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb34-12"><a href="#cb34-12"></a>    <span class="kw">const</span> category<span class="op">:</span> Category <span class="op">=</span> <span class="cf">await</span> prisma<span class="op">.</span><span class="at">category</span><span class="op">.</span><span class="fu">create</span>({</span>
<span id="cb34-13"><a href="#cb34-13"></a>      data<span class="op">:</span> {</span>
<span id="cb34-14"><a href="#cb34-14"></a>        name<span class="op">,</span></span>
<span id="cb34-15"><a href="#cb34-15"></a>      }<span class="op">,</span></span>
<span id="cb34-16"><a href="#cb34-16"></a>    })<span class="op">;</span></span>
<span id="cb34-17"><a href="#cb34-17"></a>    <span class="cf">return</span> NextResponse<span class="op">.</span><span class="fu">json</span>(category)<span class="op">;</span></span>
<span id="cb34-18"><a href="#cb34-18"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb34-19"><a href="#cb34-19"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(error)<span class="op">;</span></span>
<span id="cb34-20"><a href="#cb34-20"></a>    <span class="cf">return</span> NextResponse<span class="op">.</span><span class="fu">json</span>(</span>
<span id="cb34-21"><a href="#cb34-21"></a>      { error<span class="op">:</span> <span class="st">&quot;カテゴリの作成に失敗しました&quot;</span> }<span class="op">,</span></span>
<span id="cb34-22"><a href="#cb34-22"></a>      { status<span class="op">:</span> <span class="dv">500</span> }</span>
<span id="cb34-23"><a href="#cb34-23"></a>    )<span class="op">;</span></span>
<span id="cb34-24"><a href="#cb34-24"></a>  }</span>
<span id="cb34-25"><a href="#cb34-25"></a>}<span class="op">;</span></span></code></pre></div>
      <p>開発モード (<code>npm run dev</code>) でアプリを起動して、以下のように <strong>Thunder
      Client</strong> からAPIをテストしてください。この APIは、<strong>リソース (カテゴリ)
      を追加をするもの</strong> なので、HTTP Method
      を「<strong>POST</strong>」に切り替えていることに注意してください。また、エンドポイントのパスに
      <code>admin</code> を含めている点にも注意してください。</p>
      <p>さらに、<strong>HTTPリクエストのボディ (Body)</strong>に、新規作成するカテゴリの
      <strong>名前</strong> (<code>name</code>) をJSON形式で与えていることに注目してください。</p>
      <figure>
      <img src="figs/08/vscode_10.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>なお、既存のカテゴリの名前 (＝例えば、シーディングで挿入した「カテゴリ1」など)
      をボディに設定してリクエストを送信すると <span class="masked">Unique constraint failed on the
      fields: (<code>name</code>)</span> というエラーで失敗します
      (その原理で、<strong>同じリクエストを2回送信したときにも失敗します</strong>)。これは
      <code>schema.prisma</code> の <strong>第31行目</strong> で <code>@unique</code> (ユニーク制約
      (値の重複を許可しない制約)) を与えているためです。</p>
      <p><strong>(プロンプト例)</strong></p>
      <blockquote>
      <p>Prisma の <code>schema.prisma</code> で <code>name String @unique</code>
      のようにカラムを設定しています。このカラムに適用される制約について解説してください。</p>
      </blockquote>
      <p>つづいて、Prisma Studio を起動して (<code>npx prisma studio</code>を実行して)
      <strong>カテゴリテーブルにレコードが追加されていること</strong>を確認してください。あるいは
      <code>/api/categories</code> に <span class="masked">GETリクエスト</span>
      を送って、そのレスポンスから <span class="masked">カテゴリが正常に追加されていること</span>
      を確認してください。</p>
      <figure>
      <img src="figs/08/prisma_06.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>(既に解説したように、Prisma Studio では、レコードは <code>id</code>
      でソートされていることに注意してください。追加したカテゴリが末尾に位置するわけではありません)</p>
      <div class="note type-tips">
      <p><strong>VSCode: ターミナルの追加と切り替え</strong></p>
      <p>VSCodeでは、下図のように「<strong>＋</strong>」ボタンを押下するとターミナル (セッション)
      を追加することができます。そして、1個目のターミナルで <code>rpm run dev</code>
      を実行して、2個目のターミナルで <code>npx prisma studio</code>
      を実行するような使い方ができます。</p>
      <figure>
      <img src="figs/08/vscode_13.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      </div>
      <h3 data-number="4.5.1" id="演習"><span class="header-section-number">4.5.1</span> 演習</h3>
      <ul>
      <li>HTTPリクエストのボディを以下のように設定して POST したとき、レスポンスがどのようになるかを
      Thunder Client を利用して確認してください。</li>
      </ul>
      <div class="sourceCode" id="cb35" data-caption="nameプロパティがない"><pre
      class="sourceCode json"><code class="sourceCode json"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;title&quot;</span><span class="fu">:</span> <span class="st">&quot;カテゴリ9&quot;</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
      <ul>
      <li>HTTPリクエストのボディを以下のように設定して POST したとき、どのようなレスポンスになるかを
      Thunder Client を利用して確認してください。</li>
      </ul>
      <div class="sourceCode" id="cb36" data-caption="想定外のプロパティ age を含む"><pre
      class="sourceCode json"><code class="sourceCode json"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;age&quot;</span><span class="fu">:</span> <span class="dv">20</span><span class="fu">,</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;カテゴリ9&quot;</span><span class="fu">,</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
      <ul>
      <li>HTTP Method を「<strong>POST</strong>」から「<strong>GET</strong>」に切り替えて
      <code>/api/admin/categories</code> にリクエストすると、どのようなレスポンスになるか
      (特に、どのようなステータスコードになるか) を Thunder Client を利用して確認してください。</li>
      </ul>
      <h2 data-number="4.6" id="カテゴリを追加するウェブapiの実装-コードの解説"><span
      class="header-section-number">4.6</span> カテゴリを追加するウェブAPIの実装 (コードの解説)</h2>
      <p>解説のためにコードを再掲します。</p>
      <div class="sourceCode" id="cb37"
      data-caption="api/admin/categories/route.ts (カテゴリの追加・再掲)"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb37-1"><a href="#cb37-1"></a><span class="im">import</span> prisma <span class="im">from</span> <span class="st">&quot;@/lib/prisma&quot;</span><span class="op">;</span></span>
<span id="cb37-2"><a href="#cb37-2"></a><span class="im">import</span> { NextResponse<span class="op">,</span> NextRequest } <span class="im">from</span> <span class="st">&quot;next/server&quot;</span><span class="op">;</span></span>
<span id="cb37-3"><a href="#cb37-3"></a><span class="im">import</span> { Category } <span class="im">from</span> <span class="st">&quot;@prisma/client&quot;</span><span class="op">;</span></span>
<span id="cb37-4"><a href="#cb37-4"></a></span>
<span id="cb37-5"><a href="#cb37-5"></a><span class="kw">type</span> RequestBody <span class="op">=</span> {</span>
<span id="cb37-6"><a href="#cb37-6"></a>  name<span class="op">:</span> <span class="dt">string</span><span class="op">;</span></span>
<span id="cb37-7"><a href="#cb37-7"></a>}<span class="op">;</span></span>
<span id="cb37-8"><a href="#cb37-8"></a></span>
<span id="cb37-9"><a href="#cb37-9"></a><span class="im">export</span> <span class="kw">const</span> POST <span class="op">=</span> <span class="kw">async</span> (req<span class="op">:</span> NextRequest) <span class="kw">=&gt;</span> {</span>
<span id="cb37-10"><a href="#cb37-10"></a>  <span class="cf">try</span> {</span>
<span id="cb37-11"><a href="#cb37-11"></a>    <span class="kw">const</span> { name }<span class="op">:</span> RequestBody <span class="op">=</span> <span class="cf">await</span> req<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb37-12"><a href="#cb37-12"></a>    <span class="kw">const</span> category<span class="op">:</span> Category <span class="op">=</span> <span class="cf">await</span> prisma<span class="op">.</span><span class="at">category</span><span class="op">.</span><span class="fu">create</span>({</span>
<span id="cb37-13"><a href="#cb37-13"></a>      data<span class="op">:</span> {</span>
<span id="cb37-14"><a href="#cb37-14"></a>        name<span class="op">,</span></span>
<span id="cb37-15"><a href="#cb37-15"></a>      }<span class="op">,</span></span>
<span id="cb37-16"><a href="#cb37-16"></a>    })<span class="op">;</span></span>
<span id="cb37-17"><a href="#cb37-17"></a>    <span class="cf">return</span> NextResponse<span class="op">.</span><span class="fu">json</span>(category)<span class="op">;</span></span>
<span id="cb37-18"><a href="#cb37-18"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb37-19"><a href="#cb37-19"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(error)<span class="op">;</span></span>
<span id="cb37-20"><a href="#cb37-20"></a>    <span class="cf">return</span> NextResponse<span class="op">.</span><span class="fu">json</span>(</span>
<span id="cb37-21"><a href="#cb37-21"></a>      { error<span class="op">:</span> <span class="st">&quot;カテゴリの作成に失敗しました&quot;</span> }<span class="op">,</span></span>
<span id="cb37-22"><a href="#cb37-22"></a>      { status<span class="op">:</span> <span class="dv">500</span> }</span>
<span id="cb37-23"><a href="#cb37-23"></a>    )<span class="op">;</span></span>
<span id="cb37-24"><a href="#cb37-24"></a>  }</span>
<span id="cb37-25"><a href="#cb37-25"></a>}<span class="op">;</span></span></code></pre></div>
      <p><strong>第05行目</strong> から <strong>第07行目</strong> で、HTTPリクエストの
      <strong>ボディ</strong> として受け取るオブジェクトの型を <code>RequestBody</code>
      として定義しています。</p>
      <p>そして、<strong>第11行目</strong> で、実際にリクエストのボディから <code>name</code>
      の値を取得しています。この取得に際しては、TypeScript (JavaScript) の <strong>分割代入</strong>
      というテクニックが使われています
      (分割代入については生成AIを利用して理解しておいてください)。<strong>第11行目</strong>
      の処理を分割代入を使わずに分解して書けば、以下のようになります。</p>
      <div class="sourceCode" id="cb38" data-caption="api/admin/categories/route.ts (抜粋)"
      data-startFrom="11"><pre class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript" style="counter-reset: source-line 10;"><span id="cb38-11"><a href="#cb38-11"></a><span class="kw">const</span> requestBody <span class="op">:</span> RequestBody <span class="op">=</span> <span class="cf">await</span> req<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb38-12"><a href="#cb38-12"></a><span class="kw">const</span> name <span class="op">=</span> requestBody<span class="op">.</span><span class="at">name</span><span class="op">;</span></span></code></pre></div>
      <p>なお、<code>req.json</code> メソッドも非同期なので <code>await</code>
      を忘れないようにしてください。</p>
      <p><strong>(プロンプト例)</strong></p>
      <blockquote>
      <p>TypeScript (JavaScript) における <code>const { id, name } = user</code>
      のような「分割代入」について解説してください。</p>
      </blockquote>
      <blockquote>
      <p>TypeScript (JavaScript)
      の「分割代入」には、どのようなメリットとデメリットがありますか。</p>
      </blockquote>
      <p><strong>第12行目</strong> から <strong>第15行目</strong> では、PrismaClient の
      <code>create</code> というメソッドを使ってカテゴリを追加しています。<code>create</code>
      メソッドでは、実際に追加されたレコード (単体のカテゴリ) が戻り値となります
      (厳密には、<code>create</code> メソッドの戻り値を <code>await</code>
      した戻り値がレコードになります)。そして、その値をそのまま <strong>第17行目</strong>
      でHTTPレスポンスのボディに設定しています。</p>
      <div class="note type-tips">
      <p><strong>Thunder Client: リクエストには名前を付けておきましょう</strong></p>
      <p>面倒かもしれませんが、各HTTPリクエストに適切に名前をつけておくと、結果的に、長期視点では開発の時短につながります。</p>
      <figure>
      <img src="figs/08/vscode_14.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      </div>
      <h2 data-number="4.7" id="カテゴリを削除するウェブapiの実装"><span
      class="header-section-number">4.7</span> カテゴリを削除するウェブAPIの実装</h2>
      <p><code>api/admin/categories/[id]</code>
      のようなエンドポイントに、<strong>カテゴリを削除するAPI</strong>
      を実装します。このAPIも管理者だけが実行できるように拡張する予定なので、次のように
      <code>admin</code> を含むパスに配置します。</p>
      <pre><code>📂 src/
└─ 📂 app/
    └─ 📂 api/
        ├─ 📂 categories/
        │   └─ route.ts ( GET 作成済み )
        └─ 📂 admin/
            └─ 📂 categories/
                ├─ route.ts ( POST 作成済み )
                └─ 📂 [id]/
                    └─ route.ts ◀ 新規作成</code></pre>
      <p><a
      href="lecture07.html#投稿記事の詳細を表示するコンテンツの作成">前回講義</a>で解説したように、Next.js
      において <code>[id]</code> のような角括弧で囲んだ表記は
      <strong>パラメータプレースホルダ</strong>
      といい、そこには動的に値が入ること意味します。例えば、削除したいカテゴリの <code>id</code> が
      <code>24f932b8-....-569f07ba16a7</code>
      の場合、具体的なエンドポイントは次のようになります。</p>
      <ul>
      <li><code>/api/admin/categories/24f932b8-...-569f07ba16a7</code></li>
      </ul>
      <p><code>route.ts</code> に次のプログラムを貼付けて保存してください。</p>
      <div class="sourceCode" id="cb40"
      data-caption="api/admin/categories/[id]/route.ts (カテゴリの削除)"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb40-1"><a href="#cb40-1"></a><span class="im">import</span> prisma <span class="im">from</span> <span class="st">&quot;@/lib/prisma&quot;</span><span class="op">;</span></span>
<span id="cb40-2"><a href="#cb40-2"></a><span class="im">import</span> { NextResponse<span class="op">,</span> NextRequest } <span class="im">from</span> <span class="st">&quot;next/server&quot;</span><span class="op">;</span></span>
<span id="cb40-3"><a href="#cb40-3"></a><span class="im">import</span> { Category } <span class="im">from</span> <span class="st">&quot;@prisma/client&quot;</span><span class="op">;</span></span>
<span id="cb40-4"><a href="#cb40-4"></a></span>
<span id="cb40-5"><a href="#cb40-5"></a><span class="kw">type</span> RouteParams <span class="op">=</span> {</span>
<span id="cb40-6"><a href="#cb40-6"></a>  params<span class="op">:</span> {</span>
<span id="cb40-7"><a href="#cb40-7"></a>    id<span class="op">:</span> <span class="dt">string</span><span class="op">;</span></span>
<span id="cb40-8"><a href="#cb40-8"></a>  }<span class="op">;</span></span>
<span id="cb40-9"><a href="#cb40-9"></a>}<span class="op">;</span></span>
<span id="cb40-10"><a href="#cb40-10"></a></span>
<span id="cb40-11"><a href="#cb40-11"></a><span class="im">export</span> <span class="kw">const</span> DELETE <span class="op">=</span> <span class="kw">async</span> (req<span class="op">:</span> NextRequest<span class="op">,</span> routeParams<span class="op">:</span> RouteParams) <span class="kw">=&gt;</span> {</span>
<span id="cb40-12"><a href="#cb40-12"></a>  <span class="cf">try</span> {</span>
<span id="cb40-13"><a href="#cb40-13"></a>    <span class="kw">const</span> id <span class="op">=</span> routeParams<span class="op">.</span><span class="at">params</span><span class="op">.</span><span class="at">id</span><span class="op">;</span></span>
<span id="cb40-14"><a href="#cb40-14"></a>    <span class="kw">const</span> category<span class="op">:</span> Category <span class="op">=</span> <span class="cf">await</span> prisma<span class="op">.</span><span class="at">category</span><span class="op">.</span><span class="fu">delete</span>({ where<span class="op">:</span> { id } })<span class="op">;</span></span>
<span id="cb40-15"><a href="#cb40-15"></a>    <span class="cf">return</span> NextResponse<span class="op">.</span><span class="fu">json</span>({ msg<span class="op">:</span> <span class="vs">`「</span><span class="sc">${</span>category<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">」を削除しました。`</span> })<span class="op">;</span></span>
<span id="cb40-16"><a href="#cb40-16"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb40-17"><a href="#cb40-17"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(error)<span class="op">;</span></span>
<span id="cb40-18"><a href="#cb40-18"></a>    <span class="cf">return</span> NextResponse<span class="op">.</span><span class="fu">json</span>(</span>
<span id="cb40-19"><a href="#cb40-19"></a>      { error<span class="op">:</span> <span class="st">&quot;カテゴリの削除に失敗しました&quot;</span> }<span class="op">,</span></span>
<span id="cb40-20"><a href="#cb40-20"></a>      { status<span class="op">:</span> <span class="dv">500</span> }</span>
<span id="cb40-21"><a href="#cb40-21"></a>    )<span class="op">;</span></span>
<span id="cb40-22"><a href="#cb40-22"></a>  }</span>
<span id="cb40-23"><a href="#cb40-23"></a>}<span class="op">;</span></span></code></pre></div>
      <p>URLパスのパラメータプレースホルダ <code>[id]</code>
      で与えられる値は、<strong>第05行</strong>の <code>RouteParams</code>
      の型定義、<strong>第11行目</strong> の <code>DELETE</code>
      関数定義の「<strong>第2引数</strong>」、<strong>第13行目</strong> の
      <code>id = routeParams.params.id</code>
      によって取得できます。例えば、<code>/api/admin/categories/aaa</code>
      というエンドポイントにリクエストがあれば、<strong>第13行目</strong> の <code>id</code> には
      <code>"aaa"</code> という文字列が代入されます。</p>
      <div class="note type-senior">
      <p><strong>発展: プレースホルダーパラメータ取得の定石</strong></p>
      <p>ここでは、<code>RouteParams</code> という型を定義してプレースホルダーパラメータ
      (<code>id</code>) を取得しましたが、以下のコードのように <strong>インライン型注釈</strong>
      (Inline Type Annotation) と <strong>分割代入</strong> を利用して型を定義せず、直接的に
      <code>id</code> を取得することも可能です。</p>
      <div class="sourceCode" id="cb41"
      data-caption="api/admin/categories/[id]/route.ts (インライン型注釈と分割代入の利用)"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb41-1"><a href="#cb41-1"></a><span class="im">import</span> prisma <span class="im">from</span> <span class="st">&quot;@/lib/prisma&quot;</span><span class="op">;</span></span>
<span id="cb41-2"><a href="#cb41-2"></a><span class="im">import</span> { NextResponse<span class="op">,</span> NextRequest } <span class="im">from</span> <span class="st">&quot;next/server&quot;</span><span class="op">;</span></span>
<span id="cb41-3"><a href="#cb41-3"></a><span class="im">import</span> { Category } <span class="im">from</span> <span class="st">&quot;@prisma/client&quot;</span><span class="op">;</span></span>
<span id="cb41-4"><a href="#cb41-4"></a></span>
<span id="cb41-5"><a href="#cb41-5"></a><span class="im">export</span> <span class="kw">const</span> DELETE <span class="op">=</span> <span class="kw">async</span> (</span>
<span id="cb41-6"><a href="#cb41-6"></a>  req<span class="op">:</span> NextRequest<span class="op">,</span></span>
<span id="cb41-7"><a href="#cb41-7"></a>  { params<span class="op">:</span> { id } }<span class="op">:</span> { params<span class="op">:</span> { id<span class="op">:</span> <span class="dt">string</span> } } <span class="co">// インライン型注釈・分割代入</span></span>
<span id="cb41-8"><a href="#cb41-8"></a>) <span class="kw">=&gt;</span> {</span>
<span id="cb41-9"><a href="#cb41-9"></a>  <span class="cf">try</span> {</span>
<span id="cb41-10"><a href="#cb41-10"></a>    <span class="kw">const</span> category<span class="op">:</span> Category <span class="op">=</span> <span class="cf">await</span> prisma<span class="op">.</span><span class="at">category</span><span class="op">.</span><span class="fu">delete</span>({ where<span class="op">:</span> { id } })<span class="op">;</span></span>
<span id="cb41-11"><a href="#cb41-11"></a><span class="co">// 以下、省略</span></span></code></pre></div>
      <p>一般には上記のような表記がよく使用されるので、最初は型定義を使う方法で理解を深め、慣れてきたらインライン型注釈と分割代入を利用する方法に移行することも検討してください。</p>
      <p><strong>(プロンプト例)</strong></p>
      <blockquote>
      <p>TypeScript の インライン型注釈 (Inline Type Annotation) について、関数の引数
      (オブジェクト型) に適用する例で解説してください。また、<code>type</code>
      キーワードで「型」を定義せず、インライン型注釈を使うメリットとデメリットは何ですか？</p>
      </blockquote>
      </div>
      <p>削除処理は <strong>第14行目</strong> にある <code>prisma.category.delete()</code>
      メソッドにより実行されます。このメソッドは、<strong>指定された条件に一致する「単一のレコード」を削除する機能</strong>
      を持っています。</p>
      <div class="note type-tips">
      <p><strong>deleteメソッドに対する条件の与え方</strong></p>
      <p>deleteメソッドには、引数を使って「削除対象を指定する条件」を与えます。例えば、<code>"c-1234"</code>
      という <code>id</code> のレコード (カテゴリ)
      を削除したいときは、次のように引数を指定します。</p>
      <div class="sourceCode" id="cb42" data-caption="deleteメソッドの引数の指定の説明1"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb42-1"><a href="#cb42-1"></a>prisma<span class="op">.</span><span class="at">category</span><span class="op">.</span><span class="fu">delete</span>({ where<span class="op">:</span> { id<span class="op">:</span> <span class="st">&quot;c-1234&quot;</span> } })<span class="op">;</span></span></code></pre></div>
      <p>この処理は、<code>id</code> という変数を使って次のようにも書けます。</p>
      <div class="sourceCode" id="cb43" data-caption="deleteメソッドの引数の指定の説明2"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb43-1"><a href="#cb43-1"></a><span class="kw">const</span> id <span class="op">=</span> <span class="st">&quot;c-1234&quot;</span><span class="op">;</span></span>
<span id="cb43-2"><a href="#cb43-2"></a>prisma<span class="op">.</span><span class="at">category</span><span class="op">.</span><span class="fu">delete</span>({ where<span class="op">:</span> { id<span class="op">:</span> id } })<span class="op">;</span></span></code></pre></div>
      <p>TypeScript (JavaScript)
      では、オブジェクトの「<strong>プロパティ名</strong>」と「<strong>値の変数名</strong>」が同じ場合、省略記法を使うことができます。つまり、<code>id: id</code>
      を、単に <code>id</code> と書くことができます
      (省表記が利用できます)。これを適用すれば、先のコードは、次のように記述することができます。</p>
      <div class="sourceCode" id="cb44" data-caption="deleteメソッドの引数の指定の説明3"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb44-1"><a href="#cb44-1"></a><span class="kw">const</span> id <span class="op">=</span> <span class="st">&quot;c-1234&quot;</span><span class="op">;</span></span>
<span id="cb44-2"><a href="#cb44-2"></a>prisma<span class="op">.</span><span class="at">category</span><span class="op">.</span><span class="fu">delete</span>({ where<span class="op">:</span> { id } })<span class="op">;</span></span></code></pre></div>
      <p>慣れるまでは非常に分かりづらいと思いますが、実務では頻繁に利用される記法なので覚えておいてください。<strong>第14行目</strong>
      は、この略表記を使って記述されています。</p>
      </div>
      <p>なお、<code>delete</code>
      メソッドは削除に成功したとき、当該のレコードを戻り値とします。<strong>第15行目</strong>
      では、その戻り値を利用して、<code>「カテゴリ5」を削除しました。</code> のような HTTP
      レスポンスを返すようにしています。</p>
      <hr />
      <p>ファイルの編集が完了したら開発モードでアプリを起動して、<strong>Thunder Client</strong>
      からテストを実行してください。HTTP Method
      を「<strong>DELETE</strong>」に切り替え、ボディは削除してください
      (ボディを残していても支障はありません)。</p>
      <p>エンドポイントの <code>[id]</code> の部分 (＝削除したいカテゴリのID) については、Prisma
      Studio から調べて設定してください。</p>
      <figure>
      <img src="figs/08/vscode_11.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <p>存在しない <code>id</code>
      をエンドポイントに指定した場合、どのようなレスポンスとなるか確認しておいてください。</p>
      <h2 data-number="4.8" id="カテゴリを編集するウェブapiの実装"><span
      class="header-section-number">4.8</span> カテゴリを編集するウェブAPIの実装</h2>
      <p>カテゴリの <strong>名前を変更 (更新) するためのウェブAPI</strong>
      を実装します。具体的には、次のようなエンドポイントに対して、新しい名前の情報を持ったボディを「<strong>PUTリクエスト</strong>」で送信することで、これを実現します。</p>
      <ul>
      <li><code>/api/admin/categories/24f932b8-...-569f07ba16a7</code></li>
      </ul>
      <p>既に気づいたかもしれませんが、このエンドポイントは <span
      class="masked">DELETEメソッドと共通</span> になります。<code>route.ts</code>
      には複数のメソッドを含めることが可能なので <code>api/admin/categories/[id]/route.ts</code>
      を次のように編集してください。</p>
      <div class="sourceCode" id="cb45"
      data-caption="api/admin/categories/[id]/route.ts (PUT関数の追加)"><pre
      class="sourceCode numberSource ts numberLines"><code class="sourceCode typescript"><span id="cb45-1"><a href="#cb45-1"></a><span class="im">import</span> prisma <span class="im">from</span> <span class="st">&quot;@/lib/prisma&quot;</span><span class="op">;</span></span>
<span id="cb45-2"><a href="#cb45-2"></a><span class="im">import</span> { NextResponse<span class="op">,</span> NextRequest } <span class="im">from</span> <span class="st">&quot;next/server&quot;</span><span class="op">;</span></span>
<span id="cb45-3"><a href="#cb45-3"></a><span class="im">import</span> { Category } <span class="im">from</span> <span class="st">&quot;@prisma/client&quot;</span><span class="op">;</span></span>
<span id="cb45-4"><a href="#cb45-4"></a></span>
<span id="cb45-5"><a href="#cb45-5"></a><span class="kw">type</span> RouteParams <span class="op">=</span> {</span>
<span id="cb45-6"><a href="#cb45-6"></a>  params<span class="op">:</span> {</span>
<span id="cb45-7"><a href="#cb45-7"></a>    id<span class="op">:</span> <span class="dt">string</span><span class="op">;</span></span>
<span id="cb45-8"><a href="#cb45-8"></a>  }<span class="op">;</span></span>
<span id="cb45-9"><a href="#cb45-9"></a>}<span class="op">;</span></span>
<span id="cb45-10"><a href="#cb45-10"></a></span>
<span id="cb45-11"><a href="#cb45-11"></a><span class="co">// ▼▼▼ 追加: ここから ▼▼▼</span></span>
<span id="cb45-12"><a href="#cb45-12"></a><span class="kw">type</span> RequestBody <span class="op">=</span> {</span>
<span id="cb45-13"><a href="#cb45-13"></a>  name<span class="op">:</span> <span class="dt">string</span><span class="op">;</span></span>
<span id="cb45-14"><a href="#cb45-14"></a>}<span class="op">;</span></span>
<span id="cb45-15"><a href="#cb45-15"></a></span>
<span id="cb45-16"><a href="#cb45-16"></a><span class="im">export</span> <span class="kw">const</span> PUT <span class="op">=</span> <span class="kw">async</span> (req<span class="op">:</span> NextRequest<span class="op">,</span> routeParams<span class="op">:</span> RouteParams) <span class="kw">=&gt;</span> {</span>
<span id="cb45-17"><a href="#cb45-17"></a>  <span class="cf">try</span> {</span>
<span id="cb45-18"><a href="#cb45-18"></a>    <span class="kw">const</span> id <span class="op">=</span> routeParams<span class="op">.</span><span class="at">params</span><span class="op">.</span><span class="at">id</span><span class="op">;</span></span>
<span id="cb45-19"><a href="#cb45-19"></a>    <span class="kw">const</span> { name }<span class="op">:</span> RequestBody <span class="op">=</span> <span class="cf">await</span> req<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb45-20"><a href="#cb45-20"></a>    <span class="kw">const</span> category<span class="op">:</span> Category <span class="op">=</span> <span class="cf">await</span> prisma<span class="op">.</span><span class="at">category</span><span class="op">.</span><span class="fu">update</span>({</span>
<span id="cb45-21"><a href="#cb45-21"></a>      where<span class="op">:</span> { id }<span class="op">,</span></span>
<span id="cb45-22"><a href="#cb45-22"></a>      data<span class="op">:</span> { name }<span class="op">,</span></span>
<span id="cb45-23"><a href="#cb45-23"></a>    })<span class="op">;</span></span>
<span id="cb45-24"><a href="#cb45-24"></a>    <span class="cf">return</span> NextResponse<span class="op">.</span><span class="fu">json</span>(category)<span class="op">;</span></span>
<span id="cb45-25"><a href="#cb45-25"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb45-26"><a href="#cb45-26"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(error)<span class="op">;</span></span>
<span id="cb45-27"><a href="#cb45-27"></a>    <span class="cf">return</span> NextResponse<span class="op">.</span><span class="fu">json</span>(</span>
<span id="cb45-28"><a href="#cb45-28"></a>      { error<span class="op">:</span> <span class="st">&quot;カテゴリの名前変更に失敗しました&quot;</span> }<span class="op">,</span></span>
<span id="cb45-29"><a href="#cb45-29"></a>      { status<span class="op">:</span> <span class="dv">500</span> }</span>
<span id="cb45-30"><a href="#cb45-30"></a>    )<span class="op">;</span></span>
<span id="cb45-31"><a href="#cb45-31"></a>  }</span>
<span id="cb45-32"><a href="#cb45-32"></a>}<span class="op">;</span></span>
<span id="cb45-33"><a href="#cb45-33"></a><span class="co">// ▲▲▲ 追加: ここまで ▲▲▲</span></span>
<span id="cb45-34"><a href="#cb45-34"></a></span>
<span id="cb45-35"><a href="#cb45-35"></a><span class="im">export</span> <span class="kw">const</span> DELETE <span class="op">=</span> <span class="kw">async</span> (req<span class="op">:</span> NextRequest<span class="op">,</span> routeParams<span class="op">:</span> RouteParams) <span class="kw">=&gt;</span> {</span>
<span id="cb45-36"><a href="#cb45-36"></a>  <span class="cf">try</span> {</span>
<span id="cb45-37"><a href="#cb45-37"></a>    <span class="kw">const</span> id <span class="op">=</span> routeParams<span class="op">.</span><span class="at">params</span><span class="op">.</span><span class="at">id</span><span class="op">;</span></span>
<span id="cb45-38"><a href="#cb45-38"></a>    <span class="kw">const</span> category<span class="op">:</span> Category <span class="op">=</span> <span class="cf">await</span> prisma<span class="op">.</span><span class="at">category</span><span class="op">.</span><span class="fu">delete</span>({ where<span class="op">:</span> { id } })<span class="op">;</span></span>
<span id="cb45-39"><a href="#cb45-39"></a>    <span class="cf">return</span> NextResponse<span class="op">.</span><span class="fu">json</span>({ msg<span class="op">:</span> <span class="vs">`「</span><span class="sc">${</span>category<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">」を削除しました。`</span> })<span class="op">;</span></span>
<span id="cb45-40"><a href="#cb45-40"></a>  } <span class="cf">catch</span> (error) {</span>
<span id="cb45-41"><a href="#cb45-41"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(error)<span class="op">;</span></span>
<span id="cb45-42"><a href="#cb45-42"></a>    <span class="cf">return</span> NextResponse<span class="op">.</span><span class="fu">json</span>(</span>
<span id="cb45-43"><a href="#cb45-43"></a>      { error<span class="op">:</span> <span class="st">&quot;カテゴリの削除に失敗しました&quot;</span> }<span class="op">,</span></span>
<span id="cb45-44"><a href="#cb45-44"></a>      { status<span class="op">:</span> <span class="dv">500</span> }</span>
<span id="cb45-45"><a href="#cb45-45"></a>    )<span class="op">;</span></span>
<span id="cb45-46"><a href="#cb45-46"></a>  }</span>
<span id="cb45-47"><a href="#cb45-47"></a>}<span class="op">;</span></span></code></pre></div>
      <p><strong>第20行目</strong> の <code>update</code> メソッドでは、引数に与えるオブジェクトの
      <code>where</code>
      プロパティで「<strong>更新対象のレコードを指定</strong>」し、<code>data</code>
      プロパティで「<strong>更新する値 (上書きする値)</strong>」を指定しています。</p>
      <p>ここでも、先と同じく <code>{id: id}</code> を <code>{ id }</code>
      のように略表記するテクニック、<code>{ name: name }</code> を <code>{ name }</code>
      のように略表記するテクニックが使用されています。</p>
      <p>ファイルの編集が完了したら開発モードでアプリを起動して、<strong>Thunder Client</strong>
      でテストしてください。</p>
      <figure>
      <img src="figs/08/vscode_12.png" alt="img" />
      <figcaption aria-hidden="true">img</figcaption>
      </figure>
      <!-- ---------------------------------------- -->
    </main>

    <footer class="markdown-body">
      <p><a href="https://takeshiwada1980.github.io/Programming3-2024/">講義資料のIndexに移動</a></p>
    </footer>

    <script>
      window.onload = function () {
        // ナビゲーション関連
        let openBtn = document.getElementsByClassName("openbtn")[0];
        let navPnl = document.getElementById("g-nav");
        openBtn.onclick = () => {
          openBtn.classList.toggle("active");
          navPnl.classList.toggle("panelactive");
        };

        let items = navPnl.getElementsByTagName("a");
        Array.from(items).forEach((item) => {
          item.onclick = () => {
            openBtn.classList.toggle("active");
            navPnl.classList.toggle("panelactive");
          };
        });

        // マスク処理
        let maskedSpans = document.getElementsByClassName("masked");
        Array.from(maskedSpans).forEach((span) => {
          span.onclick = () => {
            span.classList.toggle("open");
          };
        });

        // data-startfrom 属性の行番号カウンタのリセット
        document.querySelectorAll("div.sourceCode").forEach(function (div) {
          var startFrom = div.getAttribute("data-startfrom");
          if (startFrom != null) {
            div.style.counterReset = "pg-line " + (startFrom - 1);
          }
        });

        // 画像にリンクを付与
        // let images = document.querySelectorAll("figure img");
        // Array.from(images).forEach((img) => {
        //   img.onclick = () => {
        //     location.href = img.getAttribute("src");
        //   };
        // });
      };
    </script>
  </body>
</html>
